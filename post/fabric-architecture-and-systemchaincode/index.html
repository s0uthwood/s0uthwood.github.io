<!DOCTYPE html>
<html lang="en-us">
    <head><meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1'><meta name='description' content='Fabric 架构和系统链码部分'><title>Fabric-Architecture-and-SystemChaincode</title>

<link rel='canonical' href='/post/fabric-architecture-and-systemchaincode/'>

<link rel="stylesheet" href="/scss/style.min.css"><meta property='og:title' content='Fabric-Architecture-and-SystemChaincode'>
<meta property='og:description' content='Fabric 架构和系统链码部分'>
<meta property='og:url' content='/post/fabric-architecture-and-systemchaincode/'>
<meta property='og:site_name' content='s0uthwood&#39;s Blog'>
<meta property='og:type' content='article'><meta property='article:section' content='Post' /><meta property='article:tag' content='fabric' /><meta property='article:tag' content='go' /><meta property='article:published_time' content='2020-12-08T01:33:07&#43;00:00'/><meta property='article:modified_time' content='2020-12-18T13:40:28&#43;00:00'/>
<meta name="twitter:title" content="Fabric-Architecture-and-SystemChaincode">
<meta name="twitter:description" content="Fabric 架构和系统链码部分">
    </head>
    <body class="
    article-page has-toc
">
    <script>
        (function() {
            const colorSchemeKey = 'StackColorScheme';
            if(!localStorage.getItem(colorSchemeKey)){
                localStorage.setItem(colorSchemeKey, "auto");
            }
        })();
    </script><script>
    (function() {
        const colorSchemeKey = 'StackColorScheme';
        const colorSchemeItem = localStorage.getItem(colorSchemeKey);
        const supportDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches === true;

        if (colorSchemeItem == 'dark' || colorSchemeItem === 'auto' && supportDarkMode) {
            

            document.documentElement.dataset.scheme = 'dark';
        } else {
            document.documentElement.dataset.scheme = 'light';
        }
    })();
</script>
<div class="container main-container flex 
    
        extended
    
">
    
        <div id="article-toolbar">
            <a href="/" class="back-home">
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-chevron-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <polyline points="15 6 9 12 15 18" />
</svg>



                <span>Back</span>
            </a>
        </div>
    
<main class="main full-width">
    <article class="main-article">
    <header class="article-header">

    <div class="article-details">
    
    <header class="article-category">
        
            <a href="/categories/fabric/" >
                fabric
            </a>
        
    </header>
    

    <h2 class="article-title">
        <a href="/post/fabric-architecture-and-systemchaincode/">Fabric-Architecture-and-SystemChaincode</a>
    </h2>

    
    <h3 class="article-subtitle">
        Fabric 架构和系统链码部分
    </h3>
    

    
    <footer class="article-time">
        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M11.795 21h-6.795a2 2 0 0 1 -2 -2v-12a2 2 0 0 1 2 -2h12a2 2 0 0 1 2 2v4" />
  <circle cx="18" cy="18" r="4" />
  <path d="M15 3v4" />
  <path d="M7 3v4" />
  <path d="M3 11h16" />
  <path d="M18 16.496v1.504l1 1" />
</svg>
                <time class="article-time--published">Dec 08, 2020</time>
            </div>
        

        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-pencil" width="44" height="44" viewBox="0 0 24 24" stroke-width="1.5" stroke="#9e9e9e" fill="none" stroke-linecap="round" stroke-linejoin="round">
    <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
    <path d="M4 20h4L18.5 9.5a1.5 1.5.0 00-4-4L4 16v4"></path>
    <line x1="13.5" y1="6.5" x2="17.5" y2="10.5"></line>
</svg>
                <time class="article-words">
                    5335 words
                </time>
            </div>
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <polyline points="12 7 12 12 15 15" />
</svg>



                <time class="article-time--reading">
                    26 minute read
                </time>
            </div>
        
    </footer>
    
</div>
</header>

    <section class="article-content">
    <p>参考文献：<a class="link" href="1801.10228.pdf" >Hyperledger Fabric: A Distributed Operation System for Permissioned Blockchains</a></p>
<h2 id="架构">架构</h2>
<h3 id="整体结构">整体结构</h3>
<p>Fabric是一个许可区块链的分布式操作系统，可以执行多种编程语言编写的分布式应用。它能够在一个只能追加的数据结构中安全地跟踪执行历史，并且没有内置的加密账本。</p>
<p>Fabric使用了“执行-order-验证”的区块链架构，而没有遵顼标准的“order-执行”设计。其整体的分布式应用可以分为两个部分</p>
<ul>
<li>
<p>智能合约，称为链码 (<em>Chaincode</em>) ，是一段实现了应用逻辑的程序代码，并在执行过程中运行。链码是Fabric分布式应用的核心部分，可能会被未受信任的开发者修改。有一种特殊的链码被用于管理区块链系统并维护参数，被称为系统链码 (<em>system chaincode</em>)</p>
</li>
<li>
<p>背书政策 (<em>endorsement policy</em>) 在验证阶段进行评价。许可政策无法被未受信任的开发者选择或修改。其在区块链中充当一个用于事物验证的静态库，且只能通过链码进行参数化。只有指定的管理员有权限使用系统管理功能修改。</p>
</li>
</ul>
<p>“执行-排序-验证”结构示意图：</p>
<p><figure 
	
		class="gallery-image" 
		style="
			flex-grow: 302; 
			flex-basis: 726px"
	>
	<a href="/post/fabric-architecture-and-systemchaincode/execute-order-validate.png" data-size="521x172">
		<img src="/post/fabric-architecture-and-systemchaincode/execute-order-validate.png"
			width="521"
			height="172"
			srcset="/post/fabric-architecture-and-systemchaincode/execute-order-validate_hua21294e0010315c77e929f3912be8b3a_23641_480x0_resize_box_3.png 480w, /post/fabric-architecture-and-systemchaincode/execute-order-validate_hua21294e0010315c77e929f3912be8b3a_23641_1024x0_resize_box_3.png 1024w"
			loading="lazy"
			>
	</a>
	
</figure></p>
<p>一个客户端向背书政策指定的peer节点(peers)发送交易。这个交易被特殊的peer节点执行并且记录输出信息，这一步骤被称为背书。执行完成后，交易进入了排序(ordering)阶段，在这一个阶段中，使用了一种可插入的共识协议来产生一个完成排序的已背书交易的序列，并按区块分组。这些交易被广播到所有的节点。这个序列的顺序由输出和状态的依赖性决定。在验证阶段，每个peer节点都需要根据背书政策和执行的一致性对已背书交易的状态变化进行验证。所有peer节点都已相同的顺序进行验证，因此结果具有确定性。</p>
<p>Fabric网络支持多个区块链链接到同一个排序服务上。每个区块链被称为一个通道(<em>Channel</em>)，可以有不同的peer节点作为其成员。这些通道可以被用来分离不同的区块链之间的状态，但每个通道的共识并不一致，并且通道中的交易顺序是相互分开的。认为所有排序都是可信的部署，可以通过通道访问控制来实现对节点的控制。</p>
<p>其中的节点可分为：客户端、peer节点（其中一部分为背书节点）、排序服务节点(OSN, <em>Ordering Service Nodes</em> or <em>orderers</em>)</p>
<h3 id="交易的三个阶段">交易的三个阶段</h3>
<p><figure 
	
		class="gallery-image" 
		style="
			flex-grow: 176; 
			flex-basis: 423px"
	>
	<a href="/post/fabric-architecture-and-systemchaincode/transaction_flow.png" data-size="654x371">
		<img src="/post/fabric-architecture-and-systemchaincode/transaction_flow.png"
			width="654"
			height="371"
			srcset="/post/fabric-architecture-and-systemchaincode/transaction_flow_hu0a9c6a7b10b3417d128489bbce7c86a7_46092_480x0_resize_box_3.png 480w, /post/fabric-architecture-and-systemchaincode/transaction_flow_hu0a9c6a7b10b3417d128489bbce7c86a7_46092_1024x0_resize_box_3.png 1024w"
			loading="lazy"
			alt="transaction_flow">
	</a>
	
	<figcaption>transaction_flow</figcaption>
	
</figure></p>
<h4 id="执行阶段">执行阶段</h4>
<p>在执行阶段，客户端签署并发送一个交易提案给一个或多个背书节点来执行（根据背书政策，每个chaincode都有特定的一组背书节点）。一个交易提案包含了提交客户端的身份（根据MSP），交易的载荷、参数、链码标识符、每个客户端只能使用一次的nonce（随机值或计数器），以及客户端标识符和nonce生成的交易标识符。</p>
<p>背书节点会对交易提案进行模拟，在指定的区块链链码上执行操作。模拟操作在背书节点的本地区块链状态中进行模拟，不与其它节点同步，也不会将模拟的结果永久化到帐本中。区块链的状态仍然由节点交易管理器(<em>Peer Transaction Manager</em>)维护。一个链码创建的状态只能限定在该链码上，不能被其他的链码直接访问。需要注意的是，链码只能维护GetState、PutState、DelState操作访问的内容（<em>可能意思是：需要使用这些接口进行访问，不能直接修改，猜测状态权限为private</em>）。给予适当的权限，链码可以调用同一个通道的链码，并访问其状态。</p>
<p>在模拟后，背书节点会产生一个<em>writeset</em>，其中包括模拟产生的状态更新，和一个<em>readset</em>，代表交易提案模拟的版本依赖（模拟时的所有密钥以及对应的版本号）。在模拟结束后，背书节点会以加密的方式签署一份“背书”消息，包括了<em>writeset</em>和<em>readset</em>（包括交易id和背书节点的一些数据），随后以响应的方式发送给客户端。客户端收集背书，直到满足链码的背书政策，开始交易。特别的，这要求政策决定的所有背书节点都返回相同的<em>writeset</em>和<em>readset</em>。然后，客户端将继续创建交易，并传递给排序阶段。</p>
<h4 id="排序阶段">排序阶段</h4>
<p>客户端收集到足够的背书后，将会把交易组装起来并发送给排序服务端。整个交易包括了载荷(<em>payload</em>)（包括参数的链码操作）、交易元数据、背书的集合。排序阶段对每个通道的所有提交建立了一个排序。排序服务端会将多个交易分成块，输出包含交易的哈希链序列，以提高广播协议的吞吐量。</p>
<ul>
<li><code>broadcast(tx)</code>：客户端调用这个函数来广播交易<code>tx</code>，包含了载荷和签名。</li>
<li><code>B</code> $\leftarrow$ <code>deliver(s)</code>：客户端调用这个函数来获取非负序列号<code>s</code>的区块<code>B</code>，$B=([tx_1,tx_2,\ldots,tx_k],h)$，$h$为<code>s-1</code>区块的哈希值。</li>
</ul>
<p>排序服务确保了一个通道中的交付区块被完全排序，确保安全。</p>
<p>然而，每一个单独的排序实现都允许在客户端请求中保证自己的活跃性与公平性。</p>
<p>由于区块链中包含了大量的节点，但仅有少部分节点实现了排序服务，因此Fabric可以配置使用内置的gossip服务，将排序服务中交付的区块分发给所有的节点。</p>
<h4 id="验证阶段">验证阶段</h4>
<p>排序服务会把区块直接分发给各个节点（或通过<em>gossip</em>）。随后，一个新的区块进入验证阶段，包含三个连续步骤：</p>
<ul>
<li>并行执行区块中所有的交易的背书政策评估。评估是验证系统链码(VSCC, <em>validation system chaincode</em>)的任务。VSCC是一个静态库，是区块链配置的一部分，负责根据链码中的背书政策验证背书。如果不满足，这个交易会被标记为无效，并被忽略。</li>
<li>对块中的所有交易进行读写冲突检查(<em>read-write conflict check</em>)（版本号比较）。对于每个交易，将会对比其中readset的版本号和节点本地存储的账本当前状态中的版本号，确保版本相同。如果版本不匹配，交易会被标记为无效，并被忽略。</li>
<li>最后进行账本的更新阶段，在这个阶段，区块被追加到本地存储的账本中，并且更新区块链的状态。将区块添加到账本时，前两步的检查结果将被持久化以掩码的形式表示区块中的交易有效。这有助于后面进行重建状态。此外，所有的状态更新都是通过将<em>writeset</em>中的键值对写入本地完成的。</li>
</ul>
<h3 id="信任与故障模型">信任与故障模型</h3>
<p>Fabric可以适应灵活的信任和故障假设。通常情况下，所有的客户端都被认为是潜在的恶意用户或是<em>Byzantine</em>。节点都被归入组织(<em>organization</em>)并且每个组织组成一个信任域(<em>trust domain</em>)。每个节点信任其组织内部的其他节点，而不信任其他组织的节点。排序服务同样认为所有的节点（或客户端）都是潜在的拜占庭。</p>
<p>Fabric网络的完整性依赖于排序服务的一致性。排序服务的信任模型取决于其实现。</p>
<p>在Fabric中，分布式应用可以定义自己的信任假设，通过背书政策来传达，并且独立于排序服务实现的共识的信任假设。</p>
<h2 id="组件">组件</h2>
<p>Fabric使用了gRPC架构实现客户端、节点和排序服务之间的通信。</p>
<blockquote>
<p>What is gRPC?</p>
<p>A high-performance, open-source universal RPC framework</p>
<p>gRPC框架具有高性能，开源，跨语言的特点，使用了RPC框架，基于HTTP/2设计。</p>
<p>RPC(<em>remote procedure call</em>，远程过程调用)框架提供了一套机制，使得应用程序之间可以进行通信，遵从server/client模型。</p>
<p>RPC将一个服务调用封装在一个本地方法中，让调用者像使用本地方法一样调用服务，对其屏蔽实现细节。具体的实现则通过调用方和服务方的协议，基于TCP连接进行数据交互达成。</p>
<p>在本地调用过程中，通常需要通过接口，调用具体实现，最终获取相应的数据。</p>
<p>而在RPC中，本地获取到接口，随后通过网络，调用远程的实现。在使用网络时，需要通过数据序列化来传输数据。</p>
<p>在gRPC中，支持多个语言的应用程序的远程调用，数据交换格式则采用了<em>Protocol Buffer</em>。</p>
<p>如下图所示，左侧为c++语言编写的客户端，其中包含了接口的具体实现。右侧为Ruby和Java客户端，其中对接口进行了调用。客户端获取接口后，将数据通过<em>Protocol Buffer</em>的序列化处理后交给服务端，服务端调用具体实现，并把数据同样以序列化的形式返回给客户端。</p>
</blockquote>
<p><figure 
	
		class="gallery-image" 
		style="
			flex-grow: 153; 
			flex-basis: 368px"
	>
	<a href="/post/fabric-architecture-and-systemchaincode/gRPC-basic.png" data-size="551x359">
		<img src="/post/fabric-architecture-and-systemchaincode/gRPC-basic.png"
			width="551"
			height="359"
			srcset="/post/fabric-architecture-and-systemchaincode/gRPC-basic_hub059a1a613bf04f533aa6587a1d95cb3_32092_480x0_resize_box_3.png 480w, /post/fabric-architecture-and-systemchaincode/gRPC-basic_hub059a1a613bf04f533aa6587a1d95cb3_32092_1024x0_resize_box_3.png 1024w"
			loading="lazy"
			alt="gRPC-basic">
	</a>
	
	<figcaption>gRPC-basic</figcaption>
	
</figure></p>
<h3 id="成员身份管理服务msp">成员身份管理服务（MSP）</h3>
<p>成员身份管理服务(MSP, <em>membership service provider</em>)维护了系统中所有节点（客户端、节点、排序服务）的身分，并负责发布节点的凭证，用于认证和授权。节点之间的所有交互都是通过已认证的消息（通常是数字签名）发生的。成员身份管理包括每个节点的组件，可以认证交易、验证交易的完整性、签署并确认背书、验证其他的区块链操作。MSP中还包括了用于密钥管理和节点注册的工具。</p>
<p>MSP是抽象的，可以有不同的实例。Fabric中，默认的MSP实现可以处理基于数字签名的PKI认证方法，并且容纳商业认证机构(CA)。Fabric提供了独立的CA——Fabric-CA。</p>
<p>Fabric允许设置区块链网络的两种模式。在离线模式下，凭证由CA生成，并分发到所有节点。peer节点和排序节点只能在离线模式下注册。对于客户端的注册，Fabric-CA提供了在线模式，向客户端发送加密凭证。MSP的配置必须要确保所有的节点都能识别相同的身份和认证认定为有效（特别是所有的peer节点）。</p>
<p>例如，当多个组织在同一个区块链网络中时，MSP需要能够允许身份的联合。每个组织向自己的成员发放身份，每个peer节点都能识别所有组织的成员。这可以通过多个MSP实例来实现。例如，在每个组织和一个MSP之间建立一个映射。</p>
<h3 id="排序服务">排序服务</h3>
<p>排序服务可管理多个通道，对每个通道，都提供如下三个服务：</p>
<ol>
<li><em>Atomic broadcast</em>，用于对交易进行排序，实现广播和分发</li>
<li>重新配置(<em>reconfiguration</em>)通道，成员通过广播一个配置更新事物(<em>configuration update transaction</em>)修改通道。</li>
<li>（可选择）访问控制(<em>access control</em>)，在这些配置中，排序服务作为可信的实体，限制交易的广播和指定peer节点和客户端的块的接收</li>
</ol>
<p>排序服务通过系统通道上的生成块进行引导。生成块携带了配置事务(<em>configuration transaction</em>)，定义了排序服务的操作。</p>
<p>当前版本的实现由OSN组成，OSN实现了描述的操作并且通过系统通道通信。实际的<em>atomic broadcast</em>函数由基于<em>ZooKeeper</em>的Kafka实例提供，这个实例提供了可以扩展的发布-订阅消息，在节点崩溃后仍具有强一致性(<em>consistency</em>)。这个实现可以运行在与OSN分离的物理节点上。OSN作为peers和Kafka实例之间的代理。</p>
<p>OSN直接将收到的新交易注入到广播中。OSN将从广播中接收到的交易转换成块。只要满足三个情况之一，块就会被断开。</p>
<ul>
<li>区块包含了交易允许的最大值</li>
<li>区块达到最大大小</li>
<li>从接收到第一个交易后超过某特定时间</li>
</ul>
<p>批处理的过程是确定的，因此在所有节点上都会产生相同的区块。考虑到从广播中接收的交易数据流，前两项情况是已经确定的。对于第三个条件，当节点读入块中的第一个交易时，会开启一个计时器。如果计时器超时后，这个区块仍然没有断开，OSN会在通道上广播一个特殊的“到时断开(<em>time-to-cut</em>)”交易，其中记录了需要断开的区块的序列号。另一方面，每个OSN在收到“到时断开”交易后，会根据其给定的序列号，立即切断新的区块。这个交易是原子性的分发给所有连接的OSN，所以区块中都包含相同的交易列表。OSN将最近交付的一系列区块直接持久化到文件系统中，因此可以通过分发回答peer节点来回收区块。</p>
<h3 id="peer-gossip">Peer Gossip</h3>
<p>将三个阶段分开的好处是在开发的时候可以独立扩展。然而，由于共识算法往往有带宽限制，排序服务的吞吐量被节点的网络容量所限制。共识无法通过增加节点而扩展，反而会让吞吐量降低。然而，由于排序和验证是分开的，在排序阶段后，重要的是如何有效地广播执行阶段的结果，以交给peer节点进行验证。此外，还有如何对新加入的peer节点和长期断开的peer节点进行状态转移。这两个问题就是gossip组件所需要解决的。Fabric gossip利用流行组播(<em>epidemic multicast</em>)来解决这个问题。区块是由排序服务签署的。这意味着一个peer节点在收到所有区块后，可以独立的组装为区块链并验证其完整性。</p>
<p>gossip的通信基于gRPC，利用TLS（传输层安全协议）进行相互识别，使得每一方都可以将TLS凭证与远程peer节点的身份绑定。gossip组件用来维护系统中当前在线的peer节点的成员视图。所有的peer节点通过定期传播成员数据独立建立一个本地视图。此外，一个peer节点可以在网络崩溃或者中断后重新连入成员视图。</p>
<p>Fabric的gossip组件采用了两个阶段进行信息的传播：</p>
<ul>
<li>在<em>push</em>阶段，每个peer节点从成员视图中选择一个随机的活跃邻居集合，并向他们发送信息</li>
<li>在<em>pull</em>阶段，每个peer节点定期探测一个随机选择的peer节点集合，并请求缺失的信息</li>
</ul>
<blockquote>
<p>研究表明，同时使用这两种方法可以优化可用带宽并确保所有peer节点有很高的概率接收到所有信息。</p>
</blockquote>
<p>为了减少从排序节点向网络中发送的区块的负载，协议同时在peer中选择了一个领导者(<em>elects a leader peer</em>)，代表peer节点从排序服务中<em>pull</em>区块，并启动gossip分发。这个机制对领导者出现故障具有弹性。</p>
<h3 id="分布式账本ledger">分布式账本(<em>Ledger</em>)</h3>
<p>账本组件在各个peer节点中维持分布式账本并建立持久性的存储，并实现账本的模拟、验证和更新阶段。整体上由一个区块存储(<em>block store</em>)和一个peer节点交易管理器(<em>peer transaction manager</em>)组成。</p>
<h4 id="区块存储ledger-block-store">区块存储(Ledger Block Store)</h4>
<p>账本区块存储持久化交易区块，并以一组仅追加文件的形式实现。由于区块无法被改变，并以一个特定的顺序到达，一个仅追加的结构能够带来最好的性能。此外，区块存储中维护了一些索引(<em>indices</em>)，用来随机访问区块或区块中的交易。</p>
<h4 id="peer交易管理器peer-transaction-manager">peer交易管理器(Peer Transaction Manager)</h4>
<p>peer节点交易管理器(PTM)保持版本键值对处于最新状态。它能为每一个唯一的条目(<em>entry</em>)的<em>key</em>以(<em>key</em>,<em>val</em>, <em>ver</em>)存储一个元组，其中包含了最近存储的值<em>val</em>，和最新的版本号<em>var</em>。版本由区块序列号和区块内的交易序列号组成，因此版本号都是唯一且递增的。PTM使用了本地键值存储来识别版本变量，具体实现使用了LevelDB和Apache CouchDB。</p>
<p>在模拟时，PTM提供了一个稳定的最新状态快照。<strong>执行阶段</strong>中提到，PTM在<em>readset</em>中为GetState访问的每个条目记录一个元组(<em>key</em>, <em>ver</em>)，在<em>writeset</em>中为交易调用PutState更新的每个条目记录一个元组(<em>key</em>, <em>val</em>)。此外，PTM支持范围查询(<em>range queries</em>)，并计算出查询结果的加密哈希（一组(<em>key</em>, <em>ver</em>)元组），并将查询字符串和哈希添加到readset中。</p>
<p>在验证阶段，PTM依次验证一个区块中的所有交易，检查交易是否与之前的任何交易产生冲突。对于readset中的所有key，如果readset中的版本记录与最新状态的版本不同，PTM就会把这个交易标记为无效。对于范围查找，PTM会重新执行查询并与之前的<em>readset</em>比较哈希值，确保不发生错误的读取。</p>
<h4 id="崩溃处理">崩溃处理</h4>
<p>账本组件在更新时需要能处理peer节点的崩溃。</p>
<p>在接收到一个新区块后，PTM已经对其进行了验证，并使用了掩码将区块中的交易标记为有效或无效。此时，账本将区块写入账本的区块存储中，刷新到磁盘，随后更新区块存储的索引。随后，PTM将所有有效交易的<em>writeset</em>状态变化应用到本地存储中。最后，计算并持久化一个<em>savepoint</em>的值，表示成功应用区块数量的最大值。从崩溃中恢复时，<em>savepoint</em>值用来从持久化块中恢复索引和最新状态。</p>
<h3 id="链码执行">链码执行</h3>
<p>Chaincode在一个与其余peer节点松散耦合的环境中执行。支持增添新的链码编程语言的插件。目前支持Go、Java和Node。</p>
<p>每个用户级或应用链码都在Docker容器环境中的独立进程中执行，这使得链码和peer节点之间相互隔离，简化了链码的生命周期管理（启动、停止、中止）。链码和peer节点通过gRCP通信。通过松散的耦合关系，peer节点不知道链码具体使用了什么语言实现。</p>
<p>不同于应用链码，系统链码直接在peer节点的进程中运行，可以实现Fabric所需要的特定功能，可以用于用户链码之间的隔离限制过多的情况。</p>
<h3 id="配置和系统链码">配置和系统链码</h3>
<p>Fabric通过通道配置(<em>channel configuration</em>)和系统链码(<em>system chaincodes</em>)进行定制。</p>
<p>Fabric中每个通道都会形成一个逻辑区块链。通道的配置由元数据进行维护，并永久保留在配置区块(<em>configuration blocks</em>)中。每个配置区块都会包含完整的通道配置，并不会包括任何其他的东西。每个区块链都以一个配置区块开始，称之为创世块(<em>genesis block</em>)，用于引导通道。通道的配置包括：</p>
<ol>
<li>参与节点的MSP定义；</li>
<li>OSN的网络地址；</li>
<li>共识实现和配许服务的共享配置，比如大小和超时等设置；</li>
<li>管理对排序服务操作（广播和分发）访问的规则；</li>
<li>管理如何修改通道配置的各个部分的规则。</li>
</ol>
<p>通道的配置可以使用通道配置更新事务(<em>channel configuration update transaction</em>)进行更新，其中需要包括对配置进行的修改和一组签名。排序节点通过使用当前的配置验证该签名是否得到授权，来评估此次更新是否有效。然后，排序节点生成一个新的配置区块，嵌入新的配置和配置更新事务。Peer节点接收后，根据当前的配置验证更新是否得到了授权，有效则进行配置更新。</p>
<p>在部署应用链码时，会<!-- raw HTML omitted -->参考<!-- raw HTML omitted -->一个认可系统链码（<em>endorsement system chaincode</em>, ESCC）和一个验证系统链码（<em>validation system chaincode</em>, VSCC）。这两个链码的选择使得ESCC输出的背书，可以作为VSCC输入的一部分进行验证。ESCC将一个提案和提案模拟的结果作为输入。如果结果符合要求，则ESCC产生一个包含结果和认可的响应。对于默认的ESCC，这个背书只是peer节点的本地签名身份的签名。VSCC将一个事务作为输入，并输出该事务是否有效。对于默认的VSCC，背书被收集，并根据为链码指定的背书策略进行评估。进一步的系统链码实现其他支持功能，如链码生命周期。</p>
<blockquote>
<p>系统链码的核心代码在/fabric/core/common/sysccprovider和/fabric/core/scc下</p>
</blockquote>
<h2 id="系统链码">系统链码</h2>
<p><figure 
	
		class="gallery-image" 
		style="
			flex-grow: 88; 
			flex-basis: 213px"
	>
	<a href="/post/fabric-architecture-and-systemchaincode/%E7%B3%BB%E7%BB%9F%E9%93%BE%E7%A0%81%E7%BB%93%E6%9E%84%E5%9B%BE.png" data-size="600x676">
		<img src="/post/fabric-architecture-and-systemchaincode/%E7%B3%BB%E7%BB%9F%E9%93%BE%E7%A0%81%E7%BB%93%E6%9E%84%E5%9B%BE.png"
			width="600"
			height="676"
			srcset="/post/fabric-architecture-and-systemchaincode/%E7%B3%BB%E7%BB%9F%E9%93%BE%E7%A0%81%E7%BB%93%E6%9E%84%E5%9B%BE_hu3df4d83e11a62b95ad644cfb9bc48850_87422_480x0_resize_box_3.png 480w, /post/fabric-architecture-and-systemchaincode/%E7%B3%BB%E7%BB%9F%E9%93%BE%E7%A0%81%E7%BB%93%E6%9E%84%E5%9B%BE_hu3df4d83e11a62b95ad644cfb9bc48850_87422_1024x0_resize_box_3.png 1024w"
			loading="lazy"
			alt="系统链码结构图">
	</a>
	
	<figcaption>系统链码结构图</figcaption>
	
</figure></p>
<p>与普通链码对比</p>
<table>
<thead>
<tr>
<th style="text-align:center"></th>
<th style="text-align:left">系统链码</th>
<th>普通链码</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">链码源码</td>
<td style="text-align:left">无main函数</td>
<td>有main函数</td>
</tr>
<tr>
<td style="text-align:center">运行空间</td>
<td style="text-align:left">背书节点进程</td>
<td>Docker</td>
</tr>
<tr>
<td style="text-align:center">调用方式</td>
<td style="text-align:left">网络+进程内部</td>
<td>网络</td>
</tr>
<tr>
<td style="text-align:center">启动参数</td>
<td style="text-align:left">内置</td>
<td>动态输入</td>
</tr>
<tr>
<td style="text-align:center">通信方式</td>
<td style="text-align:left">Golang的通道机制</td>
<td>网络</td>
</tr>
<tr>
<td style="text-align:center">数据存取</td>
<td style="text-align:left">Golang的通道+本地文件</td>
<td>网络</td>
</tr>
<tr>
<td style="text-align:center">升级方式</td>
<td style="text-align:left">和背书节点一起升级</td>
<td>单独升级</td>
</tr>
<tr>
<td style="text-align:center">背书策略</td>
<td style="text-align:left">无</td>
<td>有</td>
</tr>
</tbody>
</table>
<h3 id="系统链码在peer节点上的注册与部署">系统链码在Peer节点上的注册与部署</h3>
<p>peer节点存在于docker容器中，在启动时通过执行<code>peer node start</code>命令来启动peer节点。</p>
<blockquote>
<p>/internal/peer/node/start.go</p>
</blockquote>
<p>start命令的入口函数为serve函数。</p>
<p>以下源代码中仅保留部署系统链码的部分。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">serve</span>(<span style="color:#a6e22e">args</span> []<span style="color:#66d9ef">string</span>) <span style="color:#66d9ef">error</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Initialize chaincode service
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// deploy system chaincodes
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">cc</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> []<span style="color:#a6e22e">scc</span>.<span style="color:#a6e22e">SelfDescribingSysCC</span>{<span style="color:#a6e22e">lsccInst</span>, <span style="color:#a6e22e">csccInst</span>, <span style="color:#a6e22e">qsccInst</span>, <span style="color:#a6e22e">lifecycleSCC</span>} {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">enabled</span>, <span style="color:#a6e22e">ok</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">chaincodeConfig</span>.<span style="color:#a6e22e">SCCWhitelist</span>[<span style="color:#a6e22e">cc</span>.<span style="color:#a6e22e">Name</span>()]; !<span style="color:#a6e22e">ok</span> <span style="color:#f92672">||</span> !<span style="color:#a6e22e">enabled</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">logger</span>.<span style="color:#a6e22e">Infof</span>(<span style="color:#e6db74">&#34;not deploying chaincode %s as it is not enabled&#34;</span>, <span style="color:#a6e22e">cc</span>.<span style="color:#a6e22e">Name</span>())
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">continue</span>
</span></span><span style="display:flex;"><span>		} <span style="color:#75715e">// 判断链码的设置是否为enabled
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#a6e22e">scc</span>.<span style="color:#a6e22e">DeploySysCC</span>(<span style="color:#a6e22e">cc</span>, <span style="color:#a6e22e">chaincodeSupport</span>) <span style="color:#75715e">// 部署系统链码
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">logger</span>.<span style="color:#a6e22e">Infof</span>(<span style="color:#e6db74">&#34;Deployed system chaincodes&#34;</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">//...
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>}
</span></span></code></pre></div><p>通过遍历scc.SelfDescribingSysCC返回值，调用scc.DeploySysCC函数。</p>
<p>找到scc源文件：</p>
<blockquote>
<p>corn/scc/scc.go</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">SelfDescribingSysCC</span> <span style="color:#66d9ef">interface</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">//Unique name of the system chaincode
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">Name</span>() <span style="color:#66d9ef">string</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// Chaincode returns the underlying chaincode
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">Chaincode</span>() <span style="color:#a6e22e">shim</span>.<span style="color:#a6e22e">Chaincode</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p><code>SelfDescribingSysCC</code>的第二个方法为<code>Chaincode()</code>返回值为<code>shim.Chaincode</code>类型。在<code>core\scc\cscc\configure.go</code>中发现如下代码：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">e</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">PeerConfiger</span>) <span style="color:#a6e22e">Chaincode</span>() <span style="color:#a6e22e">shim</span>.<span style="color:#a6e22e">Chaincode</span> { <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">e</span> }
</span></span></code></pre></div><p>可知<code>start.go</code>中的<code>cc</code>为每个链码的配置</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">PeerConfiger</span> <span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">policyChecker</span>          <span style="color:#a6e22e">policy</span>.<span style="color:#a6e22e">PolicyChecker</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">configMgr</span>              <span style="color:#a6e22e">config</span>.<span style="color:#a6e22e">Manager</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">aclProvider</span>            <span style="color:#a6e22e">aclmgmt</span>.<span style="color:#a6e22e">ACLProvider</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">deployedCCInfoProvider</span> <span style="color:#a6e22e">ledger</span>.<span style="color:#a6e22e">DeployedChaincodeInfoProvider</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">legacyLifecycle</span>        <span style="color:#a6e22e">plugindispatcher</span>.<span style="color:#a6e22e">LifecycleResources</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">newLifecycle</span>           <span style="color:#a6e22e">plugindispatcher</span>.<span style="color:#a6e22e">CollectionAndLifecycleResources</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">peer</span>                   <span style="color:#f92672">*</span><span style="color:#a6e22e">peer</span>.<span style="color:#a6e22e">Peer</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">bccsp</span>                  <span style="color:#a6e22e">bccsp</span>.<span style="color:#a6e22e">BCCSP</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>下面是<code>DeploySysCC</code>的代码</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">ChaincodeStreamHandler</span> <span style="color:#66d9ef">interface</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">HandleChaincodeStream</span>(<span style="color:#a6e22e">ccintf</span>.<span style="color:#a6e22e">ChaincodeStream</span>) <span style="color:#66d9ef">error</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">LaunchInProc</span>(<span style="color:#a6e22e">packageID</span> <span style="color:#66d9ef">string</span>) <span style="color:#f92672">&lt;-</span><span style="color:#66d9ef">chan</span> <span style="color:#66d9ef">struct</span>{}
</span></span><span style="display:flex;"><span>} <span style="color:#75715e">// 负责peer节点与链码之间的通信
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">DeploySysCC</span>(<span style="color:#a6e22e">sysCC</span> <span style="color:#a6e22e">SelfDescribingSysCC</span>, <span style="color:#a6e22e">chaincodeStreamHandler</span> <span style="color:#a6e22e">ChaincodeStreamHandler</span>) {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">sysccLogger</span>.<span style="color:#a6e22e">Infof</span>(<span style="color:#e6db74">&#34;deploying system chaincode &#39;%s&#39;&#34;</span>, <span style="color:#a6e22e">sysCC</span>.<span style="color:#a6e22e">Name</span>())
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">ccid</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">ChaincodeID</span>(<span style="color:#a6e22e">sysCC</span>.<span style="color:#a6e22e">Name</span>())
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">done</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">chaincodeStreamHandler</span>.<span style="color:#a6e22e">LaunchInProc</span>(<span style="color:#a6e22e">ccid</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">peerRcvCCSend</span> <span style="color:#f92672">:=</span> make(<span style="color:#66d9ef">chan</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">pb</span>.<span style="color:#a6e22e">ChaincodeMessage</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">ccRcvPeerSend</span> <span style="color:#f92672">:=</span> make(<span style="color:#66d9ef">chan</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">pb</span>.<span style="color:#a6e22e">ChaincodeMessage</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 并行传输数据
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">go</span> <span style="color:#66d9ef">func</span>() {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">stream</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">newInProcStream</span>(<span style="color:#a6e22e">peerRcvCCSend</span>, <span style="color:#a6e22e">ccRcvPeerSend</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">stream</span>.<span style="color:#a6e22e">CloseSend</span>()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">sysccLogger</span>.<span style="color:#a6e22e">Debugf</span>(<span style="color:#e6db74">&#34;starting chaincode-support stream for  %s&#34;</span>, <span style="color:#a6e22e">ccid</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">chaincodeStreamHandler</span>.<span style="color:#a6e22e">HandleChaincodeStream</span>(<span style="color:#a6e22e">stream</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">sysccLogger</span>.<span style="color:#a6e22e">Criticalf</span>(<span style="color:#e6db74">&#34;shim stream ended with err: %v&#34;</span>, <span style="color:#a6e22e">err</span>)
</span></span><span style="display:flex;"><span>	}()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">go</span> <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">sysCC</span> <span style="color:#a6e22e">SelfDescribingSysCC</span>) {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">stream</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">newInProcStream</span>(<span style="color:#a6e22e">ccRcvPeerSend</span>, <span style="color:#a6e22e">peerRcvCCSend</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">stream</span>.<span style="color:#a6e22e">CloseSend</span>()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">sysccLogger</span>.<span style="color:#a6e22e">Debugf</span>(<span style="color:#e6db74">&#34;chaincode started for %s&#34;</span>, <span style="color:#a6e22e">ccid</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">shim</span>.<span style="color:#a6e22e">StartInProc</span>(<span style="color:#a6e22e">ccid</span>, <span style="color:#a6e22e">stream</span>, <span style="color:#a6e22e">sysCC</span>.<span style="color:#a6e22e">Chaincode</span>())
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">sysccLogger</span>.<span style="color:#a6e22e">Criticalf</span>(<span style="color:#e6db74">&#34;system chaincode ended with err: %v&#34;</span>, <span style="color:#a6e22e">err</span>)
</span></span><span style="display:flex;"><span>	}(<span style="color:#a6e22e">sysCC</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">&lt;-</span><span style="color:#a6e22e">done</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>因此，在serve.go代码中，对lscc,qscc,cscc三个系统链码进行相应的初始创建，随后根据配置信息部署到peer节点中。</p>
<h3 id="查询系统链码-querier-system-chaincode-qscc">查询系统链码 (<em>Querier System Chaincode</em>, QSCC)</h3>
<h4 id="源代码">源代码</h4>
<blockquote>
<p>/core/scc/qscc/query.go</p>
</blockquote>
<p>在所有Peer节点上运行，提供账本查询接口，包括了区块查询、交易查询等。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#a6e22e">qscc</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> (
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;fmt&#34;</span>                       <span style="color:#75715e">// 格式化IO
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#e6db74">&#34;strconv&#34;</span>                   <span style="color:#75715e">// 数据类型转换
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;github.com/hyperledger/fabric-chaincode-go/shim&#34;</span> <span style="color:#75715e">// shim包提供API访问链码chaincode的状态变量，chaincode用来和peer沟通的接口
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">pb</span> <span style="color:#e6db74">&#34;github.com/hyperledger/fabric-protos-go/peer&#34;</span> <span style="color:#75715e">// 调用.pb.go文件，由proto文件生成
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#e6db74">&#34;github.com/hyperledger/fabric/common/flogging&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;github.com/hyperledger/fabric/core/aclmgmt&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;github.com/hyperledger/fabric/core/ledger&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;github.com/hyperledger/fabric/protoutil&#34;</span>         <span style="color:#75715e">// Proto Buffer的通用方法
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// LedgerGetter gets the PeerLedger associated with a channel.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">LedgerGetter</span> <span style="color:#66d9ef">interface</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">GetLedger</span>(<span style="color:#a6e22e">cid</span> <span style="color:#66d9ef">string</span>) <span style="color:#a6e22e">ledger</span>.<span style="color:#a6e22e">PeerLedger</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// New returns an instance of QSCC.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// Typically this is called once per peer.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">New</span>(<span style="color:#a6e22e">aclProvider</span> <span style="color:#a6e22e">aclmgmt</span>.<span style="color:#a6e22e">ACLProvider</span>, <span style="color:#a6e22e">ledgers</span> <span style="color:#a6e22e">LedgerGetter</span>) <span style="color:#f92672">*</span><span style="color:#a6e22e">LedgerQuerier</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">LedgerQuerier</span>{
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">aclProvider</span>: <span style="color:#a6e22e">aclProvider</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">ledgers</span>:     <span style="color:#a6e22e">ledgers</span>,
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// (e *LedgerQuerier) 表示这是LedgerQuerier结构体的方法
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">e</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">LedgerQuerier</span>) <span style="color:#a6e22e">Name</span>() <span style="color:#66d9ef">string</span>              { <span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#34;qscc&#34;</span> }
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">e</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">LedgerQuerier</span>) <span style="color:#a6e22e">Chaincode</span>() <span style="color:#a6e22e">shim</span>.<span style="color:#a6e22e">Chaincode</span> { <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">e</span> }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// LedgerQuerier implements the ledger query functions, including:
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// - GetChainInfo returns BlockchainInfo
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// - GetBlockByNumber returns a block
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// - GetBlockByHash returns a block
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// - GetTransactionByID returns a transaction
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">LedgerQuerier</span> <span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">aclProvider</span> <span style="color:#a6e22e">aclmgmt</span>.<span style="color:#a6e22e">ACLProvider</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">ledgers</span>     <span style="color:#a6e22e">LedgerGetter</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">qscclogger</span> = <span style="color:#a6e22e">flogging</span>.<span style="color:#a6e22e">MustGetLogger</span>(<span style="color:#e6db74">&#34;qscc&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 将函数名定义为字符串常量，用于invoke的第一个arg参数
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">const</span> (
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">GetChainInfo</span>       <span style="color:#66d9ef">string</span> = <span style="color:#e6db74">&#34;GetChainInfo&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">GetBlockByNumber</span>   <span style="color:#66d9ef">string</span> = <span style="color:#e6db74">&#34;GetBlockByNumber&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">GetBlockByHash</span>     <span style="color:#66d9ef">string</span> = <span style="color:#e6db74">&#34;GetBlockByHash&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">GetTransactionByID</span> <span style="color:#66d9ef">string</span> = <span style="color:#e6db74">&#34;GetTransactionByID&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">GetBlockByTxID</span>     <span style="color:#66d9ef">string</span> = <span style="color:#e6db74">&#34;GetBlockByTxID&#34;</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Init is called once per chain when the chain is created.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// This allows the chaincode to initialize any variables on the ledger prior
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// to any transaction execution on the chain.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">e</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">LedgerQuerier</span>) <span style="color:#a6e22e">Init</span>(<span style="color:#a6e22e">stub</span> <span style="color:#a6e22e">shim</span>.<span style="color:#a6e22e">ChaincodeStubInterface</span>) <span style="color:#a6e22e">pb</span>.<span style="color:#a6e22e">Response</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">qscclogger</span>.<span style="color:#a6e22e">Info</span>(<span style="color:#e6db74">&#34;Init QSCC&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">shim</span>.<span style="color:#a6e22e">Success</span>(<span style="color:#66d9ef">nil</span>)
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 调用Invoke时，args[0]为查询函数名，args[1]为chain id，在加到stub包之前为暂时的id
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// 每个函数都需要额外的参数，如下:
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// # GetChainInfo: 返回一个以字节为单位的BlockchainInfo对象
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// # GetBlockByNumber: 返回args[2]中所指定的块
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// # GetBlockByHash: 返回args[2]中的块哈希值所指定的块
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// # GetTransactionByID: 返回args[2]中的id所指定的交易事务
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">e</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">LedgerQuerier</span>) <span style="color:#a6e22e">Invoke</span>(<span style="color:#a6e22e">stub</span> <span style="color:#a6e22e">shim</span>.<span style="color:#a6e22e">ChaincodeStubInterface</span>) <span style="color:#a6e22e">pb</span>.<span style="color:#a6e22e">Response</span> { <span style="color:#75715e">// 通过args调用内部函数
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">args</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">stub</span>.<span style="color:#a6e22e">GetArgs</span>() <span style="color:#75715e">// stub是RPC中客户端与服务器端传输的消息包，将其解包并获取args
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// args数量小于2时，返回错误信息
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">// 第一个args为调用的函数名，第二个args为chain ID
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">fname</span> <span style="color:#f92672">:=</span> string(<span style="color:#a6e22e">args</span>[<span style="color:#ae81ff">0</span>])
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">cid</span> <span style="color:#f92672">:=</span> string(<span style="color:#a6e22e">args</span>[<span style="color:#ae81ff">1</span>])
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">sp</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">stub</span>.<span style="color:#a6e22e">GetSignedProposal</span>() <span style="color:#75715e">// 获取签名交易提议的解码对象，类型为SignedProposal
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">name</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">protoutil</span>.<span style="color:#a6e22e">InvokedChaincodeName</span>(<span style="color:#a6e22e">sp</span>.<span style="color:#a6e22e">ProposalBytes</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">targetLedger</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">ledgers</span>.<span style="color:#a6e22e">GetLedger</span>(<span style="color:#a6e22e">cid</span>)
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">qscclogger</span>.<span style="color:#a6e22e">Debugf</span>(<span style="color:#e6db74">&#34;Invoke function: %s on chain: %s&#34;</span>, <span style="color:#a6e22e">fname</span>, <span style="color:#a6e22e">cid</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// Handle ACL: （ACL：访问控制权限）
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">res</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">getACLResource</span>(<span style="color:#a6e22e">fname</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">aclProvider</span>.<span style="color:#a6e22e">CheckACL</span>(<span style="color:#a6e22e">res</span>, <span style="color:#a6e22e">cid</span>, <span style="color:#a6e22e">sp</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">shim</span>.<span style="color:#a6e22e">Error</span>(<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Sprintf</span>(<span style="color:#e6db74">&#34;access denied for [%s][%s]: [%s]&#34;</span>, <span style="color:#a6e22e">fname</span>, <span style="color:#a6e22e">cid</span>, <span style="color:#a6e22e">err</span>))
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 调用相应的函数并传递参数
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">switch</span> <span style="color:#a6e22e">fname</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">case</span> <span style="color:#a6e22e">GetTransactionByID</span>:
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">getTransactionByID</span>(<span style="color:#a6e22e">targetLedger</span>, <span style="color:#a6e22e">args</span>[<span style="color:#ae81ff">2</span>])
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">case</span> <span style="color:#a6e22e">GetBlockByNumber</span>:
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">getBlockByNumber</span>(<span style="color:#a6e22e">targetLedger</span>, <span style="color:#a6e22e">args</span>[<span style="color:#ae81ff">2</span>])
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">case</span> <span style="color:#a6e22e">GetBlockByHash</span>:
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">getBlockByHash</span>(<span style="color:#a6e22e">targetLedger</span>, <span style="color:#a6e22e">args</span>[<span style="color:#ae81ff">2</span>])
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">case</span> <span style="color:#a6e22e">GetChainInfo</span>:
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">getChainInfo</span>(<span style="color:#a6e22e">targetLedger</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">case</span> <span style="color:#a6e22e">GetBlockByTxID</span>:
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">getBlockByTxID</span>(<span style="color:#a6e22e">targetLedger</span>, <span style="color:#a6e22e">args</span>[<span style="color:#ae81ff">2</span>])
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">shim</span>.<span style="color:#a6e22e">Error</span>(<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Sprintf</span>(<span style="color:#e6db74">&#34;Requested function %s not found.&#34;</span>, <span style="color:#a6e22e">fname</span>))
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 以下为五个private方法，只能通过invoke进行调用。
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// 五个方法在进行异常处理后，调用账本中对应的方法，并将成功或错误结果通过shim发送
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// - getTransactionByID: 返回对应id的交易内容
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">getTransactionByID</span>(<span style="color:#a6e22e">vledger</span> <span style="color:#a6e22e">ledger</span>.<span style="color:#a6e22e">PeerLedger</span>, <span style="color:#a6e22e">tid</span> []<span style="color:#66d9ef">byte</span>) <span style="color:#a6e22e">pb</span>.<span style="color:#a6e22e">Response</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 异常：交易为空
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">processedTran</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">vledger</span>.<span style="color:#a6e22e">GetTransactionByID</span>(string(<span style="color:#a6e22e">tid</span>)) <span style="color:#75715e">// 调用ledger.PeerLedger中的方法
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">bytes</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">protoutil</span>.<span style="color:#a6e22e">Marshal</span>(<span style="color:#a6e22e">processedTran</span>) <span style="color:#75715e">// 使用proto工具进行编排 my_TODO: read protoutil
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">shim</span>.<span style="color:#a6e22e">Success</span>(<span style="color:#a6e22e">bytes</span>)
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">//以下四个方法的整体结果与第一个相似
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">getBlockByNumber</span>(<span style="color:#a6e22e">vledger</span> <span style="color:#a6e22e">ledger</span>.<span style="color:#a6e22e">PeerLedger</span>, <span style="color:#a6e22e">number</span> []<span style="color:#66d9ef">byte</span>) <span style="color:#a6e22e">pb</span>.<span style="color:#a6e22e">Response</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">bnum</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">strconv</span>.<span style="color:#a6e22e">ParseUint</span>(string(<span style="color:#a6e22e">number</span>), <span style="color:#ae81ff">10</span>, <span style="color:#ae81ff">64</span>) <span style="color:#75715e">// 转换成uint型
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">block</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">vledger</span>.<span style="color:#a6e22e">GetBlockByNumber</span>(<span style="color:#a6e22e">bnum</span>) <span style="color:#75715e">// 调用账本中的方法
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">bytes</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">protoutil</span>.<span style="color:#a6e22e">Marshal</span>(<span style="color:#a6e22e">block</span>) 
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">shim</span>.<span style="color:#a6e22e">Success</span>(<span style="color:#a6e22e">bytes</span>)
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">getBlockByHash</span>(<span style="color:#a6e22e">vledger</span> <span style="color:#a6e22e">ledger</span>.<span style="color:#a6e22e">PeerLedger</span>, <span style="color:#a6e22e">hash</span> []<span style="color:#66d9ef">byte</span>) <span style="color:#a6e22e">pb</span>.<span style="color:#a6e22e">Response</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">block</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">vledger</span>.<span style="color:#a6e22e">GetBlockByHash</span>(<span style="color:#a6e22e">hash</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">bytes</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">protoutil</span>.<span style="color:#a6e22e">Marshal</span>(<span style="color:#a6e22e">block</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">shim</span>.<span style="color:#a6e22e">Success</span>(<span style="color:#a6e22e">bytes</span>)
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">getChainInfo</span>(<span style="color:#a6e22e">vledger</span> <span style="color:#a6e22e">ledger</span>.<span style="color:#a6e22e">PeerLedger</span>) <span style="color:#a6e22e">pb</span>.<span style="color:#a6e22e">Response</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">binfo</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">vledger</span>.<span style="color:#a6e22e">GetBlockchainInfo</span>()
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">bytes</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">protoutil</span>.<span style="color:#a6e22e">Marshal</span>(<span style="color:#a6e22e">binfo</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">shim</span>.<span style="color:#a6e22e">Success</span>(<span style="color:#a6e22e">bytes</span>)
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">getBlockByTxID</span>(<span style="color:#a6e22e">vledger</span> <span style="color:#a6e22e">ledger</span>.<span style="color:#a6e22e">PeerLedger</span>, <span style="color:#a6e22e">rawTxID</span> []<span style="color:#66d9ef">byte</span>) <span style="color:#a6e22e">pb</span>.<span style="color:#a6e22e">Response</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">txID</span> <span style="color:#f92672">:=</span> string(<span style="color:#a6e22e">rawTxID</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">block</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">vledger</span>.<span style="color:#a6e22e">GetBlockByTxID</span>(<span style="color:#a6e22e">txID</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">bytes</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">protoutil</span>.<span style="color:#a6e22e">Marshal</span>(<span style="color:#a6e22e">block</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">shim</span>.<span style="color:#a6e22e">Success</span>(<span style="color:#a6e22e">bytes</span>)
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">getACLResource</span>(<span style="color:#a6e22e">fname</span> <span style="color:#66d9ef">string</span>) <span style="color:#66d9ef">string</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#34;qscc/&#34;</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">fname</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h4 id="get方法">Get方法</h4>
<p>QSCC提供的方法都是get方法，用于从通道中获取各种数据。</p>
<h3 id="配置系统链码-configuration-system-chaincode-cscc">配置系统链码 (<em>Configuration System Chaincode</em>, CSCC)</h3>
<blockquote>
<p>/core/scc/cscc/configure.go</p>
</blockquote>
<p>CSCC管理peer节点上通道相关的信息并执行通道配置交易</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">PeerConfiger</span> <span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">policyChecker</span>          <span style="color:#a6e22e">policy</span>.<span style="color:#a6e22e">PolicyChecker</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">configMgr</span>              <span style="color:#a6e22e">config</span>.<span style="color:#a6e22e">Manager</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">aclProvider</span>            <span style="color:#a6e22e">aclmgmt</span>.<span style="color:#a6e22e">ACLProvider</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">deployedCCInfoProvider</span> <span style="color:#a6e22e">ledger</span>.<span style="color:#a6e22e">DeployedChaincodeInfoProvider</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">legacyLifecycle</span>        <span style="color:#a6e22e">plugindispatcher</span>.<span style="color:#a6e22e">LifecycleResources</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">newLifecycle</span>           <span style="color:#a6e22e">plugindispatcher</span>.<span style="color:#a6e22e">CollectionAndLifecycleResources</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">peer</span>                   <span style="color:#f92672">*</span><span style="color:#a6e22e">peer</span>.<span style="color:#a6e22e">Peer</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">bccsp</span>                  <span style="color:#a6e22e">bccsp</span>.<span style="color:#a6e22e">BCCSP</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>CSCC中提供了PeerConfiger类。这个类实现了peer节点配置信息的处理。对于所有的从排序服务中进来的配置交易，都会调用这个系统链码来处理交易。</p>
<p>CSCC提供了三种方法</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">const</span> (
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">JoinChain</span>      <span style="color:#66d9ef">string</span> = <span style="color:#e6db74">&#34;JoinChain&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">GetConfigBlock</span> <span style="color:#66d9ef">string</span> = <span style="color:#e6db74">&#34;GetConfigBlock&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">GetChannels</span>    <span style="color:#66d9ef">string</span> = <span style="color:#e6db74">&#34;GetChannels&#34;</span>
</span></span><span style="display:flex;"><span>)
</span></span></code></pre></div><h4 id="joinchain方法">JoinChain方法</h4>
<p>JoinChain 方法用来使一个peer加入通道。它需要一个参数，即通道配置区块的序列化的protobuf byte。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>		<span style="color:#a6e22e">block</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">protoutil</span>.<span style="color:#a6e22e">UnmarshalBlock</span>(<span style="color:#a6e22e">args</span>[<span style="color:#ae81ff">1</span>])
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">cid</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">protoutil</span>.<span style="color:#a6e22e">GetChainIDFromBlock</span>(<span style="color:#a6e22e">block</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 1. 检查配置块的格式和要求
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#75715e">// 2. 检查加入的政策
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#75715e">// 初始化txsFilter
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#a6e22e">txsFilter</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">util</span>.<span style="color:#a6e22e">TxValidationFlags</span>(<span style="color:#a6e22e">block</span>.<span style="color:#a6e22e">Metadata</span>.<span style="color:#a6e22e">Metadata</span>[<span style="color:#a6e22e">common</span>.<span style="color:#a6e22e">BlockMetadataIndex_TRANSACTIONS_FILTER</span>])
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> len(<span style="color:#a6e22e">txsFilter</span>) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// add array of validation code hardcoded to valid
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>			<span style="color:#a6e22e">txsFilter</span> = <span style="color:#a6e22e">util</span>.<span style="color:#a6e22e">NewTxValidationFlagsSetValue</span>(len(<span style="color:#a6e22e">block</span>.<span style="color:#a6e22e">Data</span>.<span style="color:#a6e22e">Data</span>), <span style="color:#a6e22e">pb</span>.<span style="color:#a6e22e">TxValidationCode_VALID</span>)
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">block</span>.<span style="color:#a6e22e">Metadata</span>.<span style="color:#a6e22e">Metadata</span>[<span style="color:#a6e22e">common</span>.<span style="color:#a6e22e">BlockMetadataIndex_TRANSACTIONS_FILTER</span>] = <span style="color:#a6e22e">txsFilter</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">joinChain</span>(<span style="color:#a6e22e">cid</span>, <span style="color:#a6e22e">block</span>, <span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">deployedCCInfoProvider</span>, <span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">legacyLifecycle</span>, <span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">newLifecycle</span>)
</span></span></code></pre></div><h4 id="getconfigblock方法">GetConfigBlock方法</h4>
<p>这个方法用于获取给定通道的当前的配置区块。需要一个参数：通道名字的bytes形式。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>	<span style="color:#66d9ef">case</span> <span style="color:#a6e22e">GetConfigBlock</span>:
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 2. check policy
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">aclProvider</span>.<span style="color:#a6e22e">CheckACL</span>(<span style="color:#a6e22e">resources</span>.<span style="color:#a6e22e">Cscc_GetConfigBlock</span>, string(<span style="color:#a6e22e">args</span>[<span style="color:#ae81ff">1</span>]), <span style="color:#a6e22e">sp</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">shim</span>.<span style="color:#a6e22e">Error</span>(<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Sprintf</span>(<span style="color:#e6db74">&#34;access denied for [%s][%s]: %s&#34;</span>, <span style="color:#a6e22e">fname</span>, <span style="color:#a6e22e">args</span>[<span style="color:#ae81ff">1</span>], <span style="color:#a6e22e">err</span>))
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">getConfigBlock</span>(<span style="color:#a6e22e">args</span>[<span style="color:#ae81ff">1</span>])
</span></span></code></pre></div><h4 id="getchannel方法">GetChannel方法</h4>
<p>这个方法用于获取peer节点目前所加入的通道。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>	<span style="color:#66d9ef">case</span> <span style="color:#a6e22e">GetChannels</span>:
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 2. check get channels policy
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">aclProvider</span>.<span style="color:#a6e22e">CheckACL</span>(<span style="color:#a6e22e">resources</span>.<span style="color:#a6e22e">Cscc_GetChannels</span>, <span style="color:#e6db74">&#34;&#34;</span>, <span style="color:#a6e22e">sp</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">shim</span>.<span style="color:#a6e22e">Error</span>(<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Sprintf</span>(<span style="color:#e6db74">&#34;access denied for [%s]: %s&#34;</span>, <span style="color:#a6e22e">fname</span>, <span style="color:#a6e22e">err</span>))
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">getChannels</span>()
</span></span></code></pre></div><h3 id="生命周期系统链码-life-cycle-system-chaincode-lscc">生命周期系统链码 (<em>Life Cycle System Chaincode</em>, LSCC)</h3>
<p>LSCC主要管理链码的生命周期，主要包括：</p>
<ul>
<li>在peer节点上安装链码</li>
<li>在通道上部署和升级链码</li>
<li>用户从运行中的链码获取信息</li>
</ul>
<h4 id="链码的生命周期">链码的生命周期</h4>
<p>打包链码：</p>
<p>在被安装到peer节点之前，链码需要被打包进一个<code>.tar.gz</code>文件，其中包含两个文件：&ldquo;metadata.json&quot;和另一个包含链码文件的文件&quot;code.tar.gz&rdquo;</p>
<p>&ldquo;metadata.json&quot;包含了指定链码语言、代码路径、以及包标签的JSON文件。</p>
<p>安装链码：</p>
<p>每个要执行和背书交易的peer节点上都需要安装链码包。安装完成后，peer节点会构造链码。一般建议每个组织下的所有peer使用相同的链码包。</p>
<p>批准链码定义：</p>
<p>通过 <strong>链码定义</strong> 来管理链码。当通道成员批准一个链码定义，这个批准便作为一个组织在接受链码参数方面的投票。这些同意的组织定义允许通道成员在链码可以在通道上使用之前达成一致意见（同意链码运行在此通道上）。</p>
<p>链码定义包含以下参数（需要在组织之间保持一致）：<strong>名称</strong>、<strong>版本</strong>、<strong>序列号</strong>、<strong>背书策略</strong>、<strong>私有数据集合配置</strong>、<strong>ECSS/VSCC插件</strong>、<strong>初始化</strong></p>
<p>提交链码定义到通道：</p>
<p>足够多的成员同意一个链码定义后，某个组织能够提交定义到通道。提交交易首先发送给通道成员的peer节点，peer节点会查询链码定义的被同意状况，确认组织同意后为其背书，交易随后被提交到排序服务，排序服务会把链码定义提交给通道。</p>
<h4 id="源代码-1">源代码</h4>
<p>部署时的config</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#a6e22e">lsccInst</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">lscc</span>.<span style="color:#a6e22e">SCC</span>{
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">BuiltinSCCs</span>: <span style="color:#a6e22e">builtinSCCs</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// type: FilesystemSupport
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">// Support提供了一些静态函数的实现
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">Support</span>: <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">lscc</span>.<span style="color:#a6e22e">SupportImpl</span>{
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">GetMSPIDs</span>: <span style="color:#a6e22e">peerInstance</span>.<span style="color:#a6e22e">GetMSPIDs</span>,
</span></span><span style="display:flex;"><span>	},
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// type: sysccprovider.SystemChaincodeProvider
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">// SCCProvider是用于访问系统其他部分的接口
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">SCCProvider</span>:        <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">lscc</span>.<span style="color:#a6e22e">PeerShim</span>{<span style="color:#a6e22e">Peer</span>: <span style="color:#a6e22e">peerInstance</span>},
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// type: aclmgmt.ACLProvider
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">// ACLProvider负责访问权限控制
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">ACLProvider</span>:        <span style="color:#a6e22e">aclProvider</span>, 
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">GetMSPIDs</span>:          <span style="color:#a6e22e">peerInstance</span>.<span style="color:#a6e22e">GetMSPIDs</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// type: policy.PolicyChecker
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">// PolicyChecker是用于执行访问控制的接口
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">PolicyChecker</span>:      <span style="color:#a6e22e">policyChecker</span>,
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">BCCSP</span>:              <span style="color:#a6e22e">factory</span>.<span style="color:#a6e22e">GetDefault</span>(),
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">BuildRegistry</span>:      <span style="color:#a6e22e">buildRegistry</span>,
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">ChaincodeBuilder</span>:   <span style="color:#a6e22e">containerRouter</span>,
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">EbMetadataProvider</span>: <span style="color:#a6e22e">ebMetadataProvider</span>,
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><blockquote>
<p>/core/scc/lscc/lscc.go</p>
</blockquote>
<p><code>Invoke</code>代码的形式与QSCC部分类似，都是使用switch语句选择所调用的方法（将函数名定义为常量）</p>
<p>由于代码过长，以下代码省略异常处理部分：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">lscc</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">SCC</span>) <span style="color:#a6e22e">Invoke</span>(<span style="color:#a6e22e">stub</span> <span style="color:#a6e22e">shim</span>.<span style="color:#a6e22e">ChaincodeStubInterface</span>) <span style="color:#a6e22e">pb</span>.<span style="color:#a6e22e">Response</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">args</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">stub</span>.<span style="color:#a6e22e">GetArgs</span>()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">function</span> <span style="color:#f92672">:=</span> string(<span style="color:#a6e22e">args</span>[<span style="color:#ae81ff">0</span>]) <span style="color:#75715e">// 第一个参数是函数名
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">switch</span> <span style="color:#a6e22e">function</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">case</span> <span style="color:#a6e22e">INSTALL</span>:
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">depSpec</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">args</span>[<span style="color:#ae81ff">1</span>]
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">lscc</span>.<span style="color:#a6e22e">executeInstall</span>(<span style="color:#a6e22e">stub</span>, <span style="color:#a6e22e">depSpec</span>) <span style="color:#75715e">// 根据第二个参数 deployment spec 安装链码
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">shim</span>.<span style="color:#a6e22e">Success</span>([]byte(<span style="color:#e6db74">&#34;OK&#34;</span>))
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">case</span> <span style="color:#a6e22e">DEPLOY</span>, <span style="color:#a6e22e">UPGRADE</span>:
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 至少有三个参数： 函数名，链码名和deployment spec
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">channel</span> <span style="color:#f92672">:=</span> string(<span style="color:#a6e22e">args</span>[<span style="color:#ae81ff">1</span>])
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">ac</span>, <span style="color:#a6e22e">exists</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">lscc</span>.<span style="color:#a6e22e">SCCProvider</span>.<span style="color:#a6e22e">GetApplicationConfig</span>(<span style="color:#a6e22e">channel</span>) <span style="color:#75715e">// 通过第二个参数获取配置
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">depSpec</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">args</span>[<span style="color:#ae81ff">2</span>]
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">cds</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">pb</span>.<span style="color:#a6e22e">ChaincodeDeploymentSpec</span>{}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 可选参数：
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#75715e">// 第四个参数是 已编组的 SignaturePolicyEnvelope 代表了背书政策
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#75715e">// 第五个参数是 escc名
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#75715e">// 第六个参数是 vscc名
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#75715e">// 第七个参数是 一个已编组的 CollectionConfigPackage 类
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 第四个参数：
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">EP</span> []<span style="color:#66d9ef">byte</span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> len(<span style="color:#a6e22e">args</span>) &gt; <span style="color:#ae81ff">3</span> <span style="color:#f92672">&amp;&amp;</span> len(<span style="color:#a6e22e">args</span>[<span style="color:#ae81ff">3</span>]) &gt; <span style="color:#ae81ff">0</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">EP</span> = <span style="color:#a6e22e">args</span>[<span style="color:#ae81ff">3</span>] <span style="color:#75715e">// EP为一个背书政策
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		} <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">mspIDs</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">lscc</span>.<span style="color:#a6e22e">GetMSPIDs</span>(<span style="color:#a6e22e">channel</span>)
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">p</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">policydsl</span>.<span style="color:#a6e22e">SignedByAnyMember</span>(<span style="color:#a6e22e">mspIDs</span>) <span style="color:#75715e">// 根据通道的mspID获取背书政策？
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>			<span style="color:#a6e22e">EP</span>, <span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">protoutil</span>.<span style="color:#a6e22e">Marshal</span>(<span style="color:#a6e22e">p</span>) <span style="color:#75715e">// 将结果进行编组
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 第五个参数：
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">escc</span> []<span style="color:#66d9ef">byte</span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> len(<span style="color:#a6e22e">args</span>) &gt; <span style="color:#ae81ff">4</span> <span style="color:#f92672">&amp;&amp;</span> len(<span style="color:#a6e22e">args</span>[<span style="color:#ae81ff">4</span>]) &gt; <span style="color:#ae81ff">0</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">escc</span> = <span style="color:#a6e22e">args</span>[<span style="color:#ae81ff">4</span>]
</span></span><span style="display:flex;"><span>		} <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">escc</span> = []byte(<span style="color:#e6db74">&#34;escc&#34;</span>) <span style="color:#75715e">// 默认为escc
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 第六个参数：
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">vscc</span> []<span style="color:#66d9ef">byte</span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> len(<span style="color:#a6e22e">args</span>) &gt; <span style="color:#ae81ff">5</span> <span style="color:#f92672">&amp;&amp;</span> len(<span style="color:#a6e22e">args</span>[<span style="color:#ae81ff">5</span>]) &gt; <span style="color:#ae81ff">0</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">vscc</span> = <span style="color:#a6e22e">args</span>[<span style="color:#ae81ff">5</span>]
</span></span><span style="display:flex;"><span>		} <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">vscc</span> = []byte(<span style="color:#e6db74">&#34;vscc&#34;</span>) <span style="color:#75715e">// 默认为vscc
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 如果有第七个参数：
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">collectionsConfig</span> []<span style="color:#66d9ef">byte</span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">ac</span>.<span style="color:#a6e22e">Capabilities</span>().<span style="color:#a6e22e">PrivateChannelData</span>() <span style="color:#f92672">&amp;&amp;</span> len(<span style="color:#a6e22e">args</span>) &gt; <span style="color:#ae81ff">6</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">collectionsConfig</span> = <span style="color:#a6e22e">args</span>[<span style="color:#ae81ff">6</span>]
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 将所有的参数传入executeDeployOrUpgrade方法中执行
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#a6e22e">cd</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">lscc</span>.<span style="color:#a6e22e">executeDeployOrUpgrade</span>(<span style="color:#a6e22e">stub</span>, <span style="color:#a6e22e">channel</span>, <span style="color:#a6e22e">cds</span>, <span style="color:#a6e22e">EP</span>, <span style="color:#a6e22e">escc</span>, <span style="color:#a6e22e">vscc</span>, <span style="color:#a6e22e">collectionsConfig</span>, <span style="color:#a6e22e">function</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">shim</span>.<span style="color:#a6e22e">Success</span>(<span style="color:#a6e22e">cdbytes</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">case</span> <span style="color:#a6e22e">CCEXISTS</span>, <span style="color:#a6e22e">CHAINCODEEXISTS</span>, <span style="color:#a6e22e">GETDEPSPEC</span>, <span style="color:#a6e22e">GETDEPLOYMENTSPEC</span>, <span style="color:#a6e22e">GETCCDATA</span>, <span style="color:#a6e22e">GETCHAINCODEDATA</span>:
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 变量个数必须为3
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#a6e22e">channel</span> <span style="color:#f92672">:=</span> string(<span style="color:#a6e22e">args</span>[<span style="color:#ae81ff">1</span>])
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">ccname</span> <span style="color:#f92672">:=</span> string(<span style="color:#a6e22e">args</span>[<span style="color:#ae81ff">2</span>])
</span></span><span style="display:flex;"><span>		
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">cdbytes</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">lscc</span>.<span style="color:#a6e22e">getCCInstance</span>(<span style="color:#a6e22e">stub</span>, <span style="color:#a6e22e">ccname</span>) <span style="color:#75715e">// 获取实例
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">switch</span> <span style="color:#a6e22e">function</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">case</span> <span style="color:#a6e22e">CCEXISTS</span>, <span style="color:#a6e22e">CHAINCODEEXISTS</span>:
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">cd</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">lscc</span>.<span style="color:#a6e22e">getChaincodeData</span>(<span style="color:#a6e22e">ccname</span>, <span style="color:#a6e22e">cdbytes</span>) <span style="color:#75715e">// 获取链码数据
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#66d9ef">case</span> <span style="color:#a6e22e">GETCCDATA</span>, <span style="color:#a6e22e">GETCHAINCODEDATA</span>:
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">shim</span>.<span style="color:#a6e22e">Success</span>(<span style="color:#a6e22e">cdbytes</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">case</span> <span style="color:#a6e22e">GETDEPSPEC</span>, <span style="color:#a6e22e">GETDEPLOYMENTSPEC</span>:
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">depspecbytes</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">lscc</span>.<span style="color:#a6e22e">getCCCode</span>(<span style="color:#a6e22e">ccname</span>, <span style="color:#a6e22e">cdbytes</span>)
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">shim</span>.<span style="color:#a6e22e">Success</span>(<span style="color:#a6e22e">depspecbytes</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">default</span>:
</span></span><span style="display:flex;"><span>			panic(<span style="color:#e6db74">&#34;unreachable&#34;</span>)
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">case</span> <span style="color:#a6e22e">GETCHAINCODES</span>, <span style="color:#a6e22e">GETCHAINCODESALIAS</span>:
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 变量个数必须为1
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">lscc</span>.<span style="color:#a6e22e">getChaincodes</span>(<span style="color:#a6e22e">stub</span>) <span style="color:#75715e">// 调用对应方法
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">case</span> <span style="color:#a6e22e">GETINSTALLEDCHAINCODES</span>, <span style="color:#a6e22e">GETINSTALLEDCHAINCODESALIAS</span>:
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 变量个数必须为1
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">lscc</span>.<span style="color:#a6e22e">getInstalledChaincodes</span>() <span style="color:#75715e">// 调用对应方法
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">case</span> <span style="color:#a6e22e">GETCOLLECTIONSCONFIG</span>, <span style="color:#a6e22e">GETCOLLECTIONSCONFIGALIAS</span>:
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 变量个数必须为2
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#a6e22e">chaincodeName</span> <span style="color:#f92672">:=</span> string(<span style="color:#a6e22e">args</span>[<span style="color:#ae81ff">1</span>])
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">lscc</span>.<span style="color:#a6e22e">getChaincodeCollectionData</span>(<span style="color:#a6e22e">stub</span>, <span style="color:#a6e22e">chaincodeName</span>) <span style="color:#75715e">// 调用对应方法
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">shim</span>.<span style="color:#a6e22e">Error</span>(<span style="color:#a6e22e">InvalidFunctionErr</span>(<span style="color:#a6e22e">function</span>).<span style="color:#a6e22e">Error</span>())
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Install方法：</p>
<p>用于存储chaincode程序到peer的文件系统，需要一个参数，及chancode deployment spec的序列化protobuf bytes。</p>
<p>Deploy方法：</p>
<p>用于在给定的通道上实例化合约，可以接受五个参数，前两个参数是必须的：通道名称与chaincode deployment spec。另外三个参数为：倍数策略、背书系统合约的名字和验证系统合约的名字。</p>
<p>Upgrade方法：</p>
<p>用于升级合约</p>
<p>Get方法：</p>
<p>剩下的get方法都用于获取相应的合约数据</p>
<h3 id="背书系统链码-endorser-system-chaincode-escc">背书系统链码 (<em>Endorser System Chaincode</em>, ESCC)</h3>
<p>在背书节点上运行，对交易结束进行结构转换和签名背书。</p>
<blockquote>
<p>/core/endorser/endorser.go</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#a6e22e">endorser</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> (
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;context&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;strconv&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;time&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;github.com/golang/protobuf/proto&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;github.com/hyperledger/fabric-chaincode-go/shim&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">pb</span> <span style="color:#e6db74">&#34;github.com/hyperledger/fabric-protos-go/peer&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;github.com/hyperledger/fabric-protos-go/transientstore&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;github.com/hyperledger/fabric/common/flogging&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;github.com/hyperledger/fabric/common/util&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;github.com/hyperledger/fabric/core/chaincode/lifecycle&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;github.com/hyperledger/fabric/core/common/ccprovider&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;github.com/hyperledger/fabric/core/ledger&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;github.com/hyperledger/fabric/internal/pkg/identity&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;github.com/hyperledger/fabric/msp&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;github.com/hyperledger/fabric/protoutil&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;github.com/pkg/errors&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;go.uber.org/zap&#34;</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">endorserLogger</span> = <span style="color:#a6e22e">flogging</span>.<span style="color:#a6e22e">MustGetLogger</span>(<span style="color:#e6db74">&#34;endorser&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// The Jira issue that documents Endorser flow along with its relationship to
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// the lifecycle chaincode - https://jira.hyperledger.org/browse/FAB-181
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">//go:generate counterfeiter -o fake/prvt_data_distributor.go --fake-name PrivateDataDistributor . PrivateDataDistributor
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">PrivateDataDistributor</span> <span style="color:#66d9ef">interface</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">DistributePrivateData</span>(<span style="color:#a6e22e">channel</span> <span style="color:#66d9ef">string</span>, <span style="color:#a6e22e">txID</span> <span style="color:#66d9ef">string</span>, <span style="color:#a6e22e">privateData</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">transientstore</span>.<span style="color:#a6e22e">TxPvtReadWriteSetWithConfigInfo</span>, <span style="color:#a6e22e">blkHt</span> <span style="color:#66d9ef">uint64</span>) <span style="color:#66d9ef">error</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Support contains functions that the endorser requires to execute its tasks
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Support</span> <span style="color:#66d9ef">interface</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">identity</span>.<span style="color:#a6e22e">SignerSerializer</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// GetTxSimulator returns the transaction simulator for the specified ledger
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">// a client may obtain more than one such simulator; they are made unique
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">// by way of the supplied txid
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">GetTxSimulator</span>(<span style="color:#a6e22e">ledgername</span> <span style="color:#66d9ef">string</span>, <span style="color:#a6e22e">txid</span> <span style="color:#66d9ef">string</span>) (<span style="color:#a6e22e">ledger</span>.<span style="color:#a6e22e">TxSimulator</span>, <span style="color:#66d9ef">error</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// GetHistoryQueryExecutor gives handle to a history query executor for the
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">// specified ledger
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">GetHistoryQueryExecutor</span>(<span style="color:#a6e22e">ledgername</span> <span style="color:#66d9ef">string</span>) (<span style="color:#a6e22e">ledger</span>.<span style="color:#a6e22e">HistoryQueryExecutor</span>, <span style="color:#66d9ef">error</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// GetTransactionByID retrieves a transaction by id
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">GetTransactionByID</span>(<span style="color:#a6e22e">chid</span>, <span style="color:#a6e22e">txID</span> <span style="color:#66d9ef">string</span>) (<span style="color:#f92672">*</span><span style="color:#a6e22e">pb</span>.<span style="color:#a6e22e">ProcessedTransaction</span>, <span style="color:#66d9ef">error</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// IsSysCC returns true if the name matches a system chaincode&#39;s
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">// system chaincode names are system, chain wide
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">IsSysCC</span>(<span style="color:#a6e22e">name</span> <span style="color:#66d9ef">string</span>) <span style="color:#66d9ef">bool</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// Execute - execute proposal, return original response of chaincode
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">Execute</span>(<span style="color:#a6e22e">txParams</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">ccprovider</span>.<span style="color:#a6e22e">TransactionParams</span>, <span style="color:#a6e22e">name</span> <span style="color:#66d9ef">string</span>, <span style="color:#a6e22e">input</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">pb</span>.<span style="color:#a6e22e">ChaincodeInput</span>) (<span style="color:#f92672">*</span><span style="color:#a6e22e">pb</span>.<span style="color:#a6e22e">Response</span>, <span style="color:#f92672">*</span><span style="color:#a6e22e">pb</span>.<span style="color:#a6e22e">ChaincodeEvent</span>, <span style="color:#66d9ef">error</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// ExecuteLegacyInit - executes a deployment proposal, return original response of chaincode
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">ExecuteLegacyInit</span>(<span style="color:#a6e22e">txParams</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">ccprovider</span>.<span style="color:#a6e22e">TransactionParams</span>, <span style="color:#a6e22e">name</span>, <span style="color:#a6e22e">version</span> <span style="color:#66d9ef">string</span>, <span style="color:#a6e22e">spec</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">pb</span>.<span style="color:#a6e22e">ChaincodeInput</span>) (<span style="color:#f92672">*</span><span style="color:#a6e22e">pb</span>.<span style="color:#a6e22e">Response</span>, <span style="color:#f92672">*</span><span style="color:#a6e22e">pb</span>.<span style="color:#a6e22e">ChaincodeEvent</span>, <span style="color:#66d9ef">error</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// ChaincodeEndorsementInfo returns the information from lifecycle required to endorse the chaincode.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">ChaincodeEndorsementInfo</span>(<span style="color:#a6e22e">channelID</span>, <span style="color:#a6e22e">chaincodeID</span> <span style="color:#66d9ef">string</span>, <span style="color:#a6e22e">txsim</span> <span style="color:#a6e22e">ledger</span>.<span style="color:#a6e22e">QueryExecutor</span>) (<span style="color:#f92672">*</span><span style="color:#a6e22e">lifecycle</span>.<span style="color:#a6e22e">ChaincodeEndorsementInfo</span>, <span style="color:#66d9ef">error</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// CheckACL checks the ACL for the resource for the channel using the
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">// SignedProposal from which an id can be extracted for testing against a policy
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">CheckACL</span>(<span style="color:#a6e22e">channelID</span> <span style="color:#66d9ef">string</span>, <span style="color:#a6e22e">signedProp</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">pb</span>.<span style="color:#a6e22e">SignedProposal</span>) <span style="color:#66d9ef">error</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// EndorseWithPlugin endorses the response with a plugin
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">EndorseWithPlugin</span>(<span style="color:#a6e22e">pluginName</span>, <span style="color:#a6e22e">channnelID</span> <span style="color:#66d9ef">string</span>, <span style="color:#a6e22e">prpBytes</span> []<span style="color:#66d9ef">byte</span>, <span style="color:#a6e22e">signedProposal</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">pb</span>.<span style="color:#a6e22e">SignedProposal</span>) (<span style="color:#f92672">*</span><span style="color:#a6e22e">pb</span>.<span style="color:#a6e22e">Endorsement</span>, []<span style="color:#66d9ef">byte</span>, <span style="color:#66d9ef">error</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// GetLedgerHeight returns ledger height for given channelID
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">GetLedgerHeight</span>(<span style="color:#a6e22e">channelID</span> <span style="color:#66d9ef">string</span>) (<span style="color:#66d9ef">uint64</span>, <span style="color:#66d9ef">error</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// GetDeployedCCInfoProvider returns ledger.DeployedChaincodeInfoProvider
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">GetDeployedCCInfoProvider</span>() <span style="color:#a6e22e">ledger</span>.<span style="color:#a6e22e">DeployedChaincodeInfoProvider</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">//go:generate counterfeiter -o fake/channel_fetcher.go --fake-name ChannelFetcher . ChannelFetcher
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// ChannelFetcher fetches the channel context for a given channel ID.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">ChannelFetcher</span> <span style="color:#66d9ef">interface</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">Channel</span>(<span style="color:#a6e22e">channelID</span> <span style="color:#66d9ef">string</span>) <span style="color:#f92672">*</span><span style="color:#a6e22e">Channel</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Channel</span> <span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">IdentityDeserializer</span> <span style="color:#a6e22e">msp</span>.<span style="color:#a6e22e">IdentityDeserializer</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Endorser provides the Endorser service ProcessProposal
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Endorser</span> <span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">ChannelFetcher</span>         <span style="color:#a6e22e">ChannelFetcher</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">LocalMSP</span>               <span style="color:#a6e22e">msp</span>.<span style="color:#a6e22e">IdentityDeserializer</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">PrivateDataDistributor</span> <span style="color:#a6e22e">PrivateDataDistributor</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">Support</span>                <span style="color:#a6e22e">Support</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">PvtRWSetAssembler</span>      <span style="color:#a6e22e">PvtRWSetAssembler</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">Metrics</span>                <span style="color:#f92672">*</span><span style="color:#a6e22e">Metrics</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// call specified chaincode (system or user)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">e</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Endorser</span>) <span style="color:#a6e22e">callChaincode</span>(<span style="color:#a6e22e">txParams</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">ccprovider</span>.<span style="color:#a6e22e">TransactionParams</span>, <span style="color:#a6e22e">input</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">pb</span>.<span style="color:#a6e22e">ChaincodeInput</span>, <span style="color:#a6e22e">chaincodeName</span> <span style="color:#66d9ef">string</span>) (<span style="color:#f92672">*</span><span style="color:#a6e22e">pb</span>.<span style="color:#a6e22e">Response</span>, <span style="color:#f92672">*</span><span style="color:#a6e22e">pb</span>.<span style="color:#a6e22e">ChaincodeEvent</span>, <span style="color:#66d9ef">error</span>) {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">defer</span> <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">start</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Time</span>) {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">logger</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">endorserLogger</span>.<span style="color:#a6e22e">WithOptions</span>(<span style="color:#a6e22e">zap</span>.<span style="color:#a6e22e">AddCallerSkip</span>(<span style="color:#ae81ff">1</span>))
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">logger</span> = <span style="color:#a6e22e">decorateLogger</span>(<span style="color:#a6e22e">logger</span>, <span style="color:#a6e22e">txParams</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">elapsedMillisec</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Since</span>(<span style="color:#a6e22e">start</span>).<span style="color:#a6e22e">Milliseconds</span>()
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">logger</span>.<span style="color:#a6e22e">Infof</span>(<span style="color:#e6db74">&#34;finished chaincode: %s duration: %dms&#34;</span>, <span style="color:#a6e22e">chaincodeName</span>, <span style="color:#a6e22e">elapsedMillisec</span>)
</span></span><span style="display:flex;"><span>	}(<span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Now</span>())
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">meterLabels</span> <span style="color:#f92672">:=</span> []<span style="color:#66d9ef">string</span>{
</span></span><span style="display:flex;"><span>		<span style="color:#e6db74">&#34;channel&#34;</span>, <span style="color:#a6e22e">txParams</span>.<span style="color:#a6e22e">ChannelID</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#e6db74">&#34;chaincode&#34;</span>, <span style="color:#a6e22e">chaincodeName</span>,
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">res</span>, <span style="color:#a6e22e">ccevent</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">Support</span>.<span style="color:#a6e22e">Execute</span>(<span style="color:#a6e22e">txParams</span>, <span style="color:#a6e22e">chaincodeName</span>, <span style="color:#a6e22e">input</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">Metrics</span>.<span style="color:#a6e22e">SimulationFailure</span>.<span style="color:#a6e22e">With</span>(<span style="color:#a6e22e">meterLabels</span><span style="color:#f92672">...</span>).<span style="color:#a6e22e">Add</span>(<span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">err</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// per doc anything &lt; 400 can be sent as TX.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">// fabric errors will always be &gt;= 400 (ie, unambiguous errors )
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">// &#34;lscc&#34; will respond with status 200 or 500 (ie, unambiguous OK or ERROR)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">res</span>.<span style="color:#a6e22e">Status</span> <span style="color:#f92672">&gt;=</span> <span style="color:#a6e22e">shim</span>.<span style="color:#a6e22e">ERRORTHRESHOLD</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">res</span>, <span style="color:#66d9ef">nil</span>, <span style="color:#66d9ef">nil</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// Unless this is the weirdo LSCC case, just return
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">chaincodeName</span> <span style="color:#f92672">!=</span> <span style="color:#e6db74">&#34;lscc&#34;</span> <span style="color:#f92672">||</span> len(<span style="color:#a6e22e">input</span>.<span style="color:#a6e22e">Args</span>) &lt; <span style="color:#ae81ff">3</span> <span style="color:#f92672">||</span> (string(<span style="color:#a6e22e">input</span>.<span style="color:#a6e22e">Args</span>[<span style="color:#ae81ff">0</span>]) <span style="color:#f92672">!=</span> <span style="color:#e6db74">&#34;deploy&#34;</span> <span style="color:#f92672">&amp;&amp;</span> string(<span style="color:#a6e22e">input</span>.<span style="color:#a6e22e">Args</span>[<span style="color:#ae81ff">0</span>]) <span style="color:#f92672">!=</span> <span style="color:#e6db74">&#34;upgrade&#34;</span>) {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">res</span>, <span style="color:#a6e22e">ccevent</span>, <span style="color:#66d9ef">nil</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// ----- BEGIN -  SECTION THAT MAY NEED TO BE DONE IN LSCC ------
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">// if this a call to deploy a chaincode, We need a mechanism
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">// to pass TxSimulator into LSCC. Till that is worked out this
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">// special code does the actual deploy, upgrade here so as to collect
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">// all state under one TxSimulator
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">//
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">// NOTE that if there&#39;s an error all simulation, including the chaincode
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">// table changes in lscc will be thrown away
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">cds</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">protoutil</span>.<span style="color:#a6e22e">UnmarshalChaincodeDeploymentSpec</span>(<span style="color:#a6e22e">input</span>.<span style="color:#a6e22e">Args</span>[<span style="color:#ae81ff">2</span>])
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">Metrics</span>.<span style="color:#a6e22e">SimulationFailure</span>.<span style="color:#a6e22e">With</span>(<span style="color:#a6e22e">meterLabels</span><span style="color:#f92672">...</span>).<span style="color:#a6e22e">Add</span>(<span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">err</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// this should not be a system chaincode
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">Support</span>.<span style="color:#a6e22e">IsSysCC</span>(<span style="color:#a6e22e">cds</span>.<span style="color:#a6e22e">ChaincodeSpec</span>.<span style="color:#a6e22e">ChaincodeId</span>.<span style="color:#a6e22e">Name</span>) {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">Metrics</span>.<span style="color:#a6e22e">SimulationFailure</span>.<span style="color:#a6e22e">With</span>(<span style="color:#a6e22e">meterLabels</span><span style="color:#f92672">...</span>).<span style="color:#a6e22e">Add</span>(<span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">errors</span>.<span style="color:#a6e22e">Errorf</span>(<span style="color:#e6db74">&#34;attempting to deploy a system chaincode %s/%s&#34;</span>, <span style="color:#a6e22e">cds</span>.<span style="color:#a6e22e">ChaincodeSpec</span>.<span style="color:#a6e22e">ChaincodeId</span>.<span style="color:#a6e22e">Name</span>, <span style="color:#a6e22e">txParams</span>.<span style="color:#a6e22e">ChannelID</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> len(<span style="color:#a6e22e">cds</span>.<span style="color:#a6e22e">CodePackage</span>) <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">Metrics</span>.<span style="color:#a6e22e">SimulationFailure</span>.<span style="color:#a6e22e">With</span>(<span style="color:#a6e22e">meterLabels</span><span style="color:#f92672">...</span>).<span style="color:#a6e22e">Add</span>(<span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">errors</span>.<span style="color:#a6e22e">Errorf</span>(<span style="color:#e6db74">&#34;lscc upgrade/deploy should not include a code packages&#34;</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">Support</span>.<span style="color:#a6e22e">ExecuteLegacyInit</span>(<span style="color:#a6e22e">txParams</span>, <span style="color:#a6e22e">cds</span>.<span style="color:#a6e22e">ChaincodeSpec</span>.<span style="color:#a6e22e">ChaincodeId</span>.<span style="color:#a6e22e">Name</span>, <span style="color:#a6e22e">cds</span>.<span style="color:#a6e22e">ChaincodeSpec</span>.<span style="color:#a6e22e">ChaincodeId</span>.<span style="color:#a6e22e">Version</span>, <span style="color:#a6e22e">cds</span>.<span style="color:#a6e22e">ChaincodeSpec</span>.<span style="color:#a6e22e">Input</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// increment the failure to indicate instantion/upgrade failures
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#a6e22e">meterLabels</span> = []<span style="color:#66d9ef">string</span>{
</span></span><span style="display:flex;"><span>			<span style="color:#e6db74">&#34;channel&#34;</span>, <span style="color:#a6e22e">txParams</span>.<span style="color:#a6e22e">ChannelID</span>,
</span></span><span style="display:flex;"><span>			<span style="color:#e6db74">&#34;chaincode&#34;</span>, <span style="color:#a6e22e">cds</span>.<span style="color:#a6e22e">ChaincodeSpec</span>.<span style="color:#a6e22e">ChaincodeId</span>.<span style="color:#a6e22e">Name</span>,
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">Metrics</span>.<span style="color:#a6e22e">InitFailed</span>.<span style="color:#a6e22e">With</span>(<span style="color:#a6e22e">meterLabels</span><span style="color:#f92672">...</span>).<span style="color:#a6e22e">Add</span>(<span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">err</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">res</span>, <span style="color:#a6e22e">ccevent</span>, <span style="color:#a6e22e">err</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// SimulateProposal simulates the proposal by calling the chaincode
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">e</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Endorser</span>) <span style="color:#a6e22e">SimulateProposal</span>(<span style="color:#a6e22e">txParams</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">ccprovider</span>.<span style="color:#a6e22e">TransactionParams</span>, <span style="color:#a6e22e">chaincodeName</span> <span style="color:#66d9ef">string</span>, <span style="color:#a6e22e">chaincodeInput</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">pb</span>.<span style="color:#a6e22e">ChaincodeInput</span>) (<span style="color:#f92672">*</span><span style="color:#a6e22e">pb</span>.<span style="color:#a6e22e">Response</span>, []<span style="color:#66d9ef">byte</span>, <span style="color:#f92672">*</span><span style="color:#a6e22e">pb</span>.<span style="color:#a6e22e">ChaincodeEvent</span>, <span style="color:#66d9ef">error</span>) {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">logger</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">decorateLogger</span>(<span style="color:#a6e22e">endorserLogger</span>, <span style="color:#a6e22e">txParams</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">meterLabels</span> <span style="color:#f92672">:=</span> []<span style="color:#66d9ef">string</span>{
</span></span><span style="display:flex;"><span>		<span style="color:#e6db74">&#34;channel&#34;</span>, <span style="color:#a6e22e">txParams</span>.<span style="color:#a6e22e">ChannelID</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#e6db74">&#34;chaincode&#34;</span>, <span style="color:#a6e22e">chaincodeName</span>,
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// ---3. execute the proposal and get simulation results
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">res</span>, <span style="color:#a6e22e">ccevent</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">callChaincode</span>(<span style="color:#a6e22e">txParams</span>, <span style="color:#a6e22e">chaincodeInput</span>, <span style="color:#a6e22e">chaincodeName</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">logger</span>.<span style="color:#a6e22e">Errorf</span>(<span style="color:#e6db74">&#34;failed to invoke chaincode %s, error: %+v&#34;</span>, <span style="color:#a6e22e">chaincodeName</span>, <span style="color:#a6e22e">err</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#66d9ef">nil</span>, <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">err</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">txParams</span>.<span style="color:#a6e22e">TXSimulator</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">res</span>, <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">ccevent</span>, <span style="color:#66d9ef">nil</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// Note, this is a little goofy, as if there is private data, Done() gets called
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">// early, so this is invoked multiple times, but that is how the code worked before
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">// this change, so, should be safe.  Long term, let&#39;s move the Done up to the create.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">txParams</span>.<span style="color:#a6e22e">TXSimulator</span>.<span style="color:#a6e22e">Done</span>()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">simResult</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">txParams</span>.<span style="color:#a6e22e">TXSimulator</span>.<span style="color:#a6e22e">GetTxSimulationResults</span>()
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">Metrics</span>.<span style="color:#a6e22e">SimulationFailure</span>.<span style="color:#a6e22e">With</span>(<span style="color:#a6e22e">meterLabels</span><span style="color:#f92672">...</span>).<span style="color:#a6e22e">Add</span>(<span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#66d9ef">nil</span>, <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">err</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">simResult</span>.<span style="color:#a6e22e">PvtSimulationResults</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">chaincodeName</span> <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;lscc&#34;</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// TODO: remove once we can store collection configuration outside of LSCC
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>			<span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">Metrics</span>.<span style="color:#a6e22e">SimulationFailure</span>.<span style="color:#a6e22e">With</span>(<span style="color:#a6e22e">meterLabels</span><span style="color:#f92672">...</span>).<span style="color:#a6e22e">Add</span>(<span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#66d9ef">nil</span>, <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">errors</span>.<span style="color:#a6e22e">New</span>(<span style="color:#e6db74">&#34;Private data is forbidden to be used in instantiate&#34;</span>)
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">pvtDataWithConfig</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">AssemblePvtRWSet</span>(<span style="color:#a6e22e">txParams</span>.<span style="color:#a6e22e">ChannelID</span>, <span style="color:#a6e22e">simResult</span>.<span style="color:#a6e22e">PvtSimulationResults</span>, <span style="color:#a6e22e">txParams</span>.<span style="color:#a6e22e">TXSimulator</span>, <span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">Support</span>.<span style="color:#a6e22e">GetDeployedCCInfoProvider</span>())
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// To read collection config need to read collection updates before
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#75715e">// releasing the lock, hence txParams.TXSimulator.Done()  moved down here
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#a6e22e">txParams</span>.<span style="color:#a6e22e">TXSimulator</span>.<span style="color:#a6e22e">Done</span>()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">Metrics</span>.<span style="color:#a6e22e">SimulationFailure</span>.<span style="color:#a6e22e">With</span>(<span style="color:#a6e22e">meterLabels</span><span style="color:#f92672">...</span>).<span style="color:#a6e22e">Add</span>(<span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#66d9ef">nil</span>, <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">errors</span>.<span style="color:#a6e22e">WithMessage</span>(<span style="color:#a6e22e">err</span>, <span style="color:#e6db74">&#34;failed to obtain collections config&#34;</span>)
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">endorsedAt</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">Support</span>.<span style="color:#a6e22e">GetLedgerHeight</span>(<span style="color:#a6e22e">txParams</span>.<span style="color:#a6e22e">ChannelID</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">Metrics</span>.<span style="color:#a6e22e">SimulationFailure</span>.<span style="color:#a6e22e">With</span>(<span style="color:#a6e22e">meterLabels</span><span style="color:#f92672">...</span>).<span style="color:#a6e22e">Add</span>(<span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#66d9ef">nil</span>, <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">errors</span>.<span style="color:#a6e22e">WithMessage</span>(<span style="color:#a6e22e">err</span>, <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Sprintf</span>(<span style="color:#e6db74">&#34;failed to obtain ledger height for channel &#39;%s&#39;&#34;</span>, <span style="color:#a6e22e">txParams</span>.<span style="color:#a6e22e">ChannelID</span>))
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// Add ledger height at which transaction was endorsed,
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#75715e">// `endorsedAt` is obtained from the block storage and at times this could be &#39;endorsement Height + 1&#39;.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#75715e">// However, since we use this height only to select the configuration (3rd parameter in distributePrivateData) and
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#75715e">// manage transient store purge for orphaned private writesets (4th parameter in distributePrivateData), this works for now.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#75715e">// Ideally, ledger should add support in the simulator as a first class function `GetHeight()`.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#a6e22e">pvtDataWithConfig</span>.<span style="color:#a6e22e">EndorsedAt</span> = <span style="color:#a6e22e">endorsedAt</span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">PrivateDataDistributor</span>.<span style="color:#a6e22e">DistributePrivateData</span>(<span style="color:#a6e22e">txParams</span>.<span style="color:#a6e22e">ChannelID</span>, <span style="color:#a6e22e">txParams</span>.<span style="color:#a6e22e">TxID</span>, <span style="color:#a6e22e">pvtDataWithConfig</span>, <span style="color:#a6e22e">endorsedAt</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">Metrics</span>.<span style="color:#a6e22e">SimulationFailure</span>.<span style="color:#a6e22e">With</span>(<span style="color:#a6e22e">meterLabels</span><span style="color:#f92672">...</span>).<span style="color:#a6e22e">Add</span>(<span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#66d9ef">nil</span>, <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">err</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">pubSimResBytes</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">simResult</span>.<span style="color:#a6e22e">GetPubSimulationBytes</span>()
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">Metrics</span>.<span style="color:#a6e22e">SimulationFailure</span>.<span style="color:#a6e22e">With</span>(<span style="color:#a6e22e">meterLabels</span><span style="color:#f92672">...</span>).<span style="color:#a6e22e">Add</span>(<span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#66d9ef">nil</span>, <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">err</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">res</span>, <span style="color:#a6e22e">pubSimResBytes</span>, <span style="color:#a6e22e">ccevent</span>, <span style="color:#66d9ef">nil</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// preProcess checks the tx proposal headers, uniqueness and ACL
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">e</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Endorser</span>) <span style="color:#a6e22e">preProcess</span>(<span style="color:#a6e22e">up</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">UnpackedProposal</span>, <span style="color:#a6e22e">channel</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Channel</span>) <span style="color:#66d9ef">error</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// at first, we check whether the message is valid
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">up</span>.<span style="color:#a6e22e">Validate</span>(<span style="color:#a6e22e">channel</span>.<span style="color:#a6e22e">IdentityDeserializer</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">Metrics</span>.<span style="color:#a6e22e">ProposalValidationFailed</span>.<span style="color:#a6e22e">Add</span>(<span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">errors</span>.<span style="color:#a6e22e">WithMessage</span>(<span style="color:#a6e22e">err</span>, <span style="color:#e6db74">&#34;error validating proposal&#34;</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">up</span>.<span style="color:#a6e22e">ChannelHeader</span>.<span style="color:#a6e22e">ChannelId</span> <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;&#34;</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// chainless proposals do not/cannot affect ledger and cannot be submitted as transactions
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#75715e">// ignore uniqueness checks; also, chainless proposals are not validated using the policies
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#75715e">// of the chain since by definition there is no chain; they are validated against the local
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#75715e">// MSP of the peer instead by the call to ValidateUnpackProposal above
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// labels that provide context for failure metrics
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">meterLabels</span> <span style="color:#f92672">:=</span> []<span style="color:#66d9ef">string</span>{
</span></span><span style="display:flex;"><span>		<span style="color:#e6db74">&#34;channel&#34;</span>, <span style="color:#a6e22e">up</span>.<span style="color:#a6e22e">ChannelHeader</span>.<span style="color:#a6e22e">ChannelId</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#e6db74">&#34;chaincode&#34;</span>, <span style="color:#a6e22e">up</span>.<span style="color:#a6e22e">ChaincodeName</span>,
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// Here we handle uniqueness check and ACLs for proposals targeting a chain
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">// Notice that ValidateProposalMessage has already verified that TxID is computed properly
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">Support</span>.<span style="color:#a6e22e">GetTransactionByID</span>(<span style="color:#a6e22e">up</span>.<span style="color:#a6e22e">ChannelHeader</span>.<span style="color:#a6e22e">ChannelId</span>, <span style="color:#a6e22e">up</span>.<span style="color:#a6e22e">ChannelHeader</span>.<span style="color:#a6e22e">TxId</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// increment failure due to duplicate transactions. Useful for catching replay attacks in
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#75715e">// addition to benign retries
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">Metrics</span>.<span style="color:#a6e22e">DuplicateTxsFailure</span>.<span style="color:#a6e22e">With</span>(<span style="color:#a6e22e">meterLabels</span><span style="color:#f92672">...</span>).<span style="color:#a6e22e">Add</span>(<span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">errors</span>.<span style="color:#a6e22e">Errorf</span>(<span style="color:#e6db74">&#34;duplicate transaction found [%s]. Creator [%x]&#34;</span>, <span style="color:#a6e22e">up</span>.<span style="color:#a6e22e">ChannelHeader</span>.<span style="color:#a6e22e">TxId</span>, <span style="color:#a6e22e">up</span>.<span style="color:#a6e22e">SignatureHeader</span>.<span style="color:#a6e22e">Creator</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// check ACL only for application chaincodes; ACLs
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">// for system chaincodes are checked elsewhere
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span> !<span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">Support</span>.<span style="color:#a6e22e">IsSysCC</span>(<span style="color:#a6e22e">up</span>.<span style="color:#a6e22e">ChaincodeName</span>) {
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// check that the proposal complies with the Channel&#39;s writers
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">Support</span>.<span style="color:#a6e22e">CheckACL</span>(<span style="color:#a6e22e">up</span>.<span style="color:#a6e22e">ChannelHeader</span>.<span style="color:#a6e22e">ChannelId</span>, <span style="color:#a6e22e">up</span>.<span style="color:#a6e22e">SignedProposal</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">Metrics</span>.<span style="color:#a6e22e">ProposalACLCheckFailed</span>.<span style="color:#a6e22e">With</span>(<span style="color:#a6e22e">meterLabels</span><span style="color:#f92672">...</span>).<span style="color:#a6e22e">Add</span>(<span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// ProcessProposal process the Proposal
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">e</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Endorser</span>) <span style="color:#a6e22e">ProcessProposal</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>, <span style="color:#a6e22e">signedProp</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">pb</span>.<span style="color:#a6e22e">SignedProposal</span>) (<span style="color:#f92672">*</span><span style="color:#a6e22e">pb</span>.<span style="color:#a6e22e">ProposalResponse</span>, <span style="color:#66d9ef">error</span>) {
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// start time for computing elapsed time metric for successfully endorsed proposals
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">startTime</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Now</span>()
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">Metrics</span>.<span style="color:#a6e22e">ProposalsReceived</span>.<span style="color:#a6e22e">Add</span>(<span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">addr</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">util</span>.<span style="color:#a6e22e">ExtractRemoteAddress</span>(<span style="color:#a6e22e">ctx</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">endorserLogger</span>.<span style="color:#a6e22e">Debug</span>(<span style="color:#e6db74">&#34;request from&#34;</span>, <span style="color:#a6e22e">addr</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// variables to capture proposal duration metric
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">success</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">up</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">UnpackProposal</span>(<span style="color:#a6e22e">signedProp</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">Metrics</span>.<span style="color:#a6e22e">ProposalValidationFailed</span>.<span style="color:#a6e22e">Add</span>(<span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">pb</span>.<span style="color:#a6e22e">ProposalResponse</span>{<span style="color:#a6e22e">Response</span>: <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">pb</span>.<span style="color:#a6e22e">Response</span>{<span style="color:#a6e22e">Status</span>: <span style="color:#ae81ff">500</span>, <span style="color:#a6e22e">Message</span>: <span style="color:#a6e22e">err</span>.<span style="color:#a6e22e">Error</span>()}}, <span style="color:#a6e22e">err</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">channel</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Channel</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">up</span>.<span style="color:#a6e22e">ChannelID</span>() <span style="color:#f92672">!=</span> <span style="color:#e6db74">&#34;&#34;</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">channel</span> = <span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">ChannelFetcher</span>.<span style="color:#a6e22e">Channel</span>(<span style="color:#a6e22e">up</span>.<span style="color:#a6e22e">ChannelID</span>())
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">channel</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">return</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">pb</span>.<span style="color:#a6e22e">ProposalResponse</span>{<span style="color:#a6e22e">Response</span>: <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">pb</span>.<span style="color:#a6e22e">Response</span>{<span style="color:#a6e22e">Status</span>: <span style="color:#ae81ff">500</span>, <span style="color:#a6e22e">Message</span>: <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Sprintf</span>(<span style="color:#e6db74">&#34;channel &#39;%s&#39; not found&#34;</span>, <span style="color:#a6e22e">up</span>.<span style="color:#a6e22e">ChannelHeader</span>.<span style="color:#a6e22e">ChannelId</span>)}}, <span style="color:#66d9ef">nil</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	} <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">channel</span> = <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">Channel</span>{
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">IdentityDeserializer</span>: <span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">LocalMSP</span>,
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 0 -- check and validate
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">preProcess</span>(<span style="color:#a6e22e">up</span>, <span style="color:#a6e22e">channel</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">pb</span>.<span style="color:#a6e22e">ProposalResponse</span>{<span style="color:#a6e22e">Response</span>: <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">pb</span>.<span style="color:#a6e22e">Response</span>{<span style="color:#a6e22e">Status</span>: <span style="color:#ae81ff">500</span>, <span style="color:#a6e22e">Message</span>: <span style="color:#a6e22e">err</span>.<span style="color:#a6e22e">Error</span>()}}, <span style="color:#a6e22e">err</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">defer</span> <span style="color:#66d9ef">func</span>() {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">meterLabels</span> <span style="color:#f92672">:=</span> []<span style="color:#66d9ef">string</span>{
</span></span><span style="display:flex;"><span>			<span style="color:#e6db74">&#34;channel&#34;</span>, <span style="color:#a6e22e">up</span>.<span style="color:#a6e22e">ChannelHeader</span>.<span style="color:#a6e22e">ChannelId</span>,
</span></span><span style="display:flex;"><span>			<span style="color:#e6db74">&#34;chaincode&#34;</span>, <span style="color:#a6e22e">up</span>.<span style="color:#a6e22e">ChaincodeName</span>,
</span></span><span style="display:flex;"><span>			<span style="color:#e6db74">&#34;success&#34;</span>, <span style="color:#a6e22e">strconv</span>.<span style="color:#a6e22e">FormatBool</span>(<span style="color:#a6e22e">success</span>),
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">Metrics</span>.<span style="color:#a6e22e">ProposalDuration</span>.<span style="color:#a6e22e">With</span>(<span style="color:#a6e22e">meterLabels</span><span style="color:#f92672">...</span>).<span style="color:#a6e22e">Observe</span>(<span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Since</span>(<span style="color:#a6e22e">startTime</span>).<span style="color:#a6e22e">Seconds</span>())
</span></span><span style="display:flex;"><span>	}()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">pResp</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">ProcessProposalSuccessfullyOrError</span>(<span style="color:#a6e22e">up</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">pb</span>.<span style="color:#a6e22e">ProposalResponse</span>{<span style="color:#a6e22e">Response</span>: <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">pb</span>.<span style="color:#a6e22e">Response</span>{<span style="color:#a6e22e">Status</span>: <span style="color:#ae81ff">500</span>, <span style="color:#a6e22e">Message</span>: <span style="color:#a6e22e">err</span>.<span style="color:#a6e22e">Error</span>()}}, <span style="color:#66d9ef">nil</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">pResp</span>.<span style="color:#a6e22e">Endorsement</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> <span style="color:#f92672">||</span> <span style="color:#a6e22e">up</span>.<span style="color:#a6e22e">ChannelHeader</span>.<span style="color:#a6e22e">ChannelId</span> <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;&#34;</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// We mark the tx as successfull only if it was successfully endorsed, or
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#75715e">// if it was a system chaincode on a channel-less channel and therefore
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#75715e">// cannot be endorsed.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#a6e22e">success</span> = <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// total failed proposals = ProposalsReceived-SuccessfulProposals
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">Metrics</span>.<span style="color:#a6e22e">SuccessfulProposals</span>.<span style="color:#a6e22e">Add</span>(<span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">pResp</span>, <span style="color:#66d9ef">nil</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">e</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Endorser</span>) <span style="color:#a6e22e">ProcessProposalSuccessfullyOrError</span>(<span style="color:#a6e22e">up</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">UnpackedProposal</span>) (<span style="color:#f92672">*</span><span style="color:#a6e22e">pb</span>.<span style="color:#a6e22e">ProposalResponse</span>, <span style="color:#66d9ef">error</span>) {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">txParams</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">ccprovider</span>.<span style="color:#a6e22e">TransactionParams</span>{
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">ChannelID</span>:  <span style="color:#a6e22e">up</span>.<span style="color:#a6e22e">ChannelHeader</span>.<span style="color:#a6e22e">ChannelId</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">TxID</span>:       <span style="color:#a6e22e">up</span>.<span style="color:#a6e22e">ChannelHeader</span>.<span style="color:#a6e22e">TxId</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">SignedProp</span>: <span style="color:#a6e22e">up</span>.<span style="color:#a6e22e">SignedProposal</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">Proposal</span>:   <span style="color:#a6e22e">up</span>.<span style="color:#a6e22e">Proposal</span>,
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">logger</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">decorateLogger</span>(<span style="color:#a6e22e">endorserLogger</span>, <span style="color:#a6e22e">txParams</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">acquireTxSimulator</span>(<span style="color:#a6e22e">up</span>.<span style="color:#a6e22e">ChannelHeader</span>.<span style="color:#a6e22e">ChannelId</span>, <span style="color:#a6e22e">up</span>.<span style="color:#a6e22e">ChaincodeName</span>) {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">txSim</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">Support</span>.<span style="color:#a6e22e">GetTxSimulator</span>(<span style="color:#a6e22e">up</span>.<span style="color:#a6e22e">ChannelID</span>(), <span style="color:#a6e22e">up</span>.<span style="color:#a6e22e">TxID</span>())
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">err</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// txsim acquires a shared lock on the stateDB. As this would impact the block commits (i.e., commit
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#75715e">// of valid write-sets to the stateDB), we must release the lock as early as possible.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#75715e">// Hence, this txsim object is closed in simulateProposal() as soon as the tx is simulated and
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#75715e">// rwset is collected before gossip dissemination if required for privateData. For safety, we
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#75715e">// add the following defer statement and is useful when an error occur. Note that calling
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#75715e">// txsim.Done() more than once does not cause any issue. If the txsim is already
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#75715e">// released, the following txsim.Done() simply returns.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">txSim</span>.<span style="color:#a6e22e">Done</span>()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">hqe</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">Support</span>.<span style="color:#a6e22e">GetHistoryQueryExecutor</span>(<span style="color:#a6e22e">up</span>.<span style="color:#a6e22e">ChannelID</span>())
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">err</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">txParams</span>.<span style="color:#a6e22e">TXSimulator</span> = <span style="color:#a6e22e">txSim</span>
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">txParams</span>.<span style="color:#a6e22e">HistoryQueryExecutor</span> = <span style="color:#a6e22e">hqe</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">cdLedger</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">Support</span>.<span style="color:#a6e22e">ChaincodeEndorsementInfo</span>(<span style="color:#a6e22e">up</span>.<span style="color:#a6e22e">ChannelID</span>(), <span style="color:#a6e22e">up</span>.<span style="color:#a6e22e">ChaincodeName</span>, <span style="color:#a6e22e">txParams</span>.<span style="color:#a6e22e">TXSimulator</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">errors</span>.<span style="color:#a6e22e">WithMessagef</span>(<span style="color:#a6e22e">err</span>, <span style="color:#e6db74">&#34;make sure the chaincode %s has been successfully defined on channel %s and try again&#34;</span>, <span style="color:#a6e22e">up</span>.<span style="color:#a6e22e">ChaincodeName</span>, <span style="color:#a6e22e">up</span>.<span style="color:#a6e22e">ChannelID</span>())
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 1 -- simulate
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">res</span>, <span style="color:#a6e22e">simulationResult</span>, <span style="color:#a6e22e">ccevent</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">SimulateProposal</span>(<span style="color:#a6e22e">txParams</span>, <span style="color:#a6e22e">up</span>.<span style="color:#a6e22e">ChaincodeName</span>, <span style="color:#a6e22e">up</span>.<span style="color:#a6e22e">Input</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">errors</span>.<span style="color:#a6e22e">WithMessage</span>(<span style="color:#a6e22e">err</span>, <span style="color:#e6db74">&#34;error in simulation&#34;</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">cceventBytes</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">CreateCCEventBytes</span>(<span style="color:#a6e22e">ccevent</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">errors</span>.<span style="color:#a6e22e">Wrap</span>(<span style="color:#a6e22e">err</span>, <span style="color:#e6db74">&#34;failed to marshal chaincode event&#34;</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">prpBytes</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">protoutil</span>.<span style="color:#a6e22e">GetBytesProposalResponsePayload</span>(<span style="color:#a6e22e">up</span>.<span style="color:#a6e22e">ProposalHash</span>, <span style="color:#a6e22e">res</span>, <span style="color:#a6e22e">simulationResult</span>, <span style="color:#a6e22e">cceventBytes</span>, <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">pb</span>.<span style="color:#a6e22e">ChaincodeID</span>{
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">Name</span>:    <span style="color:#a6e22e">up</span>.<span style="color:#a6e22e">ChaincodeName</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">Version</span>: <span style="color:#a6e22e">cdLedger</span>.<span style="color:#a6e22e">Version</span>,
</span></span><span style="display:flex;"><span>	})
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">logger</span>.<span style="color:#a6e22e">Warning</span>(<span style="color:#e6db74">&#34;Failed marshaling the proposal response payload to bytes&#34;</span>, <span style="color:#a6e22e">err</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">errors</span>.<span style="color:#a6e22e">WithMessage</span>(<span style="color:#a6e22e">err</span>, <span style="color:#e6db74">&#34;failed to create the proposal response&#34;</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// if error, capture endorsement failure metric
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">meterLabels</span> <span style="color:#f92672">:=</span> []<span style="color:#66d9ef">string</span>{
</span></span><span style="display:flex;"><span>		<span style="color:#e6db74">&#34;channel&#34;</span>, <span style="color:#a6e22e">up</span>.<span style="color:#a6e22e">ChannelID</span>(),
</span></span><span style="display:flex;"><span>		<span style="color:#e6db74">&#34;chaincode&#34;</span>, <span style="color:#a6e22e">up</span>.<span style="color:#a6e22e">ChaincodeName</span>,
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">switch</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">case</span> <span style="color:#a6e22e">res</span>.<span style="color:#a6e22e">Status</span> <span style="color:#f92672">&gt;=</span> <span style="color:#a6e22e">shim</span>.<span style="color:#a6e22e">ERROR</span>:
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">pb</span>.<span style="color:#a6e22e">ProposalResponse</span>{
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">Response</span>: <span style="color:#a6e22e">res</span>,
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">Payload</span>:  <span style="color:#a6e22e">prpBytes</span>,
</span></span><span style="display:flex;"><span>		}, <span style="color:#66d9ef">nil</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">case</span> <span style="color:#a6e22e">up</span>.<span style="color:#a6e22e">ChannelID</span>() <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;&#34;</span>:
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// Chaincode invocations without a channel ID is a broken concept
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#75715e">// that should be removed in the future.  For now, return unendorsed
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#75715e">// success.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#66d9ef">return</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">pb</span>.<span style="color:#a6e22e">ProposalResponse</span>{
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">Response</span>: <span style="color:#a6e22e">res</span>,
</span></span><span style="display:flex;"><span>		}, <span style="color:#66d9ef">nil</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">case</span> <span style="color:#a6e22e">res</span>.<span style="color:#a6e22e">Status</span> <span style="color:#f92672">&gt;=</span> <span style="color:#a6e22e">shim</span>.<span style="color:#a6e22e">ERRORTHRESHOLD</span>:
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">meterLabels</span> = append(<span style="color:#a6e22e">meterLabels</span>, <span style="color:#e6db74">&#34;chaincodeerror&#34;</span>, <span style="color:#a6e22e">strconv</span>.<span style="color:#a6e22e">FormatBool</span>(<span style="color:#66d9ef">true</span>))
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">Metrics</span>.<span style="color:#a6e22e">EndorsementsFailed</span>.<span style="color:#a6e22e">With</span>(<span style="color:#a6e22e">meterLabels</span><span style="color:#f92672">...</span>).<span style="color:#a6e22e">Add</span>(<span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">logger</span>.<span style="color:#a6e22e">Debugf</span>(<span style="color:#e6db74">&#34;chaincode error %d&#34;</span>, <span style="color:#a6e22e">res</span>.<span style="color:#a6e22e">Status</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">pb</span>.<span style="color:#a6e22e">ProposalResponse</span>{
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">Response</span>: <span style="color:#a6e22e">res</span>,
</span></span><span style="display:flex;"><span>		}, <span style="color:#66d9ef">nil</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">escc</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">cdLedger</span>.<span style="color:#a6e22e">EndorsementPlugin</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">logger</span>.<span style="color:#a6e22e">Debugf</span>(<span style="color:#e6db74">&#34;escc for chaincode %s is %s&#34;</span>, <span style="color:#a6e22e">up</span>.<span style="color:#a6e22e">ChaincodeName</span>, <span style="color:#a6e22e">escc</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// Note, mPrpBytes is the same as prpBytes by default endorsement plugin, but others could change it.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">endorsement</span>, <span style="color:#a6e22e">mPrpBytes</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">Support</span>.<span style="color:#a6e22e">EndorseWithPlugin</span>(<span style="color:#a6e22e">escc</span>, <span style="color:#a6e22e">up</span>.<span style="color:#a6e22e">ChannelID</span>(), <span style="color:#a6e22e">prpBytes</span>, <span style="color:#a6e22e">up</span>.<span style="color:#a6e22e">SignedProposal</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">meterLabels</span> = append(<span style="color:#a6e22e">meterLabels</span>, <span style="color:#e6db74">&#34;chaincodeerror&#34;</span>, <span style="color:#a6e22e">strconv</span>.<span style="color:#a6e22e">FormatBool</span>(<span style="color:#66d9ef">false</span>))
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">Metrics</span>.<span style="color:#a6e22e">EndorsementsFailed</span>.<span style="color:#a6e22e">With</span>(<span style="color:#a6e22e">meterLabels</span><span style="color:#f92672">...</span>).<span style="color:#a6e22e">Add</span>(<span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">errors</span>.<span style="color:#a6e22e">WithMessage</span>(<span style="color:#a6e22e">err</span>, <span style="color:#e6db74">&#34;endorsing with plugin failed&#34;</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">pb</span>.<span style="color:#a6e22e">ProposalResponse</span>{
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">Version</span>:     <span style="color:#ae81ff">1</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">Endorsement</span>: <span style="color:#a6e22e">endorsement</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">Payload</span>:     <span style="color:#a6e22e">mPrpBytes</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">Response</span>:    <span style="color:#a6e22e">res</span>,
</span></span><span style="display:flex;"><span>	}, <span style="color:#66d9ef">nil</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// determine whether or not a transaction simulator should be
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// obtained for a proposal.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">acquireTxSimulator</span>(<span style="color:#a6e22e">chainID</span> <span style="color:#66d9ef">string</span>, <span style="color:#a6e22e">chaincodeName</span> <span style="color:#66d9ef">string</span>) <span style="color:#66d9ef">bool</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">chainID</span> <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;&#34;</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// ¯\_(ツ)_/¯ locking.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">// Don&#39;t get a simulator for the query and config system chaincode.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">// These don&#39;t need the simulator and its read lock results in deadlocks.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">switch</span> <span style="color:#a6e22e">chaincodeName</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">case</span> <span style="color:#e6db74">&#34;qscc&#34;</span>, <span style="color:#e6db74">&#34;cscc&#34;</span>:
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">default</span>:
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// shorttxid replicates the chaincode package function to shorten txids.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// ~~TODO utilize a common shorttxid utility across packages.~~
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// TODO use a formal type for transaction ID and make it a stringer
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">shorttxid</span>(<span style="color:#a6e22e">txid</span> <span style="color:#66d9ef">string</span>) <span style="color:#66d9ef">string</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> len(<span style="color:#a6e22e">txid</span>) &lt; <span style="color:#ae81ff">8</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">txid</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">txid</span>[<span style="color:#ae81ff">0</span>:<span style="color:#ae81ff">8</span>]
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">CreateCCEventBytes</span>(<span style="color:#a6e22e">ccevent</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">pb</span>.<span style="color:#a6e22e">ChaincodeEvent</span>) ([]<span style="color:#66d9ef">byte</span>, <span style="color:#66d9ef">error</span>) {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">ccevent</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#66d9ef">nil</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">proto</span>.<span style="color:#a6e22e">Marshal</span>(<span style="color:#a6e22e">ccevent</span>)
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">decorateLogger</span>(<span style="color:#a6e22e">logger</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">flogging</span>.<span style="color:#a6e22e">FabricLogger</span>, <span style="color:#a6e22e">txParams</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">ccprovider</span>.<span style="color:#a6e22e">TransactionParams</span>) <span style="color:#f92672">*</span><span style="color:#a6e22e">flogging</span>.<span style="color:#a6e22e">FabricLogger</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">logger</span>.<span style="color:#a6e22e">With</span>(<span style="color:#e6db74">&#34;channel&#34;</span>, <span style="color:#a6e22e">txParams</span>.<span style="color:#a6e22e">ChannelID</span>, <span style="color:#e6db74">&#34;txID&#34;</span>, <span style="color:#a6e22e">shorttxid</span>(<span style="color:#a6e22e">txParams</span>.<span style="color:#a6e22e">TxID</span>))
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="验证系统链码-validator-system-chaincode-vscc">验证系统链码 (<em>Validator System Chaincode</em>, VSCC)</h3>
<blockquote>
<p>/core/committer/txvalidator/v14/vscc_validator.go</p>
</blockquote>
<p>被记账节点(validator)调用，根据合约的背书政策验证交易的有效性和背书的正确性。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#a6e22e">txvalidator</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> (
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;github.com/golang/protobuf/proto&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;github.com/hyperledger/fabric-protos-go/common&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;github.com/hyperledger/fabric-protos-go/peer&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">commonerrors</span> <span style="color:#e6db74">&#34;github.com/hyperledger/fabric/common/errors&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;github.com/hyperledger/fabric/common/policydsl&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;github.com/hyperledger/fabric/core/common/ccprovider&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;github.com/hyperledger/fabric/core/common/sysccprovider&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">validation</span> <span style="color:#e6db74">&#34;github.com/hyperledger/fabric/core/handlers/validation/api&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;github.com/hyperledger/fabric/core/ledger/kvledger/txmgmt/rwsetutil&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;github.com/hyperledger/fabric/protoutil&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;github.com/pkg/errors&#34;</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// VsccValidatorImpl is the implementation used to call
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// the vscc chaincode and validate block transactions
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">VsccValidatorImpl</span> <span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">channelID</span>       <span style="color:#66d9ef">string</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">cr</span>              <span style="color:#a6e22e">ChannelResources</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">pluginValidator</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">PluginValidator</span>
</span></span><span style="display:flex;"><span>} <span style="color:#75715e">// 用于调用vscc链码并验证区块事务
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// newVSCCValidator creates new vscc validator
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">newVSCCValidator</span>(<span style="color:#a6e22e">channelID</span> <span style="color:#66d9ef">string</span>, <span style="color:#a6e22e">cr</span> <span style="color:#a6e22e">ChannelResources</span>, <span style="color:#a6e22e">pluginValidator</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">PluginValidator</span>) <span style="color:#f92672">*</span><span style="color:#a6e22e">VsccValidatorImpl</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">VsccValidatorImpl</span>{
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">channelID</span>:       <span style="color:#a6e22e">channelID</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">cr</span>:              <span style="color:#a6e22e">cr</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">pluginValidator</span>: <span style="color:#a6e22e">pluginValidator</span>,
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">getChaincodeHeaderExtension</span>(<span style="color:#a6e22e">hdr</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">common</span>.<span style="color:#a6e22e">Header</span>) (<span style="color:#f92672">*</span><span style="color:#a6e22e">peer</span>.<span style="color:#a6e22e">ChaincodeHeaderExtension</span>, <span style="color:#66d9ef">error</span>) {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">chdr</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">protoutil</span>.<span style="color:#a6e22e">UnmarshalChannelHeader</span>(<span style="color:#a6e22e">hdr</span>.<span style="color:#a6e22e">ChannelHeader</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">err</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">chaincodeHdrExt</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">peer</span>.<span style="color:#a6e22e">ChaincodeHeaderExtension</span>{}
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">proto</span>.<span style="color:#a6e22e">Unmarshal</span>(<span style="color:#a6e22e">chdr</span>.<span style="color:#a6e22e">Extension</span>, <span style="color:#a6e22e">chaincodeHdrExt</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">chaincodeHdrExt</span>, <span style="color:#a6e22e">errors</span>.<span style="color:#a6e22e">Wrap</span>(<span style="color:#a6e22e">err</span>, <span style="color:#e6db74">&#34;error unmarshaling ChaincodeHeaderExtension&#34;</span>)
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// VSCCValidateTx executes vscc validation for transaction
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">v</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">VsccValidatorImpl</span>) <span style="color:#a6e22e">VSCCValidateTx</span>(<span style="color:#a6e22e">seq</span> <span style="color:#66d9ef">int</span>, <span style="color:#a6e22e">payload</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">common</span>.<span style="color:#a6e22e">Payload</span>, <span style="color:#a6e22e">envBytes</span> []<span style="color:#66d9ef">byte</span>, <span style="color:#a6e22e">block</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">common</span>.<span style="color:#a6e22e">Block</span>) (<span style="color:#66d9ef">error</span>, <span style="color:#a6e22e">peer</span>.<span style="color:#a6e22e">TxValidationCode</span>) {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">chainID</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">v</span>.<span style="color:#a6e22e">channelID</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">logger</span>.<span style="color:#a6e22e">Debugf</span>(<span style="color:#e6db74">&#34;[%s] VSCCValidateTx starts for bytes %p&#34;</span>, <span style="color:#a6e22e">chainID</span>, <span style="color:#a6e22e">envBytes</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// get header extensions so we have the chaincode ID
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">hdrExt</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">getChaincodeHeaderExtension</span>(<span style="color:#a6e22e">payload</span>.<span style="color:#a6e22e">Header</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>, <span style="color:#a6e22e">peer</span>.<span style="color:#a6e22e">TxValidationCode_BAD_HEADER_EXTENSION</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// get channel header
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">chdr</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">protoutil</span>.<span style="color:#a6e22e">UnmarshalChannelHeader</span>(<span style="color:#a6e22e">payload</span>.<span style="color:#a6e22e">Header</span>.<span style="color:#a6e22e">ChannelHeader</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>, <span style="color:#a6e22e">peer</span>.<span style="color:#a6e22e">TxValidationCode_BAD_CHANNEL_HEADER</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">/* obtain the list of namespaces we&#39;re writing stuff to;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">	   at first, we establish a few facts about this invocation:
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">	   1) which namespaces does it write to?
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">	   2) does it write to LSCC&#39;s namespace?
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">	   3) does it write to any cc that cannot be invoked? */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">writesToLSCC</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">writesToNonInvokableSCC</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">respPayload</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">protoutil</span>.<span style="color:#a6e22e">GetActionFromEnvelope</span>(<span style="color:#a6e22e">envBytes</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">errors</span>.<span style="color:#a6e22e">WithMessage</span>(<span style="color:#a6e22e">err</span>, <span style="color:#e6db74">&#34;GetActionFromEnvelope failed&#34;</span>), <span style="color:#a6e22e">peer</span>.<span style="color:#a6e22e">TxValidationCode_BAD_RESPONSE_PAYLOAD</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">txRWSet</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">rwsetutil</span>.<span style="color:#a6e22e">TxRwSet</span>{}
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">txRWSet</span>.<span style="color:#a6e22e">FromProtoBytes</span>(<span style="color:#a6e22e">respPayload</span>.<span style="color:#a6e22e">Results</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">errors</span>.<span style="color:#a6e22e">WithMessage</span>(<span style="color:#a6e22e">err</span>, <span style="color:#e6db74">&#34;txRWSet.FromProtoBytes failed&#34;</span>), <span style="color:#a6e22e">peer</span>.<span style="color:#a6e22e">TxValidationCode_BAD_RWSET</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// Verify the header extension and response payload contain the ChaincodeId
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">hdrExt</span>.<span style="color:#a6e22e">ChaincodeId</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">errors</span>.<span style="color:#a6e22e">New</span>(<span style="color:#e6db74">&#34;nil ChaincodeId in header extension&#34;</span>), <span style="color:#a6e22e">peer</span>.<span style="color:#a6e22e">TxValidationCode_INVALID_OTHER_REASON</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">respPayload</span>.<span style="color:#a6e22e">ChaincodeId</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">errors</span>.<span style="color:#a6e22e">New</span>(<span style="color:#e6db74">&#34;nil ChaincodeId in ChaincodeAction&#34;</span>), <span style="color:#a6e22e">peer</span>.<span style="color:#a6e22e">TxValidationCode_INVALID_OTHER_REASON</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// get name and version of the cc we invoked
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">ccID</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">hdrExt</span>.<span style="color:#a6e22e">ChaincodeId</span>.<span style="color:#a6e22e">Name</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">ccVer</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">respPayload</span>.<span style="color:#a6e22e">ChaincodeId</span>.<span style="color:#a6e22e">Version</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// sanity check on ccID
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">ccID</span> <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;&#34;</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">errors</span>.<span style="color:#a6e22e">New</span>(<span style="color:#e6db74">&#34;invalid chaincode ID&#34;</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">logger</span>.<span style="color:#a6e22e">Errorf</span>(<span style="color:#e6db74">&#34;%+v&#34;</span>, <span style="color:#a6e22e">err</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>, <span style="color:#a6e22e">peer</span>.<span style="color:#a6e22e">TxValidationCode_INVALID_OTHER_REASON</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">ccID</span> <span style="color:#f92672">!=</span> <span style="color:#a6e22e">respPayload</span>.<span style="color:#a6e22e">ChaincodeId</span>.<span style="color:#a6e22e">Name</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">errors</span>.<span style="color:#a6e22e">Errorf</span>(<span style="color:#e6db74">&#34;inconsistent ccid info (%s/%s)&#34;</span>, <span style="color:#a6e22e">ccID</span>, <span style="color:#a6e22e">respPayload</span>.<span style="color:#a6e22e">ChaincodeId</span>.<span style="color:#a6e22e">Name</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">logger</span>.<span style="color:#a6e22e">Errorf</span>(<span style="color:#e6db74">&#34;%+v&#34;</span>, <span style="color:#a6e22e">err</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>, <span style="color:#a6e22e">peer</span>.<span style="color:#a6e22e">TxValidationCode_INVALID_OTHER_REASON</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// sanity check on ccver
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">ccVer</span> <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;&#34;</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">errors</span>.<span style="color:#a6e22e">New</span>(<span style="color:#e6db74">&#34;invalid chaincode version&#34;</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">logger</span>.<span style="color:#a6e22e">Errorf</span>(<span style="color:#e6db74">&#34;%+v&#34;</span>, <span style="color:#a6e22e">err</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>, <span style="color:#a6e22e">peer</span>.<span style="color:#a6e22e">TxValidationCode_INVALID_OTHER_REASON</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">wrNamespace</span> []<span style="color:#66d9ef">string</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">alwaysEnforceOriginalNamespace</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">v</span>.<span style="color:#a6e22e">cr</span>.<span style="color:#a6e22e">Capabilities</span>().<span style="color:#a6e22e">V1_2Validation</span>()
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">alwaysEnforceOriginalNamespace</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">wrNamespace</span> = append(<span style="color:#a6e22e">wrNamespace</span>, <span style="color:#a6e22e">ccID</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">respPayload</span>.<span style="color:#a6e22e">Events</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">ccEvent</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">peer</span>.<span style="color:#a6e22e">ChaincodeEvent</span>{}
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">proto</span>.<span style="color:#a6e22e">Unmarshal</span>(<span style="color:#a6e22e">respPayload</span>.<span style="color:#a6e22e">Events</span>, <span style="color:#a6e22e">ccEvent</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>				<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">errors</span>.<span style="color:#a6e22e">Wrapf</span>(<span style="color:#a6e22e">err</span>, <span style="color:#e6db74">&#34;invalid chaincode event&#34;</span>), <span style="color:#a6e22e">peer</span>.<span style="color:#a6e22e">TxValidationCode_INVALID_OTHER_REASON</span>
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">ccEvent</span>.<span style="color:#a6e22e">ChaincodeId</span> <span style="color:#f92672">!=</span> <span style="color:#a6e22e">ccID</span> {
</span></span><span style="display:flex;"><span>				<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">errors</span>.<span style="color:#a6e22e">Errorf</span>(<span style="color:#e6db74">&#34;chaincode event chaincode id does not match chaincode action chaincode id&#34;</span>), <span style="color:#a6e22e">peer</span>.<span style="color:#a6e22e">TxValidationCode_INVALID_OTHER_REASON</span>
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">namespaces</span> <span style="color:#f92672">:=</span> make(<span style="color:#66d9ef">map</span>[<span style="color:#66d9ef">string</span>]<span style="color:#66d9ef">struct</span>{})
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">ns</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">txRWSet</span>.<span style="color:#a6e22e">NsRwSets</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// check to make sure there is no duplicate namespace in txRWSet
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">ok</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">namespaces</span>[<span style="color:#a6e22e">ns</span>.<span style="color:#a6e22e">NameSpace</span>]; <span style="color:#a6e22e">ok</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">errors</span>.<span style="color:#a6e22e">Errorf</span>(<span style="color:#e6db74">&#34;duplicate namespace &#39;%s&#39; in txRWSet&#34;</span>, <span style="color:#a6e22e">ns</span>.<span style="color:#a6e22e">NameSpace</span>),
</span></span><span style="display:flex;"><span>				<span style="color:#a6e22e">peer</span>.<span style="color:#a6e22e">TxValidationCode_ILLEGAL_WRITESET</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">namespaces</span>[<span style="color:#a6e22e">ns</span>.<span style="color:#a6e22e">NameSpace</span>] = <span style="color:#66d9ef">struct</span>{}{}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> !<span style="color:#a6e22e">v</span>.<span style="color:#a6e22e">txWritesToNamespace</span>(<span style="color:#a6e22e">ns</span>) {
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">continue</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// Check to make sure we did not already populate this chaincode
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#75715e">// name to avoid checking the same namespace twice
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">ns</span>.<span style="color:#a6e22e">NameSpace</span> <span style="color:#f92672">!=</span> <span style="color:#a6e22e">ccID</span> <span style="color:#f92672">||</span> !<span style="color:#a6e22e">alwaysEnforceOriginalNamespace</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">wrNamespace</span> = append(<span style="color:#a6e22e">wrNamespace</span>, <span style="color:#a6e22e">ns</span>.<span style="color:#a6e22e">NameSpace</span>)
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> !<span style="color:#a6e22e">writesToLSCC</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">ns</span>.<span style="color:#a6e22e">NameSpace</span> <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;lscc&#34;</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">writesToLSCC</span> = <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> !<span style="color:#a6e22e">writesToNonInvokableSCC</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">IsSysCCAndNotInvokableCC2CC</span>(<span style="color:#a6e22e">ns</span>.<span style="color:#a6e22e">NameSpace</span>) {
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">writesToNonInvokableSCC</span> = <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> !<span style="color:#a6e22e">writesToNonInvokableSCC</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">IsSysCCAndNotInvokableExternal</span>(<span style="color:#a6e22e">ns</span>.<span style="color:#a6e22e">NameSpace</span>) {
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">writesToNonInvokableSCC</span> = <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// we&#39;ve gathered all the info required to proceed to validation;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">// validation will behave differently depending on the type of
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">// chaincode (system vs. application)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> !<span style="color:#a6e22e">IsSysCC</span>(<span style="color:#a6e22e">ccID</span>) {
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// if we&#39;re here, we know this is an invocation of an application chaincode;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#75715e">// first of all, we make sure that:
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#75715e">// 1) we don&#39;t write to LSCC - an application chaincode is free to invoke LSCC
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#75715e">//    for instance to get information about itself or another chaincode; however
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#75715e">//    these legitimate invocations only ready from LSCC&#39;s namespace; currently
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#75715e">//    only two functions of LSCC write to its namespace: deploy and upgrade and
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#75715e">//    neither should be used by an application chaincode
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">writesToLSCC</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">errors</span>.<span style="color:#a6e22e">Errorf</span>(<span style="color:#e6db74">&#34;chaincode %s attempted to write to the namespace of LSCC&#34;</span>, <span style="color:#a6e22e">ccID</span>),
</span></span><span style="display:flex;"><span>				<span style="color:#a6e22e">peer</span>.<span style="color:#a6e22e">TxValidationCode_ILLEGAL_WRITESET</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 2) we don&#39;t write to the namespace of a chaincode that we cannot invoke - if
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#75715e">//    the chaincode cannot be invoked in the first place, there&#39;s no legitimate
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#75715e">//    way in which a transaction has a write set that writes to it; additionally
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#75715e">//    we don&#39;t have any means of verifying whether the transaction had the rights
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#75715e">//    to perform that write operation because in v1, system chaincodes do not have
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#75715e">//    any endorsement policies to speak of. So if the chaincode can&#39;t be invoked
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#75715e">//    it can&#39;t be written to by an invocation of an application chaincode
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">writesToNonInvokableSCC</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">errors</span>.<span style="color:#a6e22e">Errorf</span>(<span style="color:#e6db74">&#34;chaincode %s attempted to write to the namespace of a system chaincode that cannot be invoked&#34;</span>, <span style="color:#a6e22e">ccID</span>),
</span></span><span style="display:flex;"><span>				<span style="color:#a6e22e">peer</span>.<span style="color:#a6e22e">TxValidationCode_ILLEGAL_WRITESET</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// validate *EACH* read write set according to its chaincode&#39;s endorsement policy
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">ns</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">wrNamespace</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// Get latest chaincode version, vscc and validate policy
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>			<span style="color:#a6e22e">txcc</span>, <span style="color:#a6e22e">vscc</span>, <span style="color:#a6e22e">policy</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">v</span>.<span style="color:#a6e22e">GetInfoForValidate</span>(<span style="color:#a6e22e">chdr</span>, <span style="color:#a6e22e">ns</span>)
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>				<span style="color:#a6e22e">logger</span>.<span style="color:#a6e22e">Errorf</span>(<span style="color:#e6db74">&#34;GetInfoForValidate for txId = %s returned error: %+v&#34;</span>, <span style="color:#a6e22e">chdr</span>.<span style="color:#a6e22e">TxId</span>, <span style="color:#a6e22e">err</span>)
</span></span><span style="display:flex;"><span>				<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>, <span style="color:#a6e22e">peer</span>.<span style="color:#a6e22e">TxValidationCode_INVALID_OTHER_REASON</span>
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// if the namespace corresponds to the cc that was originally
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>			<span style="color:#75715e">// invoked, we check that the version of the cc that was
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>			<span style="color:#75715e">// invoked corresponds to the version that lscc has returned
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>			<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">ns</span> <span style="color:#f92672">==</span> <span style="color:#a6e22e">ccID</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">txcc</span>.<span style="color:#a6e22e">ChaincodeVersion</span> <span style="color:#f92672">!=</span> <span style="color:#a6e22e">ccVer</span> {
</span></span><span style="display:flex;"><span>				<span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">errors</span>.<span style="color:#a6e22e">Errorf</span>(<span style="color:#e6db74">&#34;chaincode %s:%s/%s didn&#39;t match %s:%s/%s in lscc&#34;</span>, <span style="color:#a6e22e">ccID</span>, <span style="color:#a6e22e">ccVer</span>, <span style="color:#a6e22e">chdr</span>.<span style="color:#a6e22e">ChannelId</span>, <span style="color:#a6e22e">txcc</span>.<span style="color:#a6e22e">ChaincodeName</span>, <span style="color:#a6e22e">txcc</span>.<span style="color:#a6e22e">ChaincodeVersion</span>, <span style="color:#a6e22e">chdr</span>.<span style="color:#a6e22e">ChannelId</span>)
</span></span><span style="display:flex;"><span>				<span style="color:#a6e22e">logger</span>.<span style="color:#a6e22e">Errorf</span>(<span style="color:#e6db74">&#34;%+v&#34;</span>, <span style="color:#a6e22e">err</span>)
</span></span><span style="display:flex;"><span>				<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>, <span style="color:#a6e22e">peer</span>.<span style="color:#a6e22e">TxValidationCode_EXPIRED_CHAINCODE</span>
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// do VSCC validation
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>			<span style="color:#a6e22e">ctx</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">Context</span>{
</span></span><span style="display:flex;"><span>				<span style="color:#a6e22e">Seq</span>:       <span style="color:#a6e22e">seq</span>,
</span></span><span style="display:flex;"><span>				<span style="color:#a6e22e">Envelope</span>:  <span style="color:#a6e22e">envBytes</span>,
</span></span><span style="display:flex;"><span>				<span style="color:#a6e22e">Block</span>:     <span style="color:#a6e22e">block</span>,
</span></span><span style="display:flex;"><span>				<span style="color:#a6e22e">TxID</span>:      <span style="color:#a6e22e">chdr</span>.<span style="color:#a6e22e">TxId</span>,
</span></span><span style="display:flex;"><span>				<span style="color:#a6e22e">Channel</span>:   <span style="color:#a6e22e">chdr</span>.<span style="color:#a6e22e">ChannelId</span>,
</span></span><span style="display:flex;"><span>				<span style="color:#a6e22e">Namespace</span>: <span style="color:#a6e22e">ns</span>,
</span></span><span style="display:flex;"><span>				<span style="color:#a6e22e">Policy</span>:    <span style="color:#a6e22e">policy</span>,
</span></span><span style="display:flex;"><span>				<span style="color:#a6e22e">VSCCName</span>:  <span style="color:#a6e22e">vscc</span>.<span style="color:#a6e22e">ChaincodeName</span>,
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">v</span>.<span style="color:#a6e22e">VSCCValidateTxForCC</span>(<span style="color:#a6e22e">ctx</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>				<span style="color:#66d9ef">switch</span> <span style="color:#a6e22e">err</span>.(<span style="color:#66d9ef">type</span>) {
</span></span><span style="display:flex;"><span>				<span style="color:#66d9ef">case</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">commonerrors</span>.<span style="color:#a6e22e">VSCCEndorsementPolicyError</span>:
</span></span><span style="display:flex;"><span>					<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>, <span style="color:#a6e22e">peer</span>.<span style="color:#a6e22e">TxValidationCode_ENDORSEMENT_POLICY_FAILURE</span>
</span></span><span style="display:flex;"><span>				<span style="color:#66d9ef">default</span>:
</span></span><span style="display:flex;"><span>					<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>, <span style="color:#a6e22e">peer</span>.<span style="color:#a6e22e">TxValidationCode_INVALID_OTHER_REASON</span>
</span></span><span style="display:flex;"><span>				}
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	} <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// make sure that we can invoke this system chaincode - if the chaincode
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#75715e">// cannot be invoked through a proposal to this peer, we have to drop the
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#75715e">// transaction; if we didn&#39;t, we wouldn&#39;t know how to decide whether it&#39;s
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#75715e">// valid or not because in v1, system chaincodes have no endorsement policy
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">IsSysCCAndNotInvokableExternal</span>(<span style="color:#a6e22e">ccID</span>) {
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">errors</span>.<span style="color:#a6e22e">Errorf</span>(<span style="color:#e6db74">&#34;committing an invocation of cc %s is illegal&#34;</span>, <span style="color:#a6e22e">ccID</span>),
</span></span><span style="display:flex;"><span>				<span style="color:#a6e22e">peer</span>.<span style="color:#a6e22e">TxValidationCode_ILLEGAL_WRITESET</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// Get latest chaincode version, vscc and validate policy
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">vscc</span>, <span style="color:#a6e22e">policy</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">v</span>.<span style="color:#a6e22e">GetInfoForValidate</span>(<span style="color:#a6e22e">chdr</span>, <span style="color:#a6e22e">ccID</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">logger</span>.<span style="color:#a6e22e">Errorf</span>(<span style="color:#e6db74">&#34;GetInfoForValidate for txId = %s returned error: %+v&#34;</span>, <span style="color:#a6e22e">chdr</span>.<span style="color:#a6e22e">TxId</span>, <span style="color:#a6e22e">err</span>)
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>, <span style="color:#a6e22e">peer</span>.<span style="color:#a6e22e">TxValidationCode_INVALID_OTHER_REASON</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// validate the transaction as an invocation of this system chaincode;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#75715e">// vscc will have to do custom validation for this system chaincode
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#75715e">// currently, VSCC does custom validation for LSCC only; if an hlf
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#75715e">// user creates a new system chaincode which is invokable from the outside
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#75715e">// they have to modify VSCC to provide appropriate validation
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#a6e22e">ctx</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">Context</span>{
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">Seq</span>:       <span style="color:#a6e22e">seq</span>,
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">Envelope</span>:  <span style="color:#a6e22e">envBytes</span>,
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">Block</span>:     <span style="color:#a6e22e">block</span>,
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">TxID</span>:      <span style="color:#a6e22e">chdr</span>.<span style="color:#a6e22e">TxId</span>,
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">Channel</span>:   <span style="color:#a6e22e">chdr</span>.<span style="color:#a6e22e">ChannelId</span>,
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">Namespace</span>: <span style="color:#a6e22e">ccID</span>,
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">Policy</span>:    <span style="color:#a6e22e">policy</span>,
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">VSCCName</span>:  <span style="color:#a6e22e">vscc</span>.<span style="color:#a6e22e">ChaincodeName</span>,
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">v</span>.<span style="color:#a6e22e">VSCCValidateTxForCC</span>(<span style="color:#a6e22e">ctx</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">switch</span> <span style="color:#a6e22e">err</span>.(<span style="color:#66d9ef">type</span>) {
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">case</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">commonerrors</span>.<span style="color:#a6e22e">VSCCEndorsementPolicyError</span>:
</span></span><span style="display:flex;"><span>				<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>, <span style="color:#a6e22e">peer</span>.<span style="color:#a6e22e">TxValidationCode_ENDORSEMENT_POLICY_FAILURE</span>
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">default</span>:
</span></span><span style="display:flex;"><span>				<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>, <span style="color:#a6e22e">peer</span>.<span style="color:#a6e22e">TxValidationCode_INVALID_OTHER_REASON</span>
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">logger</span>.<span style="color:#a6e22e">Debugf</span>(<span style="color:#e6db74">&#34;[%s] VSCCValidateTx completes env bytes %p&#34;</span>, <span style="color:#a6e22e">chainID</span>, <span style="color:#a6e22e">envBytes</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">peer</span>.<span style="color:#a6e22e">TxValidationCode_VALID</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">v</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">VsccValidatorImpl</span>) <span style="color:#a6e22e">VSCCValidateTxForCC</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Context</span>) <span style="color:#66d9ef">error</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">logger</span>.<span style="color:#a6e22e">Debug</span>(<span style="color:#e6db74">&#34;Validating&#34;</span>, <span style="color:#a6e22e">ctx</span>, <span style="color:#e6db74">&#34;with plugin&#34;</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">v</span>.<span style="color:#a6e22e">pluginValidator</span>.<span style="color:#a6e22e">ValidateWithPlugin</span>(<span style="color:#a6e22e">ctx</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// If the error is a pluggable validation execution error, cast it to the common errors ExecutionFailureError.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">e</span>, <span style="color:#a6e22e">isExecutionError</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">err</span>.(<span style="color:#f92672">*</span><span style="color:#a6e22e">validation</span>.<span style="color:#a6e22e">ExecutionFailureError</span>); <span style="color:#a6e22e">isExecutionError</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">commonerrors</span>.<span style="color:#a6e22e">VSCCExecutionFailureError</span>{<span style="color:#a6e22e">Err</span>: <span style="color:#a6e22e">e</span>}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// Else, treat it as an endorsement error.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">return</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">commonerrors</span>.<span style="color:#a6e22e">VSCCEndorsementPolicyError</span>{<span style="color:#a6e22e">Err</span>: <span style="color:#a6e22e">err</span>}
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">v</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">VsccValidatorImpl</span>) <span style="color:#a6e22e">getCDataForCC</span>(<span style="color:#a6e22e">chid</span>, <span style="color:#a6e22e">ccid</span> <span style="color:#66d9ef">string</span>) (<span style="color:#f92672">*</span><span style="color:#a6e22e">ccprovider</span>.<span style="color:#a6e22e">ChaincodeData</span>, <span style="color:#66d9ef">error</span>) {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">l</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">v</span>.<span style="color:#a6e22e">cr</span>.<span style="color:#a6e22e">Ledger</span>()
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">l</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">errors</span>.<span style="color:#a6e22e">New</span>(<span style="color:#e6db74">&#34;nil ledger instance&#34;</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">qe</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">l</span>.<span style="color:#a6e22e">NewQueryExecutor</span>()
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">errors</span>.<span style="color:#a6e22e">WithMessage</span>(<span style="color:#a6e22e">err</span>, <span style="color:#e6db74">&#34;could not retrieve QueryExecutor&#34;</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">qe</span>.<span style="color:#a6e22e">Done</span>()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">bytes</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">qe</span>.<span style="color:#a6e22e">GetState</span>(<span style="color:#e6db74">&#34;lscc&#34;</span>, <span style="color:#a6e22e">ccid</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">commonerrors</span>.<span style="color:#a6e22e">VSCCInfoLookupFailureError</span>{
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">Reason</span>: <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Sprintf</span>(<span style="color:#e6db74">&#34;Could not retrieve state for chaincode %s, error %s&#34;</span>, <span style="color:#a6e22e">ccid</span>, <span style="color:#a6e22e">err</span>),
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">bytes</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">errors</span>.<span style="color:#a6e22e">Errorf</span>(<span style="color:#e6db74">&#34;lscc&#39;s state for [%s] not found.&#34;</span>, <span style="color:#a6e22e">ccid</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">cd</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">ccprovider</span>.<span style="color:#a6e22e">ChaincodeData</span>{}
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">proto</span>.<span style="color:#a6e22e">Unmarshal</span>(<span style="color:#a6e22e">bytes</span>, <span style="color:#a6e22e">cd</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">errors</span>.<span style="color:#a6e22e">Wrap</span>(<span style="color:#a6e22e">err</span>, <span style="color:#e6db74">&#34;unmarshalling ChaincodeQueryResponse failed&#34;</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">cd</span>.<span style="color:#a6e22e">Vscc</span> <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;&#34;</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">errors</span>.<span style="color:#a6e22e">Errorf</span>(<span style="color:#e6db74">&#34;lscc&#39;s state for [%s] is invalid, vscc field must be set&#34;</span>, <span style="color:#a6e22e">ccid</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> len(<span style="color:#a6e22e">cd</span>.<span style="color:#a6e22e">Policy</span>) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">errors</span>.<span style="color:#a6e22e">Errorf</span>(<span style="color:#e6db74">&#34;lscc&#39;s state for [%s] is invalid, policy field must be set&#34;</span>, <span style="color:#a6e22e">ccid</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">cd</span>, <span style="color:#a6e22e">err</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// GetInfoForValidate gets the ChaincodeInstance(with latest version) of tx, vscc and policy from lscc
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">v</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">VsccValidatorImpl</span>) <span style="color:#a6e22e">GetInfoForValidate</span>(<span style="color:#a6e22e">chdr</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">common</span>.<span style="color:#a6e22e">ChannelHeader</span>, <span style="color:#a6e22e">ccID</span> <span style="color:#66d9ef">string</span>) (<span style="color:#f92672">*</span><span style="color:#a6e22e">sysccprovider</span>.<span style="color:#a6e22e">ChaincodeInstance</span>, <span style="color:#f92672">*</span><span style="color:#a6e22e">sysccprovider</span>.<span style="color:#a6e22e">ChaincodeInstance</span>, []<span style="color:#66d9ef">byte</span>, <span style="color:#66d9ef">error</span>) {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">cc</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">sysccprovider</span>.<span style="color:#a6e22e">ChaincodeInstance</span>{
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">ChannelID</span>:     <span style="color:#a6e22e">chdr</span>.<span style="color:#a6e22e">ChannelId</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">ChaincodeName</span>: <span style="color:#a6e22e">ccID</span>,
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">vscc</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">sysccprovider</span>.<span style="color:#a6e22e">ChaincodeInstance</span>{
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">ChannelID</span>:     <span style="color:#a6e22e">chdr</span>.<span style="color:#a6e22e">ChannelId</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">ChaincodeName</span>: <span style="color:#e6db74">&#34;vscc&#34;</span>, <span style="color:#75715e">// default vscc for system chaincodes
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">policy</span> []<span style="color:#66d9ef">byte</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">err</span> <span style="color:#66d9ef">error</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> !<span style="color:#a6e22e">IsSysCC</span>(<span style="color:#a6e22e">ccID</span>) {
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// when we are validating a chaincode that is not a
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#75715e">// system CC, we need to ask the CC to give us the name
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#75715e">// of VSCC and of the policy that should be used
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// obtain name of the VSCC and the policy
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#a6e22e">cd</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">v</span>.<span style="color:#a6e22e">getCDataForCC</span>(<span style="color:#a6e22e">chdr</span>.<span style="color:#a6e22e">ChannelId</span>, <span style="color:#a6e22e">ccID</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">msg</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Sprintf</span>(<span style="color:#e6db74">&#34;Unable to get chaincode data from ledger for txid %s, due to %s&#34;</span>, <span style="color:#a6e22e">chdr</span>.<span style="color:#a6e22e">TxId</span>, <span style="color:#a6e22e">err</span>)
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">logger</span>.<span style="color:#a6e22e">Errorf</span>(<span style="color:#a6e22e">msg</span>)
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#66d9ef">nil</span>, <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">err</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">cc</span>.<span style="color:#a6e22e">ChaincodeName</span> = <span style="color:#a6e22e">cd</span>.<span style="color:#a6e22e">Name</span>
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">cc</span>.<span style="color:#a6e22e">ChaincodeVersion</span> = <span style="color:#a6e22e">cd</span>.<span style="color:#a6e22e">Version</span>
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">vscc</span>.<span style="color:#a6e22e">ChaincodeName</span>, <span style="color:#a6e22e">policy</span> = <span style="color:#a6e22e">cd</span>.<span style="color:#a6e22e">Vscc</span>, <span style="color:#a6e22e">cd</span>.<span style="color:#a6e22e">Policy</span>
</span></span><span style="display:flex;"><span>	} <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// when we are validating a system CC, we use the default
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#75715e">// VSCC and a default policy that requires one signature
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#75715e">// from any of the members of the channel
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#a6e22e">p</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">policydsl</span>.<span style="color:#a6e22e">SignedByAnyMember</span>(<span style="color:#a6e22e">v</span>.<span style="color:#a6e22e">cr</span>.<span style="color:#a6e22e">GetMSPIDs</span>())
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">policy</span>, <span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">protoutil</span>.<span style="color:#a6e22e">Marshal</span>(<span style="color:#a6e22e">p</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#66d9ef">nil</span>, <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">err</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">cc</span>, <span style="color:#a6e22e">vscc</span>, <span style="color:#a6e22e">policy</span>, <span style="color:#66d9ef">nil</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// txWritesToNamespace returns true if the supplied NsRwSet
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// performs a ledger write
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">v</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">VsccValidatorImpl</span>) <span style="color:#a6e22e">txWritesToNamespace</span>(<span style="color:#a6e22e">ns</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">rwsetutil</span>.<span style="color:#a6e22e">NsRwSet</span>) <span style="color:#66d9ef">bool</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// check for public writes first
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">ns</span>.<span style="color:#a6e22e">KvRwSet</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> <span style="color:#f92672">&amp;&amp;</span> len(<span style="color:#a6e22e">ns</span>.<span style="color:#a6e22e">KvRwSet</span>.<span style="color:#a6e22e">Writes</span>) &gt; <span style="color:#ae81ff">0</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// only look at collection data if we support that capability
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">v</span>.<span style="color:#a6e22e">cr</span>.<span style="color:#a6e22e">Capabilities</span>().<span style="color:#a6e22e">PrivateChannelData</span>() {
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// check for private writes for all collections
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">c</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">ns</span>.<span style="color:#a6e22e">CollHashedRwSets</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">HashedRwSet</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> <span style="color:#f92672">&amp;&amp;</span> len(<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">HashedRwSet</span>.<span style="color:#a6e22e">HashedWrites</span>) &gt; <span style="color:#ae81ff">0</span> {
</span></span><span style="display:flex;"><span>				<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// only look at private metadata writes if we support that capability
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>			<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">v</span>.<span style="color:#a6e22e">cr</span>.<span style="color:#a6e22e">Capabilities</span>().<span style="color:#a6e22e">KeyLevelEndorsement</span>() {
</span></span><span style="display:flex;"><span>				<span style="color:#75715e">// private metadata updates
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>				<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">HashedRwSet</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> <span style="color:#f92672">&amp;&amp;</span> len(<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">HashedRwSet</span>.<span style="color:#a6e22e">MetadataWrites</span>) &gt; <span style="color:#ae81ff">0</span> {
</span></span><span style="display:flex;"><span>					<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>				}
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// only look at metadata writes if we support that capability
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">v</span>.<span style="color:#a6e22e">cr</span>.<span style="color:#a6e22e">Capabilities</span>().<span style="color:#a6e22e">KeyLevelEndorsement</span>() {
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// public metadata updates
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">ns</span>.<span style="color:#a6e22e">KvRwSet</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> <span style="color:#f92672">&amp;&amp;</span> len(<span style="color:#a6e22e">ns</span>.<span style="color:#a6e22e">KvRwSet</span>.<span style="color:#a6e22e">MetadataWrites</span>) &gt; <span style="color:#ae81ff">0</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">IsSysCCAndNotInvokableExternal</span>(<span style="color:#a6e22e">name</span> <span style="color:#66d9ef">string</span>) <span style="color:#66d9ef">bool</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">name</span> <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;vscc&#34;</span> <span style="color:#f92672">||</span> <span style="color:#a6e22e">name</span> <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;escc&#34;</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">IsSysCC</span>(<span style="color:#a6e22e">name</span> <span style="color:#66d9ef">string</span>) <span style="color:#66d9ef">bool</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">name</span> <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;vscc&#34;</span> <span style="color:#f92672">||</span> <span style="color:#a6e22e">name</span> <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;escc&#34;</span> <span style="color:#f92672">||</span> <span style="color:#a6e22e">name</span> <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;lscc&#34;</span> <span style="color:#f92672">||</span> <span style="color:#a6e22e">name</span> <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;qscc&#34;</span> <span style="color:#f92672">||</span> <span style="color:#a6e22e">name</span> <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;cscc&#34;</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">IsSysCCAndNotInvokableCC2CC</span>(<span style="color:#a6e22e">name</span> <span style="color:#66d9ef">string</span>) <span style="color:#66d9ef">bool</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">name</span> <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;vscc&#34;</span> <span style="color:#f92672">||</span> <span style="color:#a6e22e">name</span> <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;escc&#34;</span> <span style="color:#f92672">||</span> <span style="color:#a6e22e">name</span> <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;cscc&#34;</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div>
</section>


    <footer class="article-footer">
    
    <section class="article-tags">
        
            <a href="/tags/fabric/">fabric</a>
        
            <a href="/tags/go/">go</a>
        
    </section>


    <section class="article-lastmod">
        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <polyline points="12 7 12 12 15 15" />
</svg>



        <span>
            Last updated on Dec 18, 2020 13:40 UTC
        </span>
    </section></footer>


    
        <link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/katex@0.13.13/dist/katex.min.css"integrity="sha384-RZU/ijkSsFbcmivfdRBQDtwuwVqK7GMOw6IMvKyeWL2K5UAlyp6WonmB8m7Jd0Hn"crossorigin="anonymous"
            ><script 
                src="https://cdn.jsdelivr.net/npm/katex@0.13.13/dist/katex.min.js"integrity="sha384-pK1WpvzWVBQiP0/GjnvRxV4mOb0oxFuyRxJlk6vVw146n3egcN5C925NCP7a7BY8"crossorigin="anonymous"
                defer="true"
                >
            </script><script 
                src="https://cdn.jsdelivr.net/npm/katex@0.13.13/dist/contrib/auto-render.min.js"integrity="sha384-vZTG03m&#43;2yp6N6BNi5iM4rW4oIwk5DfcNdFfxkk9ZWpDriOkXX8voJBFrAO7MpVl"crossorigin="anonymous"
                defer="true"
                >
            </script><script>
    window.addEventListener("DOMContentLoaded", () => {
        renderMathInElement(document.querySelector(`.article-content`), {
            delimiters: [
                { left: "$$", right: "$$", display: true },
                { left: "$", right: "$", display: false },
                { left: "\\(", right: "\\)", display: false },
                { left: "\\[", right: "\\]", display: true }
            ]
        });})
</script>
    
</article>

    <aside class="related-contents--wrapper">
    
    
</aside>

     
    
        
    

    <footer class="site-footer">
    <section class="copyright">
        &copy;
        
        2024 s0uthwood&#39;s Blog
    
        
            <br />
            已运行 <i class="fas fa-bell"></i> <a id="days">0</a> 天
        
    
        
            &nbsp;&nbsp;
            
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
            
            ⌨&nbsp;
            86.36k&nbsp;
            字
            &nbsp;&nbsp;
            🧠&nbsp;
            38&nbsp;
            篇文章
        
    </section>

    <section class="powerby">
        Built with <a href="https://gohugo.io/" target="_blank" rel="noopener">Hugo</a> <br />
        Theme <b><a href="https://github.com/CaiJimmy/hugo-theme-stack" target="_blank" rel="noopener" data-version="3.5.0">Stack</a></b> designed by <a href="https://jimmycai.com" target="_blank" rel="noopener">Jimmy</a>
    </section>

    
        <script>
            var s1 = "2020-11-15";
            s1 = new Date(s1.replace(/-/g, "/"));
            s2 = new Date();
            var days = s2.getTime() - s1.getTime();
            var number_of_days = parseInt(days / (1000 * 60 * 60 * 24));
            document.getElementById('days').innerHTML = number_of_days;
        </script>
    
</footer>


    
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    
    <div class="pswp__bg"></div>

    
    <div class="pswp__scroll-wrap">

        
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                
                
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js"integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo="crossorigin="anonymous"
                defer="true"
                >
            </script><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js"integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU="crossorigin="anonymous"
                defer="true"
                >
            </script><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.css"integrity="sha256-c0uckgykQ9v5k&#43;IqViZOZKc47Jn7KQil4/MP3ySA3F8="crossorigin="anonymous"
            ><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.css"integrity="sha256-SBLU4vv6CA6lHsZ1XyTdhyjJxCjPif/TRkjnsyGAGnE="crossorigin="anonymous"
            >

            </main>
    
        <aside class="sidebar right-sidebar sticky">
            <section class="widget archives">
                <div class="widget-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <line x1="5" y1="9" x2="19" y2="9" />
  <line x1="5" y1="15" x2="19" y2="15" />
  <line x1="11" y1="4" x2="7" y2="20" />
  <line x1="17" y1="4" x2="13" y2="20" />
</svg>



                </div>
                <h2 class="widget-title section-title">Table of contents</h2>
                
                <div class="widget--toc">
                    <nav id="TableOfContents">
  <ul>
    <li><a href="#架构">架构</a>
      <ul>
        <li><a href="#整体结构">整体结构</a></li>
        <li><a href="#交易的三个阶段">交易的三个阶段</a></li>
        <li><a href="#信任与故障模型">信任与故障模型</a></li>
      </ul>
    </li>
    <li><a href="#组件">组件</a>
      <ul>
        <li><a href="#成员身份管理服务msp">成员身份管理服务（MSP）</a></li>
        <li><a href="#排序服务">排序服务</a></li>
        <li><a href="#peer-gossip">Peer Gossip</a></li>
        <li><a href="#分布式账本ledger">分布式账本(<em>Ledger</em>)</a></li>
        <li><a href="#链码执行">链码执行</a></li>
        <li><a href="#配置和系统链码">配置和系统链码</a></li>
      </ul>
    </li>
    <li><a href="#系统链码">系统链码</a>
      <ul>
        <li><a href="#系统链码在peer节点上的注册与部署">系统链码在Peer节点上的注册与部署</a></li>
        <li><a href="#查询系统链码-querier-system-chaincode-qscc">查询系统链码 (<em>Querier System Chaincode</em>, QSCC)</a></li>
        <li><a href="#配置系统链码-configuration-system-chaincode-cscc">配置系统链码 (<em>Configuration System Chaincode</em>, CSCC)</a></li>
        <li><a href="#生命周期系统链码-life-cycle-system-chaincode-lscc">生命周期系统链码 (<em>Life Cycle System Chaincode</em>, LSCC)</a></li>
        <li><a href="#背书系统链码-endorser-system-chaincode-escc">背书系统链码 (<em>Endorser System Chaincode</em>, ESCC)</a></li>
        <li><a href="#验证系统链码-validator-system-chaincode-vscc">验证系统链码 (<em>Validator System Chaincode</em>, VSCC)</a></li>
      </ul>
    </li>
  </ul>
</nav>
                </div>
            </section>
        </aside>
    

        </div>
        <script 
                src="https://cdn.jsdelivr.net/npm/node-vibrant@3.1.5/dist/vibrant.min.js"integrity="sha256-5NovOZc4iwiAWTYIFiIM7DxKUXKWvpVEuMEPLzcm5/g="crossorigin="anonymous"
                defer="false"
                >
            </script><script type="text/javascript" src="/ts/main.js" defer></script>
<script>
    (function () {
        const customFont = document.createElement('link');
        customFont.href = "https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap";

        customFont.type = "text/css";
        customFont.rel = "stylesheet";

        document.head.appendChild(customFont);
    }());
</script>

    </body>
</html>
