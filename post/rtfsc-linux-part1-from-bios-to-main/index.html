<!DOCTYPE html>
<html lang="en-us">
    <head><meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1'><meta name='description' content='Read the F**king Source Code'><title>RTFSC-Linux0.11 Part1: From BIOS to main</title>

<link rel='canonical' href='/post/rtfsc-linux-part1-from-bios-to-main/'>

<link rel="stylesheet" href="/scss/style.min.css"><meta property='og:title' content='RTFSC-Linux0.11 Part1: From BIOS to main'>
<meta property='og:description' content='Read the F**king Source Code'>
<meta property='og:url' content='/post/rtfsc-linux-part1-from-bios-to-main/'>
<meta property='og:site_name' content='s0uthwood&#39;s Blog'>
<meta property='og:type' content='article'><meta property='article:section' content='Post' /><meta property='article:tag' content='System' /><meta property='article:tag' content='RTFSC' /><meta property='article:tag' content='Reading' /><meta property='article:published_time' content='2022-10-23T02:41:13&#43;08:00'/><meta property='article:modified_time' content='2022-10-23T02:41:13&#43;08:00'/><meta property='og:image' content='/post/rtfsc-linux-part1-from-bios-to-main/cover.jpg' />
<meta name="twitter:title" content="RTFSC-Linux0.11 Part1: From BIOS to main">
<meta name="twitter:description" content="Read the F**king Source Code"><meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:image" content='/post/rtfsc-linux-part1-from-bios-to-main/cover.jpg' />
    </head>
    <body class="
    article-page has-toc
">
    <script>
        (function() {
            const colorSchemeKey = 'StackColorScheme';
            if(!localStorage.getItem(colorSchemeKey)){
                localStorage.setItem(colorSchemeKey, "auto");
            }
        })();
    </script><script>
    (function() {
        const colorSchemeKey = 'StackColorScheme';
        const colorSchemeItem = localStorage.getItem(colorSchemeKey);
        const supportDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches === true;

        if (colorSchemeItem == 'dark' || colorSchemeItem === 'auto' && supportDarkMode) {
            

            document.documentElement.dataset.scheme = 'dark';
        } else {
            document.documentElement.dataset.scheme = 'light';
        }
    })();
</script>
<div class="container main-container flex 
    
        extended
    
">
    
        <div id="article-toolbar">
            <a href="/" class="back-home">
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-chevron-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <polyline points="15 6 9 12 15 18" />
</svg>



                <span>Back</span>
            </a>
        </div>
    
<main class="main full-width">
    <article class="has-image main-article">
    <header class="article-header">
        <div class="article-image">
            <a href="/post/rtfsc-linux-part1-from-bios-to-main/">
                <img src="/post/rtfsc-linux-part1-from-bios-to-main/cover_hu9a326951c8c9be216fda73ae6923adfc_1779523_800x0_resize_q75_box.jpg"
                        srcset="/post/rtfsc-linux-part1-from-bios-to-main/cover_hu9a326951c8c9be216fda73ae6923adfc_1779523_800x0_resize_q75_box.jpg 800w, /post/rtfsc-linux-part1-from-bios-to-main/cover_hu9a326951c8c9be216fda73ae6923adfc_1779523_1600x0_resize_q75_box.jpg 1600w"
                        width="800" 
                        height="425" 
                        loading="lazy"
                        alt="Featured image of post RTFSC-Linux0.11 Part1: From BIOS to main" />
                
            </a>
        </div>
    

    <div class="article-details">
    
    <header class="article-category">
        
            <a href="/categories/reading/" >
                Reading
            </a>
        
    </header>
    

    <h2 class="article-title">
        <a href="/post/rtfsc-linux-part1-from-bios-to-main/">RTFSC-Linux0.11 Part1: From BIOS to main</a>
    </h2>

    
    <h3 class="article-subtitle">
        Read the F**king Source Code
    </h3>
    

    
    <footer class="article-time">
        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M11.795 21h-6.795a2 2 0 0 1 -2 -2v-12a2 2 0 0 1 2 -2h12a2 2 0 0 1 2 2v4" />
  <circle cx="18" cy="18" r="4" />
  <path d="M15 3v4" />
  <path d="M7 3v4" />
  <path d="M3 11h16" />
  <path d="M18 16.496v1.504l1 1" />
</svg>
                <time class="article-time--published">Oct 23, 2022</time>
            </div>
        

        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-pencil" width="44" height="44" viewBox="0 0 24 24" stroke-width="1.5" stroke="#9e9e9e" fill="none" stroke-linecap="round" stroke-linejoin="round">
    <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
    <path d="M4 20h4L18.5 9.5a1.5 1.5.0 00-4-4L4 16v4"></path>
    <line x1="13.5" y1="6.5" x2="17.5" y2="10.5"></line>
</svg>
                <time class="article-words">
                    2722 words
                </time>
            </div>
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <polyline points="12 7 12 12 15 15" />
</svg>



                <time class="article-time--reading">
                    13 minute read
                </time>
            </div>
        
    </footer>
    
</div>
</header>

    <section class="article-content">
    <p>è·Ÿç€å¤§ä½¬çš„æ–‡ç« è¯»ä¸€ä¸‹ Linux 0.11 çš„æºç </p>
<p><code>github.com/sunym1993/flash-linux0.11-talk</code></p>
<h2 id="how-everything-begins-bootsectss">How Everything Begins (bootsects.s)</h2>
<h3 id="ä»-0x7c00-å¼€å§‹çš„æ“ä½œç³»ç»Ÿå¯åŠ¨">ä» 0x7C00 å¼€å§‹çš„æ“ä½œç³»ç»Ÿå¯åŠ¨</h3>
<p>å¼€æœºé¦–å…ˆä¼šæ‰§è¡Œä¸»æ¿ä¸Šçš„ BIOS ç¨‹åºï¼ŒBIOS å°†å¯åŠ¨åŒºçš„ 512 å­—èŠ‚ï¼ˆä¸€ä¸ªæ‰‡åŒºï¼‰å¤åˆ¶åˆ°å†…å­˜ä¸­çš„ <code>0x7C00</code> åœ°å€ï¼Œéšåè·³è½¬åˆ°è¿™ä¸ªåœ°å€ç»§ç»­æ‰§è¡Œ</p>
<blockquote>
<p>å¯åŠ¨åŒºçš„è¯†åˆ«ï¼š0 ç›˜ 0 é“ 1 æ‰‡åŒºçš„ 512 å­—èŠ‚æœ€åä¸¤ä¸ªå­—èŠ‚ä¸º <code>55 AA</code></p>
</blockquote>
<p>æ‰€ä»¥æ“ä½œç³»ç»Ÿå°†ä»ç¬¬ä¸€æ‰‡åŒºå¯åŠ¨ï¼Œè¿™åœ¨æºç ä¸­å¯¹åº”äº† <code>boot/bootsect.s</code> æ–‡ä»¶</p>
<p>æœ€å¼€å§‹çš„ä¸¤è¡Œæºç ï¼š</p>
<pre tabindex="0"><code class="language-assembly" data-lang="assembly">mov ax, 0x07C0
mov ds, ax
</code></pre><p>å°† <code>ds</code> å¯„å­˜å™¨èµ‹å€¼ä¸º <code>0x7C0</code></p>
<blockquote>
<p>ä¸ºäº†èƒ½å¤Ÿåœ¨ 16 ä½å®æ¨¡å¼ä¸‹è®¿é—® 20 ä½çš„åœ°å€ï¼Œåœ¨è¯»å–æ®µå¯„å­˜å™¨æ—¶éœ€è¦ <code>&lt;&lt; 4</code>ï¼Œæ‰€ä»¥ <code>ds</code> æ˜¯ <code>0x7C0</code> æ—¶å¯¹åº”äº†åœ°å€ <code>0x7C00</code>ï¼ŒæŒ‡å‘äº†æ­¤æ—¶ä»£ç æ®µçš„åœ°å€ï¼Œæ–¹ä¾¿äº†åç»­å¯¹å†…å­˜çš„è®¿é—®</p>
</blockquote>
<h3 id="ç»™è‡ªå·±æŒªä¸ªåœ°æ–¹">ç»™è‡ªå·±æŒªä¸ªåœ°æ–¹</h3>
<p>éšåæ‰§è¡Œï¼š</p>
<pre tabindex="0"><code class="language-assembly" data-lang="assembly">mov ax, 0x9000
mov es, ax
mov cx, #256
sub si, si
sub di, di
rep movw
</code></pre><p>å‰é¢ä¸¤è¡Œå’Œæœ€å¼€å§‹çš„ä¸¤è¡Œç±»ä¼¼ï¼Œå°† <code>es</code> å¯„å­˜å™¨èµ‹å€¼ä¸º <code>0x9000</code>ï¼Œéšå <code>cx = 0x100; si = 0; di = 0</code>ï¼Œæœ€åå¾ªç¯æ‰§è¡Œ movw æŒ‡ä»¤</p>
<blockquote>
<p><code>rep</code> æŒ‡ä»¤æ‰§è¡Œæ¬¡æ•°å–å†³äº <code>cx</code>ï¼Œé…åˆ<code>movw</code> æŒ‡ä»¤ä» <code>ds</code> å¤åˆ¶åˆ° <code>es</code></p>
</blockquote>
<p>è¿™é‡Œå°±å°† <code>0x7C00</code> å¤„çš„ 512 å­—èŠ‚ï¼ˆ256 WORDSï¼‰å¤åˆ¶åˆ°äº† <code>0x90000</code> å¤„</p>
<pre tabindex="0"><code class="language-assembly" data-lang="assembly">jmpi go, 0x9000
go:
  mov ax, cs
  ...
</code></pre><p>ç›¸å½“äº <code>jmp go+0x90000</code>ï¼Œé…åˆä¸€ä¸‹ä¸Šé¢çš„å¤åˆ¶æŒ‡ä»¤ï¼Œè™½ç„¶æ‰§è¡Œçš„æŒ‡ä»¤ä¸å®é™…åœ°å€åé¢è¿™æ¡æŒ‡ä»¤ç›¸åŒï¼Œä½†å®é™…åœ°å€å·²ç»æŒªè¿‡å»äº†</p>
<p>ã€Šç»™è‡ªå·±æŒªä¸ªåœ°æ–¹ã€‹</p>
<h3 id="ä¸€äº›åŸºç¡€å·¥ä½œ">ä¸€äº›åŸºç¡€å·¥ä½œ</h3>
<p><code>go</code> åé¢çš„æŒ‡ä»¤</p>
<pre tabindex="0"><code class="language-assembly" data-lang="assembly">go:
  mov ax, cs
  mov ds, ax
  mov es, ax
  mov ss, ax
  mov sp, #0xFF00
</code></pre><p>ä¹‹å‰ <code>jmpi</code> æŒ‡ä»¤åï¼Œ<code>cs</code> å¯„å­˜å™¨å°±è¢«å¤åˆ¶ä¸º <code>0x9000</code>ï¼Œéšåå°† <code>ds, es, ss</code> éƒ½èµ‹å€¼ä¸ºäº† <code>0x9000</code>ï¼Œæ ˆé¡¶åœ°å€åˆ™è¢«èµ‹å€¼ä¸º <code>ss:sp=0x9FF00</code></p>
<p>ç®€å•ç”»ä¸€ä¸‹ç›®å‰çš„å†…å­˜æƒ…å†µ</p>
<pre tabindex="0"><code>+-----------------+ 0x90000 &lt;- cs, ds, es, ss
|  mov ax, 0x7c0  |
|     ......      |
| mov sp, #0xFF00 |
|     next i      | &lt;- ip
|     ......      |
+-----------------+
|     stack       |
+-----------------+ 0x9FF00 &lt;- ss:sp
</code></pre><h3 id="æŠŠç¡¬ç›˜é‡Œçš„å…¶ä»–éƒ¨åˆ†ä¹ŸæŒªè¿‡æ¥">æŠŠç¡¬ç›˜é‡Œçš„å…¶ä»–éƒ¨åˆ†ä¹ŸæŒªè¿‡æ¥</h3>
<p>åœ¨å®ŒæˆåŸºæœ¬å·¥ä½œå</p>
<pre tabindex="0"><code class="language-assembly" data-lang="assembly">load_setup:
  mov dx, #0x0000   ; drive 0, head 0
  mov cx, #0x0002   ; sector 2, track 0
  mov bx, #0x0200   ; address = 512, in 0x9000
  mov ax, #0x0200+SETUPLEN ; SETUPLEN = 4, service 2, nr of sectors
  int 0x13          ; read it
  jnc ok_load_setup ; ok - continue
  mov dx, #0x0000
  mov ax, #0x0000   ; reset the diskette
  int 0x13
  j   load_setup

ok_load_setup:
  ...
</code></pre><p><code>int 0x13</code> æ˜¯ BIOS ä¸­çš„ä¸­æ–­ï¼Œåœ¨è¿™é‡Œæ‰§è¡Œäº† BIOS ä¸­è¯»å–ç£ç›˜çš„ç¨‹åºï¼Œç»“åˆä¸Šé¢è®¾ç½®å¥½çš„å‚æ•°ï¼Œå°±æ˜¯å°† 2 ~ 5 æ‰‡åŒºçš„å†…å®¹ï¼ˆsetup.s ç¨‹åºï¼‰è¯»å–åˆ° 0x90200 å†…å­˜ä¸­ï¼Œç”±äºè¯¥ä¸­æ–­å…·ä½“å®ç°åœ¨ BIOS ä¸­ï¼Œæ­¤å¤„åªå…³æ³¨ç»“æœå³å¯</p>
<p>éšåç»§ç»­æ‰§è¡Œ <code>ok_load_setup</code></p>
<pre tabindex="0"><code class="language-assembly" data-lang="assembly">ok_load_setup:
  ; Get disk drive parameters, specifically nr of sectors/track
  ...
  ; Print some inane message
  ...
  ; Load the system (at 0x10000)
  mov ax, #0x1000
  mov es, ax
  call read_it    ; This routine loads the system at address 0x10000, making sure no 64KB boundaries are crossed.
  ; Check which root-device to use
  ...
  ; jump to the setup-routine loaded directly after the bootblock
  jmpi 0, SETUPSEG ; SETUPSEG = 0x9020
</code></pre><p>çœç•¥çš„ä»£ç å’Œä¸»è¦é€»è¾‘æ— å…³ï¼ˆå‚è€ƒçœç•¥å·å‰çš„æ³¨é‡Šï¼‰ï¼Œä¸»è¦ç”¨äºè¾“å‡º <code>Loading system</code> ç­‰å†…å®¹</p>
<p>è¿™å‡ è¡Œä»£ç ä¸»è¦æ˜¯æ‰§è¡Œäº† <code>read_it</code> å‡½æ•°ï¼Œå°†ç¬¬ 6 æ‰‡åŒºå¼€å§‹çš„ 240 ä¸ªæ‰‡åŒºè¯»å–åˆ° <code>0x10000</code> åœ°å€ï¼ˆå‰©ä½™å…¨éƒ¨ä»£ç ï¼Œå¼€å¤´ä¸º head.sï¼‰ï¼Œå…·ä½“çš„åŸç†ä¸æ­¤å‰ç›¸ä¼¼ï¼Œæœ€åè·³è½¬åˆ° <code>0x90200</code> æ‰§è¡Œç¬¬äºŒæ‰‡åŒºçš„ä»£ç </p>
<p>æ­¤æ—¶çš„å†…å­˜</p>
<pre tabindex="0"><code>+------------+ &lt;- 0x7C00
| bootsect.s |
+------------+
|    ...     |
+------------+ &lt;- 0x10000
|   head.s   |
|            |
|   system   |
|            |
|            |
+------------+
|    ...     |
+------------+ &lt;- 0x90000
| bootsect.s |
+------------+ &lt;- 0x90200
|            |
|  setup.s   |
|            |
+------------+
</code></pre><blockquote>
<p>æ¥ä¸‹æ¥å°±è·³è½¬åˆ° setup.s ç¨‹åºäº†ï¼Œåœ¨ç¬¬ä¸€ä¸ªç¨‹åºä¸­ï¼Œä¸€ä¸ªæœ€æ˜æ˜¾çš„ç‰¹å¾å°±æ˜¯æ‰€æœ‰çš„åœ°å€éƒ½æ˜¯å†™æ­»çš„ï¼Œæ¯”å¦‚ä»ç¬¬ 1 æ‰‡åŒºæŒªåˆ°å›ºå®šçš„åœ°å€ <code>0x7C00</code>ï¼Œå†æŒªåˆ°å›ºå®šçš„åœ°å€ <code>0x90000</code>ï¼Œæœ€åæŠŠå‰©ä¸‹çš„ä¸œè¥¿ä¹ŸæŒªåˆ°å›ºå®šçš„åœ°å€ <code>0x90200</code> å’Œ <code>0x10000</code>ï¼Œè¿™äº›åœ°å€éƒ½æ˜¯å†™æ­»çš„ï¼Œä¸èƒ½å‡ºç°ä»»ä½•åå·®ï¼Œç®€å•æ€»ç»“å°±æ˜¯â€œå¼ºè€¦åˆâ€ï¼ŒæŠŠå‰åæ‰§è¡Œçš„æ¯ä¸€æ¡æŒ‡ä»¤ä¸ç›¸åº”çš„å†…å­˜éƒ½å®‰æ’å¥½äº†</p>
</blockquote>
<h2 id="ç»§ç»­å¯åŠ¨-setups">ç»§ç»­å¯åŠ¨ (setup.s)</h2>
<h3 id="ä¿æŠ¤æ¨¡å¼å‰çš„å‡†å¤‡">ä¿æŠ¤æ¨¡å¼å‰çš„å‡†å¤‡</h3>
<p>ä¸Šä¸€æ®µç¨‹åºæœ€åè·³è½¬åˆ°äº† <code>0x90200</code>ï¼Œä¹Ÿå°±æ˜¯ setup.s ä¸­çš„ä»£ç </p>
<pre tabindex="0"><code class="language-assembly" data-lang="assembly">start:
  mov ax, #0x9000 ; this is done in bootsect already, but...
  mov ds, ax
  mov ah, #0x03   ; read cursor pos
  xor bh, bh
  int 0x10        ; save it in  known place, con_init fetches
  mov [0], dx     ; it from 0x90000.
</code></pre><blockquote>
<p>åæ§½ä¸€ä¸‹ï¼Œå‰é¢æ¸…é›¶ç”¨çš„æ˜¯ <code>sub ax, ax</code>ï¼Œè¿™é‡Œæ€ä¹ˆå°±ç”¨ <code>xor ax, ax</code> äº†</p>
</blockquote>
<p>int 0x10 ä¸­æ–­ä»ç„¶æ˜¯ BIOS ä¸­çš„ä¸­æ–­ï¼Œç”¨äºæ˜¾ç¤ºæœåŠ¡ï¼Œå½“ <code>AH = 3</code> æ—¶ï¼Œç”¨äºè·å–å…‰æ ‡çš„ä½ç½®ä¸å½¢æ€ï¼Œå¹¶ä¿å­˜åˆ° <code>dx</code> å¯„å­˜å™¨ä¸­ï¼Œå…¶ä¸­ <code>dh</code> ä¿å­˜äº†è¡Œå·ï¼Œ<code>dl</code> ä¿å­˜äº†åˆ—å·</p>
<p>æœ€ç»ˆå°†ç»“æœä¿å­˜è‡³äº† <code>0x90000</code> åœ°å€ï¼Œç”¨äºåç»­åˆå§‹åŒ–æ§åˆ¶å°</p>
<p>åç»­çš„ä»£ç éƒ½æ˜¯åœ¨å¹²ç±»ä¼¼çš„äº‹æƒ…ï¼Œè·å–ç¯å¢ƒçš„ä¿¡æ¯ï¼Œç„¶åä¿å­˜åˆ°å†…å­˜ä¸­</p>
<pre tabindex="0"><code class="language-assembly" data-lang="assembly">; Get memory size (extended mem, kB)
mov ah, #0x88
int 0x15
mov [2], ax

; Get vedio-card data:
mov ah, #0x0F
int 0x10
mov [4], bx   ; bh = display page
mov [6], ax   ; al = video mode, ah = window width

; Check for EGA/VGA and some config parameters
mov ah, #0x12
mov bl, #0x10
int 0x10
mov [8], ax
mov [10], bx
mov [12], cx

; Get hd0 data
mov ax, #0x0000
mov ds, ax
lds si, [4 * 0x41]
mov ax, #INITSEG
mov es, ax
mov di, #0x0080
mov cx, #0x10
rep movsb

; Get hd1 data
mov ax, #0x0000
mov ds, ax
lds si, [4 * 0x46]
mov ax, #INITSEG  ; INITSET = 0x9000
mov es, ax
mov di, #0x0090
mov cx, #0x10
rep movsb

; Check that there IS a hd1
...
</code></pre><p>ä¾æ¬¡è·å–äº†å†…å­˜ã€æ˜¾å¡ã€æ˜¾ç¤ºæ–¹å¼ã€ç¡¬ç›˜ç­‰ä¿¡æ¯ï¼Œéƒ½æ˜¯åœ¨è°ƒç”¨ BIOS ä¸­æ–­å¹¶ä¿å­˜ï¼Œæ²¡å¿…è¦ç»†çœ‹äº†ï¼Œæœ€åçš„å†…å­˜å¦‚ä¸‹è¡¨æ‰€ç¤º</p>
<table>
<thead>
<tr>
<th style="text-align:center">addr</th>
<th style="text-align:center">length</th>
<th style="text-align:left">info</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">0x90000</td>
<td style="text-align:center">2</td>
<td style="text-align:left">å…‰æ ‡ä½ç½®</td>
</tr>
<tr>
<td style="text-align:center">0x90002</td>
<td style="text-align:center">2</td>
<td style="text-align:left">æ‰©å±•å†…å­˜æ•°</td>
</tr>
<tr>
<td style="text-align:center">0x90004</td>
<td style="text-align:center">2</td>
<td style="text-align:left">æ˜¾ç¤ºé¡µé¢</td>
</tr>
<tr>
<td style="text-align:center">0x90006</td>
<td style="text-align:center">1</td>
<td style="text-align:left">æ˜¾ç¤ºæ¨¡å¼</td>
</tr>
<tr>
<td style="text-align:center">0x90007</td>
<td style="text-align:center">1</td>
<td style="text-align:left">å­—ç¬¦åˆ—æ•°</td>
</tr>
<tr>
<td style="text-align:center">0x90008</td>
<td style="text-align:center">2</td>
<td style="text-align:left">æœªçŸ¥</td>
</tr>
<tr>
<td style="text-align:center">0x9000A</td>
<td style="text-align:center">1</td>
<td style="text-align:left">æ˜¾ç¤ºå†…å­˜</td>
</tr>
<tr>
<td style="text-align:center">0x9000B</td>
<td style="text-align:center">1</td>
<td style="text-align:left">æ˜¾ç¤ºçŠ¶æ€</td>
</tr>
<tr>
<td style="text-align:center">0x9000C</td>
<td style="text-align:center">2</td>
<td style="text-align:left">æ˜¾å¡ç‰¹æ€§å‚æ•°</td>
</tr>
<tr>
<td style="text-align:center">0x9000E</td>
<td style="text-align:center">1</td>
<td style="text-align:left">å±å¹•è¡Œæ•°</td>
</tr>
<tr>
<td style="text-align:center">0x9000F</td>
<td style="text-align:center">1</td>
<td style="text-align:left">å±å¹•åˆ—æ•°</td>
</tr>
<tr>
<td style="text-align:center">0x90080</td>
<td style="text-align:center">16</td>
<td style="text-align:left">ç¡¬ç›˜0å‚æ•°</td>
</tr>
<tr>
<td style="text-align:center">0x90090</td>
<td style="text-align:center">16</td>
<td style="text-align:left">ç¡¬ç›˜1å‚æ•°</td>
</tr>
<tr>
<td style="text-align:center">0x901FC</td>
<td style="text-align:center">2</td>
<td style="text-align:left">æ ¹è®¾å¤‡å·</td>
</tr>
</tbody>
</table>
<p>è¿™äº›åœ°å€ä¹Ÿéƒ½æ˜¯çº¦å®šå¥½çš„ï¼Œåé¢éœ€è¦ç”¨çš„æ—¶å€™ä»è¿™é‡Œè·å–å³å¯</p>
<p>æ¥ä¸‹æ¥éœ€è¦ä¸ºè¿›å…¥ä¿æŠ¤æ¨¡å¼åšå‡†å¤‡äº†</p>
<p>é¦–å…ˆæ˜¯å…³é—­ä¸­æ–­</p>
<pre tabindex="0"><code class="language-assembly" data-lang="assembly">; now we want to move to protected mode ...
cli       ; no interrupts allowed
</code></pre><p>BIOS ä¸­æ–­è‡³æ­¤å°±ä¸å†è°ƒç”¨äº†ï¼Œæ¥ä¸‹æ¥ä¼šç”¨æ“ä½œç³»ç»Ÿçš„ä¸­æ–­è¦†ç›–æ­¤å‰ BIOS æä¾›çš„ä¸­æ–­å‘é‡è¡¨</p>
<p>ä¸è¿‡é¦–å…ˆæˆ‘ä»¬éœ€è¦å°†æ“ä½œç³»ç»Ÿç§»åŠ¨åˆ°æ­£ç¡®çš„åœ°å€</p>
<pre tabindex="0"><code class="language-assembly" data-lang="assembly">; first we move the system to it's rightful place
mov ax, #0x0000
cld                 ; 'direction'=0, movs moves forward
do_move:
  mov es, ax        ; destination segment
  add ax, #0x1000
  cmp ax, #0x9000
  jz end_move
  mov ds, ax        ; source segment
  sub di, di
  sub si, si
  mov cx, #0x8000
  rep movsw
  jmp do_move

; then we load the segment descriptors
end_move:
  ...
</code></pre><p>è¿™é‡Œåšçš„æ“ä½œä¸ä¹‹å‰ä» <code>0x7C00</code> æŒªåˆ° <code>0x90000</code> æ˜¯ç±»ä¼¼çš„ï¼Œè¿™é‡Œçš„æ•ˆæœå°±æ˜¯å°† <code>0x10000 ~ 0x90000</code> çš„å†…å­˜ï¼ˆå 240 ä¸ªæ‰‡åŒºçš„ä»£ç ï¼‰ç§»åŠ¨åˆ° <code>0x0 ~ 0x80000</code>ï¼ˆç”¨äº†ä¸ª <code>while</code> å¾ªç¯ï¼Œæ¯æ¬¡æŒª <code>0x10000</code> å­—èŠ‚ï¼‰</p>
<h3 id="æ®µå¯„å­˜å™¨çš„å†å²åŒ…è¢±">æ®µå¯„å­˜å™¨çš„å†å²åŒ…è¢±</h3>
<p>å®æ¨¡å¼ä¸‹çš„æ®µåŸºå€ï¼š</p>
<p>$[ds:3] = (ds &laquo; 4) + 3$</p>
<p>ä¿æŠ¤æ¨¡å¼ä¸‹çš„æ®µä¿æŠ¤å­åˆ™å¤æ‚å¤šäº†ï¼Œå› ä¸ºä½¿ç”¨äº†åˆ†æ®µæœºåˆ¶ï¼Œè¯¥æœºåˆ¶ä¸‹æ®µ<strong>å¯„å­˜å™¨ä¸­å­˜æ”¾çš„æ˜¯æ®µé€‰æ‹©å­ï¼Œä½¿ç”¨æ®µé€‰æ‹©å­åˆ°æ®µæè¿°ç¬¦è¡¨ï¼ˆGDT, Global Descriptor Tableï¼‰ä¸­æ‰¾åˆ°æ‰€éœ€è¦çš„æ®µæè¿°ç¬¦ï¼Œæ®µæè¿°ç¬¦ä¸­å­˜æ”¾çš„æ˜¯çœŸæ­£çš„æ®µåŸºå€ï¼Œè¯¥åœ°å€å†åŠ ä¸Šåç§»å¾—åˆ°ç‰©ç†åœ°å€</strong></p>
<pre tabindex="0"><code>Linear Address Space
+------------------+ &lt;- GDTR (a register)
| Descriptor Table |
|                  |
|                  |
|                  |
|  +------------+  |
|  | Descriptor |&lt;-|------------+
|  +------------+  |            |
|        |         |            |
+------------------+            |
         |                      |
         V                  Selector:Offset (Logical Address)
+------------------+                   |
|     Segment      |                   |
|                  |                   |
|  +------------+  |                   |
|  |    Data    |&lt;-|-------------------+
|  +------------+  |
|                  |
|                  |
|                  |
|                  |
+------------------+
</code></pre><p>æ‰€ä»¥ï¼Œè¦æƒ³è¿›å…¥ä¿æŠ¤æ¨¡å¼ï¼Œå¿…é¡»è¦å¯¹å¯»å€éƒ¨åˆ†è¿›è¡Œåˆå§‹åŒ–</p>
<pre tabindex="0"><code>; Then we load the segment descriptors
lidt idt_48   ; load idt with 0, 0
lgdt gdt_48   ; load gdt with whatever appropriate
</code></pre><p>åœ¨æºç æœ«å°¾å¯ä»¥çœ‹åˆ° <code>idt_48</code> å’Œ <code>gdt_48</code> çš„å®šä¹‰</p>
<pre tabindex="0"><code>idt_48:
  .word 0     ; idt limit = 0
  .word 0, 0  ; idt base = 0L

gdt_48:
  .word 0x800 ; gdt limit = 0x800, 256 GDT entries
  .word 512+gdt, 0x9  ; get base = 0x9XXXX
</code></pre><p>è¿™é‡Œ <code>gdt_48</code> æ˜¯ä¸€ä¸ª 48 ä½æ•°æ®ï¼Œå…¶ä¸­ï¼Œé«˜ 32 ä½å­˜å‚¨äº†å…¨å±€æè¿°ç¬¦è¡¨ gdt çš„å†…å­˜åœ°å€ï¼Œä½ 16 ä½åˆ™ä¸ºè¡¨ç•Œé™</p>
<pre tabindex="0"><code>gdt_48:
high                low
+-------------+-------+
| 00 09 xx xx | 08 00 |
+-------------+-------+
</code></pre><p>è¿™é‡Œ <code>gdt</code> çš„åœ°å€æ‰‹åŠ¨åŠ ä¸Šäº† <code>0x90200</code> çš„åç§»</p>
<p>æŒ‡ä»¤ <code>lgdt</code> çš„ç”¨å¤„å°±æ˜¯å°† <code>gdt</code> ä½ç½®ä¿¡æ¯å­˜å…¥ <code>gdtr</code> å¯„å­˜å™¨</p>
<p><code>gdt</code> æ ‡ç­¾ä¹Ÿåœ¨æºç çš„æœ€åï¼Œè¿™å°±æ˜¯ <code>gdt</code> è¡¨ä¸­çš„çœŸå®æ•°æ®äº†</p>
<pre tabindex="0"><code>gdt:
  .word 0, 0, 0, 0  ; dummy
  .word 0x07FF      ; 8Mb - limit=2047 (2048 * 4096 = 8Mb)
  .word 0x0000      ; base address = 0
  .word 0x9A00      ; code read/exec
  .word 0x00C0      ; granularity=4096, 386

  .word 0x07FF      ; 8Mb - limit=2047 (2048 * 4096 = 8Mb)
  .word 0x0000      ; base address = 0
  .word 0x9200      ; data read/exec
  .word 0x00C0      ; granularity=4096, 386
</code></pre><p>è¿™é‡Œå†™äº†ä¸‰ä¸ªæ®µæè¿°ç¬¦ï¼Œæ®µæè¿°ç¬¦çš„å…·ä½“ç»“æ„å¦‚ä¸‹ (from Wiki Pedia)</p>
<p><figure 
	>
	<a href="/image/580px-SegmentDescriptor.svg.png" >
		<img src="/image/580px-SegmentDescriptor.svg.png"
			
			
			
			loading="lazy"
			>
	</a>
	
</figure></p>
<blockquote>
<p>Base Address</p>
<blockquote>
<p>Starting memory address of the segment. Its length is 32 Bit and it is created of the lower Part Bit 16 to 31, and the upper Part Bit 0 to 7, followed by Bit 24 to 31.</p>
</blockquote>
<p>Segment Limit</p>
<blockquote>
<p>Its length is 20 bit and is created of the lower Part Bit 0 to 15 and the upper Part Bit 16 to 19. It defines the address of the last accessible data. The length is one more than the value stored here. How exactly this should be interpreted depends on the Granularity bit of the segment descriptor.</p>
</blockquote>
<p>G=Granularity</p>
<blockquote>
<p>If clear, the limit is in units of bytes, with a maximum of 220 bytes. If set, the limit is in units of 4096-byte pages, for a maximum of 232 bytes.</p>
</blockquote>
<p>D/B</p>
<blockquote>
<p>D = Default operand size : If clear, this is a 16-bit code segment; if set, this is a 32-bit segment.</p>
</blockquote>
<blockquote>
<p>B = Big: If set, the maximum offset size for a data segment is increased to 32-bit 0xffffffff. Otherwise it&rsquo;s the 16-bit max 0x0000ffff. Essentially the same meaning as &ldquo;D&rdquo;.</p>
</blockquote>
<p>L=Long</p>
<blockquote>
<p>If set, this is a 64-bit segment (and D must be zero), and code in this segment uses the 64-bit instruction encoding. &ldquo;L&rdquo; cannot be set at the same time as &ldquo;D&rdquo; aka &ldquo;B&rdquo;. (Bit 21 in the image)</p>
</blockquote>
<p>AVL=Available</p>
<blockquote>
<p>For software use, not used by hardware (Bit 20 in the image with the label A)</p>
</blockquote>
<p>P=Present</p>
<blockquote>
<p>If clear, a &ldquo;segment not present&rdquo; exception is generated on any reference to this segment</p>
</blockquote>
<p>DPL=Descriptor privilege level</p>
<blockquote>
<p>Privilege level (ring) required to access this descriptor</p>
</blockquote>
<p>Type</p>
<blockquote>
<p>If set, this is a code segment descriptor. If clear, this is a data/stack segment descriptor, which has &ldquo;D&rdquo; replaced by &ldquo;B&rdquo;, &ldquo;C&rdquo; replaced by &ldquo;E&quot;and &ldquo;R&rdquo; replaced by &ldquo;W&rdquo;. This is in fact a special case of the 2-bit type field, where the preceding bit 12 cleared as &ldquo;0&rdquo; refers to more internal system descriptors, for LDT, LSS, and gates.</p>
</blockquote>
<p>C=Conforming</p>
<blockquote>
<p>Code in this segment may be called from less-privileged levels.</p>
</blockquote>
<p>E=Expand-Down</p>
<blockquote>
<p>If clear, the segment expands from base address up to base+limit. If set, it expands from maximum offset down to limit, a behavior usually used for stacks.</p>
</blockquote>
<p>R=Readable</p>
<blockquote>
<p>If clear, the segment may be executed but not read from.</p>
</blockquote>
<p>W=Writable</p>
<blockquote>
<p>If clear, the data segment may be read but not written to.</p>
</blockquote>
<p>A=Accessed</p>
<blockquote>
<p>This bit is set to 1 by hardware when the segment is accessed, and cleared by software.</p>
</blockquote>
</blockquote>
<p>æ ¹æ®ä¸Šè¿°ä¿¡æ¯ï¼Œå¯ä»¥å¯¹åº”åˆ°ä¸‰ä¸ªæè¿°ç¬¦</p>
<p>ç¬¬ä¸€ä¸ªä¸ºç©º</p>
<p>æ ¹æ®é«˜ 22 ä½ (B/D) è¡¨ç¤ºä»£ç æ®µæˆ–æ•°æ®æ®µï¼Œå¯çŸ¥ç¬¬äºŒä¸ªä¸ºä»£ç æ®µæè¿°ç¬¦ï¼Œç¬¬ä¸‰ä¸ªä¸ºæ•°æ®æ®µæè¿°ç¬¦ï¼ŒåŸºå€å‡ä¸º 0ï¼ˆè¿™æ ·è®¾ç½®ï¼Œåœ¨ä¿æŠ¤æ¨¡å¼çš„å¯»å€ç»“æœä¸­ï¼Œç‰©ç†åœ°å€ä¸é€»è¾‘åœ°å€å®Œå…¨ç›¸åŒï¼‰</p>
<p>å¦ä¸€ä¸ªé‡è¦çš„ä¸œè¥¿æ˜¯ <code>idt</code> ï¼ˆä¸­æ–­æè¿°ç¬¦è¡¨ï¼‰ï¼ŒåŒæ ·æœ‰ä¸€ä¸ª <code>idtr</code> æŒ‡å‘ <code>idt</code>ï¼ŒåŸç†ä¸ <code>gdt</code> ç›¸åŒï¼Œæ­¤å¤„æŒ‡ä»¤æš‚æ—¶å°† <code>idtr</code> æ¸…ç©ºäº†ï¼Œåé¢æ‰ä¼šé‡æ–°è®¾ç½®</p>
<p>åœ¨è¿›å…¥ä¿æŠ¤æ¨¡å¼å‰ï¼Œå†çœ‹ä¸€ä¸‹æ­¤æ—¶çš„å†…å­˜æƒ…å†µï¼š</p>
<pre tabindex="0"><code>+--------------+ &lt;- 0x00000
|    system    |
| from 6 ~ 246 |
+--------------+ &lt;- 0x80000
|     ...      |
+--------------+ &lt;- 0x90000
|  Some  Data  |
+--------------+ &lt;- 0x90200
|              |
|   setup.s    |
|     idt      | &lt;- idtr
|     gdt      | &lt;- gdtr
|              |
+--------------+
|     ...      |
+--------------+
|     Stack    |
+--------------+ &lt;- 0x9FF00
</code></pre><h3 id="ä¿æŠ¤æ¨¡å¼æ¼«é•¿çš„å‰æ‘‡ç®€å•çš„åˆ‡æ¢">ä¿æŠ¤æ¨¡å¼ï¼šæ¼«é•¿çš„å‰æ‘‡ï¼Œç®€å•çš„åˆ‡æ¢</h3>
<p>èµ‹å€¼å®Œ <code>idtr</code> å’Œ <code>gdtr</code> åï¼Œè¦æ‰“å¼€ <code>A20</code> åœ°å€çº¿</p>
<pre tabindex="0"><code>; that was painless, now we enable A20
call empty_8042
mov al, #0xD1     ; command write
out #0x64, al
call empty_8042
mov al, #0xDF     ; A20 on
out #0x60, al
call empty_8042
</code></pre><blockquote>
<p>about <code>empty_8042</code>: This routine checks that the keyboard command queue is empty. No timeout is used - if this hangs there is someting wrong with the machine, and we probably couldn&rsquo;t proceed anyway.</p>
</blockquote>
<p>ç®€å•æ¥è¯´å°±æ˜¯æ£€æŸ¥è¾“å…¥ç¼“å†²åŒºæ˜¯å¦ä¸ºç©ºï¼Œå¯ä»¥å¿½ç•¥</p>
<p>æ‰“å¼€ <code>A20</code> åœ°å€çº¿è¿™é‡Œå…¶å®åˆæ˜¯å¯¹ CPU çš„æ§åˆ¶äº†ï¼Œ32 ä½ CPU è€ƒè™‘åˆ°å…¼å®¹æ€§ï¼Œå¿…é¡»æ‰‹åŠ¨è®¾ç½®æ‰èƒ½å¼€å¯ 32 ä½æ¨¡å¼ï¼Œè¿™é‡Œå°±æ˜¯æ‰‹åŠ¨è®¾ç½®ç¯èŠ‚</p>
<pre tabindex="0"><code>; Now we have to reprogram the interrupts.
; We put them right after the intel-reserved hardware interrupts, at int 0x20-0x2F.
; There they won't mess up anything.
; Sadly IBM really messed this up with the original PC, and they haven't been able to rectify it afterwards.
; Thus th bios puts interrupts at 0x08-0x0F, witch is used for the internal hardware interrupts as well.
; We just have to reprogram the 8259's, and it isn't fun.

  mov al,#0x11        ; initialization sequence
                      ; å…¶ä¸­ 0x11 è¡¨ç¤ºåˆå§‹åŒ–å‘½ä»¤çš„å¼€å§‹ï¼ŒICW1 å‘½ä»¤å­—ï¼Œè¡¨ç¤ºè¾¹æ²¿è§¦å‘ã€å¤šç‰‡ 8259 çº§è¿ï¼Œæœ€åå‘é€ ICW4 å‘½ä»¤å­—
  out #0x20,al        ; send it to 8259A-1
                      ; å°†å‘½ä»¤å‘é€è‡³èŠ¯ç‰‡ 8259A-1
  .word   0x00eb,0x00eb       ; jmp $+2, jmp $+2
                      ; è¿™ä¸¤æ¡æŒ‡ä»¤ç›¸å½“äº nopï¼Œç”¨äºå»¶æ—¶ï¼Œç›´æ¥ç”¨æœºå™¨è¯­è¨€çš„å†™æ³•æŒºæœ‰æ„æ€
  out #0xA0,al        ; and to 8259A-2
                      ; åŒæ ·ä¹Ÿç»™ 8259A-2 èŠ¯ç‰‡
  .word   0x00eb,0x00eb
  mov al,#0x20        ; start of hardware int's (0x20)
  out #0x21,al        ; è¿™é‡Œ 0x21 æ˜¯ 8259A-1ï¼ˆä¸»èŠ¯ç‰‡ï¼‰ï¼Œ0xA1 æ˜¯ 8259A-2ï¼ˆä»èŠ¯ç‰‡ï¼‰
                      ; è®¾ç½®èµ·å§‹ä¸­æ–­å·ä¸º 0x20
  .word   0x00eb,0x00eb
  mov al,#0x28        ; start of hardware int's 2 (0x28)
  out #0xA1,al        ; è®¾ç½®ä»èŠ¯ç‰‡èµ·å§‹ä¸­æ–­å·ä¸º 0x28
  .word   0x00eb,0x00eb
  mov al,#0x04        ; 8259-1 is master
  out #0x21,al        ; è¿™é‡Œè®¾ç½®çš„ä¸»ä»èŠ¯ç‰‡ï¼ŒICW3 å‘½ä»¤å­—å°†ä¸»èŠ¯ç‰‡çš„ IR2 è¿æ¥ä»èŠ¯ç‰‡çš„ INT
  .word   0x00eb,0x00eb
  mov al,#0x02        ; 8259-2 is slave
  out #0xA1,al        ; å°†ä»èŠ¯ç‰‡çš„ INT è¿åˆ°ä¸»èŠ¯ç‰‡çš„ IR2
  .word   0x00eb,0x00eb
  mov al,#0x01        ; 8086 mode for both
  out #0x21,al
  .word   0x00eb,0x00eb
  out #0xA1,al        ; å‘ä¸»ä»èŠ¯ç‰‡å‘é€ ICW4 å‘½ä»¤å­—ï¼Œè¿›å…¥ 8086 æ¨¡å¼
  .word   0x00eb,0x00eb
  mov al,#0xFF        ; mask off all interrupts for now
  out #0x21,al
  .word   0x00eb,0x00eb
  out #0xA1,al        ; å±è”½ä¸»ä»èŠ¯ç‰‡æ‰€æœ‰ä¸­æ–­è¯·æ±‚
</code></pre><p>è¿™é‡Œéƒ½æ˜¯å¯¹å¯ç¼–ç¨‹ç»ˆç«¯æ§åˆ¶å™¨ 8259 èŠ¯ç‰‡è¿›è¡Œçš„ç¼–ç¨‹ï¼Œæ•´åˆäº†ä¸€ä¸‹ä¸­æ–‡æ³¨é‡Šï¼ˆfrom <code>github.com/beride/linux0.11-1</code>ï¼‰</p>
<p>å‰æ‘‡å¾ˆé•¿ï¼Œä½†çœŸæ­£çš„åˆ‡æ¢åªæœ‰ä¸‹é¢å‡ è¡Œ</p>
<pre tabindex="0"><code class="language-assembly" data-lang="assembly">mov ax, #0x0001   ; protected mode (PE) bit
lmsw ax           ; This is it
jmpi 0, 8         ; jmp offset 0 of segment 8 (cs)
</code></pre><p><code>lmsw</code> å‘½ä»¤å°† <code>cr0</code> å¯„å­˜å™¨çš„æœ«å°¾ï¼ˆPEï¼‰èµ‹å€¼ä¸º <code>ax=1</code>ï¼Œè¿™å°±å¼€å¯ä¿æŠ¤æ¨¡å¼äº†</p>
<p>è€Œè¿™ä¸ª <code>jmpi</code> å‘½ä»¤ä¸­è¿‡ï¼Œåé¢çš„ <code>8</code> è¡¨ç¤ºæ˜¯æ®µé€‰æ‹©å­ï¼Œ<code>0</code> è¡¨ç¤ºåç§»åœ°å€ï¼Œè¿™é‡Œçš„ç´¢å¼•æ–¹å¼å·²ç»å˜æˆäº†ä¿æŠ¤æ¨¡å¼ä¸‹çš„ç´¢å¼•æ–¹å¼äº†ï¼Œæ‰€ä»¥æ ¹æ®æ®µé€‰æ‹©å­çš„ç»“æ„ï¼Œæè¿°ç¬¦ç´¢å¼•ä¸º <code>1</code>ï¼Œæ ¹æ®ä¹‹å‰å¯¹ <code>gdt</code> çš„å®šä¹‰ï¼Œå¯¹åº”çš„æè¿°ç¬¦æ˜¯</p>
<pre tabindex="0"><code>.word 0x7FFF  ; 8Mb - limit = 2047
.word 0x0000  ; base address = 0
.word 0x9A00  ; code read/exec
.word 0x00C0  ; granularity=4096, 386
</code></pre><p>æ‰€ä»¥è¿™é‡Œçš„æ®µé€‰æ‹©å­æŒ‡å‘çš„æ˜¯ä»£ç æ®µæè¿°ç¬¦ï¼Œæ®µåŸºå€ä¸º <code>0</code>ï¼Œæ‰€ä»¥æœ€ç»ˆç»“æ„ä¸ºè·³è½¬åˆ°åœ°å€ä¸º <code>0</code> ç»§ç»­æ‰§è¡Œ</p>
<p>æ ¹æ®æ­¤å‰çš„åœ°å€è®¾ç½®ï¼Œ<code>0</code> è¿™ä¸ªåœ°å€å°±æ˜¯ 240 ä¸ªæ‰‡åŒºçš„æŒ‡ä»¤ï¼Œå¯¹åº” <code>head.s</code> å’Œ <code>main.c</code> åŠå…¶ä»–å„æ¨¡å—çš„æ“ä½œç³»ç»Ÿä»£ç </p>
<p>åˆ°è¿™é‡Œï¼Œå°±è¦æ­£å¼è¿›å…¥æ“ä½œç³»ç»Ÿäº†</p>
<h2 id="æ€»ç®—æ˜¯è¿›å…¥æ“ä½œç³»ç»Ÿäº†">æ€»ç®—æ˜¯è¿›å…¥æ“ä½œç³»ç»Ÿäº†</h2>
<h3 id="å†æ¥ä¸€æ¬¡åˆå§‹åŒ–-heads">å†æ¥ä¸€æ¬¡åˆå§‹åŒ– (head.s)</h3>
<p>æ­£ç»çš„æºç åœ¨è¿™é‡Œæ¢æˆäº† <code>AT&amp;T</code> æ ¼å¼ï¼Œå¾ˆçƒ¦ï¼Œè¿˜å¥½å¤§ä½¬çš„æ–‡ç« è¿˜æ˜¯ç”¨çš„ <code>intel</code> æ ¼å¼</p>
<pre tabindex="0"><code class="language-assembly" data-lang="assembly">_pg_dir:
_setartup_32:
  mov eax, 0x10
  mov ds, ax
  mov es, ax
  mov fs, ax
  mov gs, ax
  lss esp, _stack_start
</code></pre><p><code>_pg_dir</code> è¡¨ç¤ºé¡µç›®å½•ï¼Œè®¾ç½®åˆ†é¡µæœºåˆ¶çš„æ—¶å€™ä¼šç”¨åˆ°</p>
<p>å°† <code>ds</code> åˆ° <code>gs</code> å››ä¸ªæ®µå¯„å­˜å™¨éƒ½èµ‹å€¼ä¸º <code>0x10</code>ï¼ŒæŒ‰ç…§æ®µé€‰æ‹©å­ï¼Œè¿™å‡ ä¸ªæ®µå¯„å­˜å™¨éƒ½æŒ‡å‘äº†æ­¤å‰ <code>gdt</code> ä¸­ï¼Œæè¿°ç¬¦ç´¢å¼•ä¸º <code>2</code> çš„æè¿°ç¬¦ï¼Œä¹Ÿå°±æ˜¯æ•°æ®æ®µæè¿°ç¬¦</p>
<p><code>lss</code> æŒ‡ä»¤ç›¸å½“äºè®© <code>ss:esp</code> æ ˆé¡¶æŒ‡é’ˆæŒ‡å‘ <code>_stack_start</code>ï¼Œè¿™åœ¨ <code>sched.c</code> ä¸­å®šä¹‰</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#66d9ef">long</span> user_stack[<span style="color:#ae81ff">4096</span> <span style="color:#f92672">&gt;&gt;</span> <span style="color:#ae81ff">2</span>];

<span style="color:#66d9ef">struct</span> {
  <span style="color:#66d9ef">long</span> <span style="color:#f92672">*</span>a;
  <span style="color:#66d9ef">short</span> b;
} stack_start <span style="color:#f92672">=</span> {<span style="color:#f92672">&amp;</span>user_stack[<span style="color:#ae81ff">4096</span> <span style="color:#f92672">&gt;&gt;</span> <span style="color:#ae81ff">2</span>], <span style="color:#ae81ff">0x10</span>};
</code></pre></div><p>æ ¹æ®è¿™ä¸ªå®šä¹‰ï¼Œ<code>0x10</code> å°†ä¼šèµ‹å€¼ç»™ <code>ss</code> å¯„å­˜å™¨ï¼ˆä¾ç„¶æ˜¯æ•°æ®æ®µæè¿°ç¬¦ï¼ŒåŸºå€ä¸º <code>0</code>ï¼‰ï¼Œè€Œ <code>user_stack</code> çš„æœ€åä¸€ä¸ªåœ°å€çš„åä¸€ä¸ªåœ°å€å°†ä¼šèµ‹å€¼ç»™ <code>esp</code>ï¼Œæ‰€ä»¥è¿™ä¸ª <code>user_stack</code> å°±æ˜¯åé¢ç”¨åˆ°çš„æ ˆäº†</p>
<pre tabindex="0"><code class="language-assembly" data-lang="assembly">call setup_idt
call setup_gdt
mov eax, 0x10
mov ds, ax
mov es, ax
mov fs, ax
mov gs, ax
lss esp, _stack_start
</code></pre><p>æ‰§è¡Œäº†è®¾ç½® <code>idt</code> å’Œ <code>gdt</code> çš„å‡½æ•°åï¼ŒåˆæŠŠåˆšæ‰çš„æŒ‡ä»¤æ‰§è¡Œäº†ä¸€é</p>
<p>è¿™é‡Œçš„ <code>setup_idt</code> å­ç¨‹åºå¦‚ä¸‹</p>
<pre tabindex="0"><code class="language-assembly" data-lang="assembly">; set up a idt with 256 entries pointint to ignore_int, interrupt gates.
; It then loads idt.
; Everything that wants to install itself in the idt-table may do so themselves.
; Interrupts are enabled elsewhere, when we can be relatively sure everything is ok.
; This routine whil be over-written by the page tables.
setup_idt:
  lea edx, ignore_int
  mov eax, 0x00080000
  mov ax, dx      ; selector = 0x0008 = cs
  mov dx, 0x8E00  ; interrupt gate - dpl=0, present
  lea edi, _idt
  mov ecx, 0x100
  rp_sidt:
    mov [edi], eax
    mov [edi+4], edx
    add edi, 8
    dec ecx
    jne rp_sidt
  lidt fword ptr idt_descr
  ret

idt_descr:
  dw 256 * 8 - 1
  dd _idt

_idt:
  DQ 256 dup(0)
</code></pre><p>ä½¿ç”¨äº†ä¸€ä¸ª <code>0x100</code> æ¬¡çš„ <code>do while</code> å¾ªç¯å¯¹ <code>_idt</code> è¿›è¡Œåˆå§‹åŒ–ï¼Œæ¯ä¸€æ¬¡å¾ªç¯è®¾ç½®ä¸€ä¸ªä¸­æ–­æè¿°ç¬¦ï¼Œå€¼å‡ä¸º <code>00 00 8E 00 00 08 ignore_int</code> ï¼ˆåœ°å€ç”±é«˜åˆ°ä½ï¼‰ï¼Œå› æ­¤æ‰€æœ‰çš„ <code>idt</code> å‡æŒ‡å‘äº† <code>ignore_int</code> å‡½æ•°ï¼ˆé»˜è®¤ä¸­æ–­å‡½æ•°ï¼‰ï¼Œåé¢ä¼šé€æ¸æ›¿æ¢</p>
<p><code>setup_gdt</code> å¦‚ä¸‹</p>
<pre tabindex="0"><code class="language-assembly" data-lang="assembly">setup_gdt:
  lgdt gdt_descr
  ret
</code></pre><p>æ¯”è¾ƒç®€å•ï¼Œå°±æ˜¯å°† <code>gdt_descr</code> åŠ è½½åˆ° <code>gdtr</code></p>
<p>é•¿è¿™æ ·ï¼š</p>
<pre tabindex="0"><code>gdt_descr:
  .word 256 * 8 - 1         ; so does gdt (not that that's any
  .long _gdt                ; magic number, but it works for me :^)

  .align 3
_idt:
  .fill 256, 8, 0           ; idt is uninitialized

_gdt:
  .quad 0x0000000000000000  ; NULL descriptor
  .quad 0x00c09a0000000fff  ; 16Mb
  .quad 0x00c0920000000fff  ; 16Mb
  .quad 0x0000000000000000  ; TEMPORARY - don't use
  .fill 252, 8, 0
</code></pre><p>å¯ä»¥çœ‹åˆ°ï¼Œç»™ <code>idt</code> å’Œ <code>gdt</code> éƒ½é¢„ç•™äº† <code>256 * 8</code> å­—èŠ‚çš„ç©ºé—´ï¼Œè€Œ <code>gdt</code> çš„åˆå§‹å€¼ä¸º <code>NULL descriptor</code>ï¼Œå…± 64 é¡¹</p>
<blockquote>
<p>è¿™é‡Œé‡æ–°è®¾ç½®çš„åŸå› åœ¨äºæ­¤å‰çš„å†…å­˜å·²ç»ä¸å†ä½¿ç”¨ï¼ˆå¯ä»¥ç†è§£ä¸º <code>setup</code> éƒ¨åˆ†å çš„å†…å­˜è¢« free æ‰äº†ï¼‰ï¼Œåç»­å°†ç”¨äºå­˜æ”¾å…¶ä»–å†…å®¹ï¼Œå› æ­¤éœ€è¦å°† <code>idtr</code> å’Œ <code>gdtr</code> æŒ‡å‘è¿™ä¸ªæ–°çš„ <code>idt</code> å’Œ <code>gdt</code> è¡¨</p>
</blockquote>
<h3 id="å¼€å¯åˆ†é¡µæœºåˆ¶">å¼€å¯åˆ†é¡µæœºåˆ¶</h3>
<p>åœ¨æ‰§è¡Œå®Œä¸Šé¢çš„ä»£ç åï¼Œæ˜¯ä¸€äº›ç®€å•çš„æ£€æŸ¥ï¼š</p>
<p>æ£€æŸ¥ A20 å¼€å¯ï¼ˆè¿›å…¥ä¿æŠ¤æ¨¡å¼ï¼‰</p>
<pre tabindex="0"><code class="language-assembly" data-lang="assembly">1:
  incl eax
  movl 0x000000, eax
  cmpl 0x100000, eax
  je 1b
</code></pre><p>æ£€æŸ¥èŠ¯ç‰‡è®¾ç½®</p>
<pre tabindex="0"><code class="language-assembly" data-lang="assembly">; 486 should set bit 16, to check for wirte-protect in supervisor mode.
; Then it would be unnecessary with the &quot;verify_area()&quot;-calls.
; 486 users probably want to set the NE (#5) bit also, so as to use int 16 for math errors.
movl eax, cr0         ; check math chip
andl 0x80000011, eax  ; Save PG, ET, PE
orl eax, 2            ; set MP
testl eax, 0x10
jne 1f                ; ET is set - 387 is present
xorl eax, 6           ; else reset MP and set EM
1: 
  movl cr0, eax
  jmp after_page_tables
</code></pre><p>åœ¨åšå®ŒåŸºæœ¬æ£€æŸ¥åï¼Œå°†è·³è½¬åˆ°åˆ†é¡µæ¨¡å¼</p>
<pre tabindex="0"><code class="language-assembly" data-lang="assembly">after_page_tables:
  pushl 0
  pushl 0
  pushl 0
  pushl L6
  pushl _main             ; è¿™é‡Œçš„å‹æ ˆç”¨äºåç»­è·³è½¬åˆ° _main
  jmp setup_paging
L6:
  jmp L6

setup_paging:
  movl ecx, 1024 * 5      ; 5 pages - pg_dir+4 page tables
  xorl eax, eax
  xorl edi, edi           ; pg_dir is at 0x000
  cld;rep;stosl
  movl eax, _pg_dir
  movl [_pg_dir]   , pg0+7  ; set present bit/user r/w
  movl [_pg_dir+4] , pg1+7
  movl [_pg_dir+8] , pg2+7
  movl [_pg_dir+12], pg3+7
  movl edi, pg3+4092
  movl eax, 0xfff007  ; 16Mb - 4096 + 7 (r/w user, p)
  std
1:
  stosl               ; fill pages backward - more efficient
  subl eax, 0x1000
  jge 1b
  xorl eax, eax       ; pg_dir is at 0x0000
  movl cr3, eax       ; cr3 - page directory start
  movl eax, cr0
  orl eax, 0x80000000
  movl cr0, eax       ; set paging (PG) bit
  ret                 ; this also flushes prefetch-queue
</code></pre><p>å¼€å¯åˆ†é¡µæœºåˆ¶çš„è®¾ç½®åœ¨ <code>ret</code> å‰çš„æœ€åä¸‰æ¡æŒ‡ä»¤ä¸Šï¼Œè¿™ä¸‰æ¡æŒ‡ä»¤çš„æ•ˆæœå°±æ˜¯å°† <code>cr0</code> çš„æœ€é«˜ä½ç½®ä¸º <code>1</code>ï¼Œè¿™ä¸€ä½å°±æ˜¯ <code>PG</code> ä½ï¼Œ<code>1</code> è¡¨ç¤ºå¼€å¯åˆ†é¡µæœºåˆ¶</p>
<p>è¿™ä¸ªç‰ˆæœ¬çš„ Linux åªä¸ºå†…å­˜é¢„ç•™äº† <code>16 Mb</code> çš„ç©ºé—´ï¼Œæœ€å¤§åœ°å€ä¸º <code>0xFFFFFF</code>ï¼Œ1 é¡µä¸º <code>4KB</code>ï¼Œ1 é¡µè¡¨ä¸º 1024 é¡µï¼Œ1é¡µè¡¨ç›®å½•ä¸º 1024 é¡µè¡¨ï¼Œå› æ­¤åªéœ€è¦æä¾› 1 é¡µè¡¨ç›®å½•å’Œ 4 é¡µè¡¨å³å¯ï¼Œè¿™ä¹Ÿå°±å¯¹åº”äº†å¼€å¤´ä¸€äº›æŒ‡ä»¤çš„å«ä¹‰</p>
<p><code>mov ecx, 1024 * 5</code> è¡¨ç¤ºæ€»å…±éœ€è¦ 5 é¡µï¼Œè€Œ <code>pg_dir</code> å°±æˆåŠŸä¸ä¸Šæ–‡ <code>head.s</code> å¼€å¤´å‘¼åº”ä¸Šäº†ï¼Œè¿™ä¸ªæ ‡ç­¾å°±æ˜¯é¡µè¡¨ç›®å½•ï¼Œè€Œä¸‹é¢å°†å­˜æ”¾å››ä¸ªé¡µè¡¨</p>
<pre tabindex="0"><code class="language-assembly" data-lang="assembly">.org 0x1000 pg0;
.org 0x2000 pg1;
.org 0x3000 pg2;
.org 0x4000 pg3;
.org 0x5000
</code></pre><p>æ‰€ä»¥åœ¨ç»è¿‡è¿™ä¸€æ­¥è®¾ç½®åï¼Œç‰©ç†å†…å­˜çš„ <code>0x0000-0x5000</code> éƒ½æ˜¯åˆ†é¡µæœºåˆ¶ä½¿ç”¨çš„ç©ºé—´äº†ï¼Œæœ€åå°† <code>cr3</code> èµ‹å€¼ä¸º <code>0</code>ï¼Œå°±æ˜¯æŒ‡å‘äº† <code>pg_dir</code> çš„åœ°å€</p>
<blockquote>
<p>å¼€å¯åˆ†é¡µæœºåˆ¶åï¼Œè¦†ç›–æ‰çš„ç©ºé—´æ˜¯æ­¤å‰åˆå§‹åŒ– idt å’Œ gdt çš„ä»£ç ï¼ˆå ç”¨ç©ºé—´ä¸º <code>0x0000-0x1000</code>ï¼‰</p>
</blockquote>
<p>æ­¤å¤–ï¼Œ<code>pg?+7</code> ä¸­ï¼Œ<code>pg?</code> éƒ¨åˆ†æ˜¯åœ°å€ï¼Œå› ä¸ºåä¸‰ä½å¿…é¡»è¦å¯¹å…¶åˆ° <code>0b000</code>ï¼Œæ‰€ä»¥æ­£å¥½ç”¨äºè¡¨ç¤ºæƒé™ï¼Œ<code>7=0x111</code> å°±è¡¨ç¤ºé¡µå­˜åœ¨ã€ç”¨æˆ·å¯è¯»å†™</p>
<p>åœ¨å¼€å¯åˆ†é¡µæ¨¡å¼åï¼Œç»è¿‡æ­¤å‰åˆ†æ®µæœºåˆ¶è®¡ç®—å¾—åˆ°çš„åœ°å€ä¸ºçº¿æ€§åœ°å€ï¼Œéœ€è¦å†æ¬¡ç»è¿‡åˆ†é¡µæœºåˆ¶è®¡ç®—æ‰èƒ½å¾—åˆ°ç‰©ç†åœ°å€ï¼š</p>
<p>å‰ 10 bit è¡¨ç¤ºé¡µç›®å½•é¡¹çš„ç´¢å¼•ï¼Œä¸­é—´ 10 bit è¡¨ç¤ºé¡µè¡¨é¡¹çš„ç´¢å¼•ï¼Œæœ€å 12 bit è¡¨ç¤ºé¡µå†…çš„åç§»ï¼Œå…ˆæ‰¾å¯¹åº”çš„é¡µç›®å½•é¡¹ï¼Œå†æ‰¾é¡µè¡¨é¡¹ï¼Œæœ€ååŠ ä¸Šç´¢å¼•ï¼Œå°±å¾—åˆ°å®é™…ç‰©ç†åœ°å€äº†</p>
<h3 id="è·³è½¬åˆ°-main">è·³è½¬åˆ° main</h3>
<p>è¿™é‡Œè·³è½¬åˆ° main çš„æ–¹æ³•å’Œ ROP å¾ˆç±»ä¼¼</p>
<pre tabindex="0"><code>after_page_tables:
  ...
  pushl _main
  jmp setup_paging

setup_paging:
  ...
  ret                 ; this also flushes prefetch-queue
</code></pre><p>æŠŠ <code>_main</code> çš„åœ°å€æ”¾åˆ°æ ˆé¡¶ï¼Œç„¶åç”¨ <code>jmp</code> æŒ‡ä»¤è·³è½¬åˆ°å¦ä¸€ä¸ªå­ç¨‹åºï¼Œæ­¤æ—¶å¯¹æ ˆæœ¬èº«æ²¡æœ‰è¿›è¡Œæ”¹å˜ï¼Œè€Œ <code>setup_paging</code> ä½œä¸ºè¢« <code>jmp</code> æ‰§è¡Œçš„ç¨‹åºï¼Œæœ€åå´ <code>ret</code> äº†ï¼Œè¿™å°±ç›¸å½“äºæ‰§è¡Œäº†ä¸€ä¸ª <code>pop eip</code>ï¼Œç»“æœå°±æ˜¯ <code>eip=_main</code></p>
<p>äºæ˜¯æ¥ä¸‹æ¥å°±æ­£å¼å¼€å§‹æ‰§è¡Œ <code>_main</code> å‡½æ•°äº†</p>
<p>æ€»ç»“ä¸€ä¸‹æ­¤æ—¶çš„å†…å­˜æƒ…å†µ</p>
<pre tabindex="0"><code>+--------------+ &lt;- 0x00000 &lt;- cr3
|    pg_dir    |
|     pg 0     |
|     pg 1     |
|     pg 2     |
|     pg 3     |
+--------------+ &lt;- 0x05000
|              |
|    system    |
| from 6 ~ 246 |
|              |
|     idt      | &lt;- idtr
|     gdt      | &lt;- gdtr
|              |
|              |
|     512K     |
|              |
+--------------+ &lt;- 0x80000
|     ...      |
+--------------+ &lt;- 0x90000
|  Some  Data  |
+--------------+ &lt;- 0x90200
|              |
|   setup.s    |
|              |
+--------------+
|     ...      |
+--------------+
|    Stack     |
+--------------+ &lt;- 0x9FF00
</code></pre>
</section>


    <footer class="article-footer">
    
    <section class="article-tags">
        
            <a href="/tags/system/">System</a>
        
            <a href="/tags/rtfsc/">RTFSC</a>
        
            <a href="/tags/reading/">Reading</a>
        
    </section>


    </footer>


    
        <link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/katex@0.13.13/dist/katex.min.css"integrity="sha384-RZU/ijkSsFbcmivfdRBQDtwuwVqK7GMOw6IMvKyeWL2K5UAlyp6WonmB8m7Jd0Hn"crossorigin="anonymous"
            ><script 
                src="https://cdn.jsdelivr.net/npm/katex@0.13.13/dist/katex.min.js"integrity="sha384-pK1WpvzWVBQiP0/GjnvRxV4mOb0oxFuyRxJlk6vVw146n3egcN5C925NCP7a7BY8"crossorigin="anonymous"
                defer="true"
                >
            </script><script 
                src="https://cdn.jsdelivr.net/npm/katex@0.13.13/dist/contrib/auto-render.min.js"integrity="sha384-vZTG03m&#43;2yp6N6BNi5iM4rW4oIwk5DfcNdFfxkk9ZWpDriOkXX8voJBFrAO7MpVl"crossorigin="anonymous"
                defer="true"
                >
            </script><script>
    window.addEventListener("DOMContentLoaded", () => {
        renderMathInElement(document.querySelector(`.article-content`), {
            delimiters: [
                { left: "$$", right: "$$", display: true },
                { left: "$", right: "$", display: false },
                { left: "\\(", right: "\\)", display: false },
                { left: "\\[", right: "\\]", display: true }
            ]
        });})
</script>
    
</article>

    <aside class="related-contents--wrapper">
    
    
        <h2 class="section-title">Related contents</h2>
        <div class="related-contents">
            <div class="flex article-list--tile">
                
                    
<article class="has-image">
    <a href="/post/csapp-labs/">
        
        
            <div class="article-image">
                <img src="/post/csapp-labs/cover.60f2c68d83d56007c5960ebcac35cd70_hu3b8d692d45d6b215e59701d25ac88074_3319905_250x150_fill_q75_box_smart1.jpg" 
                        width="250" 
                        height="150" 
                        loading="lazy"
                        alt="Featured image of post CSAPP Labs"
                        
                        data-hash="md5-YPLGjYPVYAfFlg68rDXNcA==">
                
            </div>
        

        <div class="article-details">
            <h2 class="article-title">CSAPP Labs</h2>
        </div>
    </a>
</article>
                
                    
<article class="has-image">
    <a href="/post/note-of-book-encryption-and-decryption/">
        
        
            <div class="article-image">
                <img src="/post/note-of-book-encryption-and-decryption/cover.c485ea85e1f847123fac81fc1611fb77_huf14a87ae5877971d635f5feb6ec88f93_885732_250x150_fill_q75_box_smart1.jpg" 
                        width="250" 
                        height="150" 
                        loading="lazy"
                        alt="Featured image of post åŠ å¯†ä¸è§£å¯†å­¦ä¹ ç¬”è®°ï¼ˆæŒç»­æ›´æ–°ingï¼‰"
                        
                        data-hash="md5-xIXqheH4RxI/rIH8FhH7dw==">
                
            </div>
        

        <div class="article-details">
            <h2 class="article-title">åŠ å¯†ä¸è§£å¯†å­¦ä¹ ç¬”è®°ï¼ˆæŒç»­æ›´æ–°ingï¼‰</h2>
        </div>
    </a>
</article>
                
            </div>
        </div>
    
</aside>

     
    
        
    

    <footer class="site-footer">
    <section class="copyright">
        &copy;
        
        2022 s0uthwood&#39;s Blog
    
        
            <br />
            å·²è¿è¡Œ <i class="fas fa-bell"></i> <a id="days">0</a> å¤©
        
    
        
            &nbsp;&nbsp;
            
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
            
            âŒ¨&nbsp;
            80.71k&nbsp;
            å­—
            &nbsp;&nbsp;
            ğŸ§ &nbsp;
            35&nbsp;
            ç¯‡æ–‡ç« 
        
    </section>

    <section class="powerby">
        Built with <a href="https://gohugo.io/" target="_blank" rel="noopener">Hugo</a> <br />
        Theme <b><a href="https://github.com/CaiJimmy/hugo-theme-stack" target="_blank" rel="noopener" data-version="3.5.0">Stack</a></b> designed by <a href="https://jimmycai.com" target="_blank" rel="noopener">Jimmy</a>
    </section>

    
        <script>
            var s1 = "2020-11-15";
            s1 = new Date(s1.replace(/-/g, "/"));
            s2 = new Date();
            var days = s2.getTime() - s1.getTime();
            var number_of_days = parseInt(days / (1000 * 60 * 60 * 24));
            document.getElementById('days').innerHTML = number_of_days;
        </script>
    
</footer>


    
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    
    <div class="pswp__bg"></div>

    
    <div class="pswp__scroll-wrap">

        
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                
                
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js"integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo="crossorigin="anonymous"
                defer="true"
                >
            </script><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js"integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU="crossorigin="anonymous"
                defer="true"
                >
            </script><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.css"integrity="sha256-c0uckgykQ9v5k&#43;IqViZOZKc47Jn7KQil4/MP3ySA3F8="crossorigin="anonymous"
            ><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.css"integrity="sha256-SBLU4vv6CA6lHsZ1XyTdhyjJxCjPif/TRkjnsyGAGnE="crossorigin="anonymous"
            >

            </main>
    
        <aside class="sidebar right-sidebar sticky">
            <section class="widget archives">
                <div class="widget-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <line x1="5" y1="9" x2="19" y2="9" />
  <line x1="5" y1="15" x2="19" y2="15" />
  <line x1="11" y1="4" x2="7" y2="20" />
  <line x1="17" y1="4" x2="13" y2="20" />
</svg>



                </div>
                <h2 class="widget-title section-title">Table of contents</h2>
                
                <div class="widget--toc">
                    <nav id="TableOfContents">
  <ul>
    <li><a href="#how-everything-begins-bootsectss">How Everything Begins (bootsects.s)</a>
      <ul>
        <li><a href="#ä»-0x7c00-å¼€å§‹çš„æ“ä½œç³»ç»Ÿå¯åŠ¨">ä» 0x7C00 å¼€å§‹çš„æ“ä½œç³»ç»Ÿå¯åŠ¨</a></li>
        <li><a href="#ç»™è‡ªå·±æŒªä¸ªåœ°æ–¹">ç»™è‡ªå·±æŒªä¸ªåœ°æ–¹</a></li>
        <li><a href="#ä¸€äº›åŸºç¡€å·¥ä½œ">ä¸€äº›åŸºç¡€å·¥ä½œ</a></li>
        <li><a href="#æŠŠç¡¬ç›˜é‡Œçš„å…¶ä»–éƒ¨åˆ†ä¹ŸæŒªè¿‡æ¥">æŠŠç¡¬ç›˜é‡Œçš„å…¶ä»–éƒ¨åˆ†ä¹ŸæŒªè¿‡æ¥</a></li>
      </ul>
    </li>
    <li><a href="#ç»§ç»­å¯åŠ¨-setups">ç»§ç»­å¯åŠ¨ (setup.s)</a>
      <ul>
        <li><a href="#ä¿æŠ¤æ¨¡å¼å‰çš„å‡†å¤‡">ä¿æŠ¤æ¨¡å¼å‰çš„å‡†å¤‡</a></li>
        <li><a href="#æ®µå¯„å­˜å™¨çš„å†å²åŒ…è¢±">æ®µå¯„å­˜å™¨çš„å†å²åŒ…è¢±</a></li>
        <li><a href="#ä¿æŠ¤æ¨¡å¼æ¼«é•¿çš„å‰æ‘‡ç®€å•çš„åˆ‡æ¢">ä¿æŠ¤æ¨¡å¼ï¼šæ¼«é•¿çš„å‰æ‘‡ï¼Œç®€å•çš„åˆ‡æ¢</a></li>
      </ul>
    </li>
    <li><a href="#æ€»ç®—æ˜¯è¿›å…¥æ“ä½œç³»ç»Ÿäº†">æ€»ç®—æ˜¯è¿›å…¥æ“ä½œç³»ç»Ÿäº†</a>
      <ul>
        <li><a href="#å†æ¥ä¸€æ¬¡åˆå§‹åŒ–-heads">å†æ¥ä¸€æ¬¡åˆå§‹åŒ– (head.s)</a></li>
        <li><a href="#å¼€å¯åˆ†é¡µæœºåˆ¶">å¼€å¯åˆ†é¡µæœºåˆ¶</a></li>
        <li><a href="#è·³è½¬åˆ°-main">è·³è½¬åˆ° main</a></li>
      </ul>
    </li>
  </ul>
</nav>
                </div>
            </section>
        </aside>
    

        </div>
        <script 
                src="https://cdn.jsdelivr.net/npm/node-vibrant@3.1.5/dist/vibrant.min.js"integrity="sha256-5NovOZc4iwiAWTYIFiIM7DxKUXKWvpVEuMEPLzcm5/g="crossorigin="anonymous"
                defer="false"
                >
            </script><script type="text/javascript" src="/ts/main.js" defer></script>
<script>
    (function () {
        const customFont = document.createElement('link');
        customFont.href = "https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap";

        customFont.type = "text/css";
        customFont.rel = "stylesheet";

        document.head.appendChild(customFont);
    }());
</script>

    </body>
</html>
