<!DOCTYPE html>
<html lang="en-us">
    <head><meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1'><meta name='description' content='Fabric系统链码部分'><title>Fabric-SystemChaincode</title>

<link rel='canonical' href='/post/fabric-systemchaincode/'>

<link rel="stylesheet" href="/scss/style.min.css"><meta property='og:title' content='Fabric-SystemChaincode'>
<meta property='og:description' content='Fabric系统链码部分'>
<meta property='og:url' content='/post/fabric-systemchaincode/'>
<meta property='og:site_name' content='s0uthwood&#39;s Blog'>
<meta property='og:type' content='article'><meta property='article:section' content='Post' /><meta property='article:tag' content='fabric' /><meta property='article:tag' content='go' /><meta property='article:published_time' content='2020-12-18T13:40:28&#43;00:00'/><meta property='article:modified_time' content='2020-12-18T13:40:28&#43;00:00'/>
<meta name="twitter:title" content="Fabric-SystemChaincode">
<meta name="twitter:description" content="Fabric系统链码部分">
    </head>
    <body class="
    article-page has-toc
">
    <script>
        (function() {
            const colorSchemeKey = 'StackColorScheme';
            if(!localStorage.getItem(colorSchemeKey)){
                localStorage.setItem(colorSchemeKey, "auto");
            }
        })();
    </script><script>
    (function() {
        const colorSchemeKey = 'StackColorScheme';
        const colorSchemeItem = localStorage.getItem(colorSchemeKey);
        const supportDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches === true;

        if (colorSchemeItem == 'dark' || colorSchemeItem === 'auto' && supportDarkMode) {
            

            document.documentElement.dataset.scheme = 'dark';
        } else {
            document.documentElement.dataset.scheme = 'light';
        }
    })();
</script>
<div class="container main-container flex 
    
        extended
    
">
    
        <div id="article-toolbar">
            <a href="/" class="back-home">
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-chevron-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <polyline points="15 6 9 12 15 18" />
</svg>



                <span>Back</span>
            </a>
        </div>
    
<main class="main full-width">
    <article class="main-article">
    <header class="article-header">

    <div class="article-details">
    
    <header class="article-category">
        
            <a href="/categories/fabric/" >
                fabric
            </a>
        
    </header>
    

    <h2 class="article-title">
        <a href="/post/fabric-systemchaincode/">Fabric-SystemChaincode</a>
    </h2>

    
    <h3 class="article-subtitle">
        Fabric系统链码部分
    </h3>
    

    
    <footer class="article-time">
        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M11.795 21h-6.795a2 2 0 0 1 -2 -2v-12a2 2 0 0 1 2 -2h12a2 2 0 0 1 2 2v4" />
  <circle cx="18" cy="18" r="4" />
  <path d="M15 3v4" />
  <path d="M7 3v4" />
  <path d="M3 11h16" />
  <path d="M18 16.496v1.504l1 1" />
</svg>
                <time class="article-time--published">Dec 18, 2020</time>
            </div>
        

        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <polyline points="12 7 12 12 15 15" />
</svg>



                <time class="article-time--reading">
                    25 minute read
                </time>
            </div>
        
    </footer>
    
</div>
</header>

    <section class="article-content">
    <h2 id="系统链码">系统链码</h2>
<p><figure 
	
		class="gallery-image" 
		style="
			flex-grow: 88; 
			flex-basis: 213px"
	>
	<a href="/post/fabric-systemchaincode/%E7%B3%BB%E7%BB%9F%E9%93%BE%E7%A0%81%E7%BB%93%E6%9E%84%E5%9B%BE.png" data-size="600x676">
		<img src="/post/fabric-systemchaincode/%E7%B3%BB%E7%BB%9F%E9%93%BE%E7%A0%81%E7%BB%93%E6%9E%84%E5%9B%BE.png"
			width="600"
			height="676"
			srcset="/post/fabric-systemchaincode/%E7%B3%BB%E7%BB%9F%E9%93%BE%E7%A0%81%E7%BB%93%E6%9E%84%E5%9B%BE_hu3df4d83e11a62b95ad644cfb9bc48850_87422_480x0_resize_box_3.png 480w, /post/fabric-systemchaincode/%E7%B3%BB%E7%BB%9F%E9%93%BE%E7%A0%81%E7%BB%93%E6%9E%84%E5%9B%BE_hu3df4d83e11a62b95ad644cfb9bc48850_87422_1024x0_resize_box_3.png 1024w"
			loading="lazy"
			alt="系统链码结构图">
	</a>
	
	<figcaption>系统链码结构图</figcaption>
	
</figure></p>
<h3 id="与普通链码对比">与普通链码对比</h3>
<table>
<thead>
<tr>
<th style="text-align:center"></th>
<th style="text-align:left">系统链码</th>
<th>普通链码</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">链码源码</td>
<td style="text-align:left">无main函数</td>
<td>有main函数</td>
</tr>
<tr>
<td style="text-align:center">运行空间</td>
<td style="text-align:left">背书节点进程</td>
<td>Docker</td>
</tr>
<tr>
<td style="text-align:center">调用方式</td>
<td style="text-align:left">网络+进程内部</td>
<td>网络</td>
</tr>
<tr>
<td style="text-align:center">启动参数</td>
<td style="text-align:left">内置</td>
<td>动态输入</td>
</tr>
<tr>
<td style="text-align:center">通信方式</td>
<td style="text-align:left">Golang的通道机制</td>
<td>网络</td>
</tr>
<tr>
<td style="text-align:center">数据存取</td>
<td style="text-align:left">Golang的通道+本地文件</td>
<td>网络</td>
</tr>
<tr>
<td style="text-align:center">升级方式</td>
<td style="text-align:left">和背书节点一起升级</td>
<td>单独升级</td>
</tr>
<tr>
<td style="text-align:center">背书策略</td>
<td style="text-align:left">无</td>
<td>有</td>
</tr>
</tbody>
</table>
<h2 id="系统链码在peer节点上的注册与部署">系统链码在Peer节点上的注册与部署</h2>
<p>peer节点存在于docker容器中，在启动时通过执行<code>peer node start</code>命令来启动peer节点。</p>
<blockquote>
<p>/internal/peer/node/start.go</p>
</blockquote>
<p>start命令的入口函数为serve函数。</p>
<p>以下源代码中仅保留部署系统链码的部分。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">serve</span>(<span style="color:#a6e22e">args</span> []<span style="color:#66d9ef">string</span>) <span style="color:#66d9ef">error</span> {
    <span style="color:#75715e">// Initialize chaincode service
</span><span style="color:#75715e"></span>    
	<span style="color:#75715e">// deploy system chaincodes
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">cc</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> []<span style="color:#a6e22e">scc</span>.<span style="color:#a6e22e">SelfDescribingSysCC</span>{<span style="color:#a6e22e">lsccInst</span>, <span style="color:#a6e22e">csccInst</span>, <span style="color:#a6e22e">qsccInst</span>, <span style="color:#a6e22e">lifecycleSCC</span>} {
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">enabled</span>, <span style="color:#a6e22e">ok</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">chaincodeConfig</span>.<span style="color:#a6e22e">SCCWhitelist</span>[<span style="color:#a6e22e">cc</span>.<span style="color:#a6e22e">Name</span>()]; !<span style="color:#a6e22e">ok</span> <span style="color:#f92672">||</span> !<span style="color:#a6e22e">enabled</span> {
			<span style="color:#a6e22e">logger</span>.<span style="color:#a6e22e">Infof</span>(<span style="color:#e6db74">&#34;not deploying chaincode %s as it is not enabled&#34;</span>, <span style="color:#a6e22e">cc</span>.<span style="color:#a6e22e">Name</span>())
			<span style="color:#66d9ef">continue</span>
		} <span style="color:#75715e">// 判断链码的设置是否为enabled
</span><span style="color:#75715e"></span>		<span style="color:#a6e22e">scc</span>.<span style="color:#a6e22e">DeploySysCC</span>(<span style="color:#a6e22e">cc</span>, <span style="color:#a6e22e">chaincodeSupport</span>) <span style="color:#75715e">// 部署系统链码
</span><span style="color:#75715e"></span>	}

	<span style="color:#a6e22e">logger</span>.<span style="color:#a6e22e">Infof</span>(<span style="color:#e6db74">&#34;Deployed system chaincodes&#34;</span>)
	<span style="color:#75715e">//...
</span><span style="color:#75715e"></span>}

</code></pre></div><p>通过遍历scc.SelfDescribingSysCC返回值，调用scc.DeploySysCC函数。</p>
<p>找到scc源文件：</p>
<blockquote>
<p>corn/scc/scc.go</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">SelfDescribingSysCC</span> <span style="color:#66d9ef">interface</span> {
	<span style="color:#75715e">//Unique name of the system chaincode
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">Name</span>() <span style="color:#66d9ef">string</span>

	<span style="color:#75715e">// Chaincode returns the underlying chaincode
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">Chaincode</span>() <span style="color:#a6e22e">shim</span>.<span style="color:#a6e22e">Chaincode</span>
}
</code></pre></div><p><code>SelfDescribingSysCC</code>的第二个方法为<code>Chaincode()</code>返回值为<code>shim.Chaincode</code>类型。在<code>core\scc\cscc\configure.go</code>中发现如下代码：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">e</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">PeerConfiger</span>) <span style="color:#a6e22e">Chaincode</span>() <span style="color:#a6e22e">shim</span>.<span style="color:#a6e22e">Chaincode</span> { <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">e</span> }
</code></pre></div><p>可知<code>start.go</code>中的<code>cc</code>为每个链码的配置</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">PeerConfiger</span> <span style="color:#66d9ef">struct</span> {
	<span style="color:#a6e22e">policyChecker</span>          <span style="color:#a6e22e">policy</span>.<span style="color:#a6e22e">PolicyChecker</span>
	<span style="color:#a6e22e">configMgr</span>              <span style="color:#a6e22e">config</span>.<span style="color:#a6e22e">Manager</span>
	<span style="color:#a6e22e">aclProvider</span>            <span style="color:#a6e22e">aclmgmt</span>.<span style="color:#a6e22e">ACLProvider</span>
	<span style="color:#a6e22e">deployedCCInfoProvider</span> <span style="color:#a6e22e">ledger</span>.<span style="color:#a6e22e">DeployedChaincodeInfoProvider</span>
	<span style="color:#a6e22e">legacyLifecycle</span>        <span style="color:#a6e22e">plugindispatcher</span>.<span style="color:#a6e22e">LifecycleResources</span>
	<span style="color:#a6e22e">newLifecycle</span>           <span style="color:#a6e22e">plugindispatcher</span>.<span style="color:#a6e22e">CollectionAndLifecycleResources</span>
	<span style="color:#a6e22e">peer</span>                   <span style="color:#f92672">*</span><span style="color:#a6e22e">peer</span>.<span style="color:#a6e22e">Peer</span>
	<span style="color:#a6e22e">bccsp</span>                  <span style="color:#a6e22e">bccsp</span>.<span style="color:#a6e22e">BCCSP</span>
}
</code></pre></div><p>下面是<code>DeploySysCC</code>的代码</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">ChaincodeStreamHandler</span> <span style="color:#66d9ef">interface</span> {
	<span style="color:#a6e22e">HandleChaincodeStream</span>(<span style="color:#a6e22e">ccintf</span>.<span style="color:#a6e22e">ChaincodeStream</span>) <span style="color:#66d9ef">error</span>
	<span style="color:#a6e22e">LaunchInProc</span>(<span style="color:#a6e22e">packageID</span> <span style="color:#66d9ef">string</span>) <span style="color:#f92672">&lt;-</span><span style="color:#66d9ef">chan</span> <span style="color:#66d9ef">struct</span>{}
} <span style="color:#75715e">// 负责peer节点与链码之间的通信
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">DeploySysCC</span>(<span style="color:#a6e22e">sysCC</span> <span style="color:#a6e22e">SelfDescribingSysCC</span>, <span style="color:#a6e22e">chaincodeStreamHandler</span> <span style="color:#a6e22e">ChaincodeStreamHandler</span>) {
	<span style="color:#a6e22e">sysccLogger</span>.<span style="color:#a6e22e">Infof</span>(<span style="color:#e6db74">&#34;deploying system chaincode &#39;%s&#39;&#34;</span>, <span style="color:#a6e22e">sysCC</span>.<span style="color:#a6e22e">Name</span>())

	<span style="color:#a6e22e">ccid</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">ChaincodeID</span>(<span style="color:#a6e22e">sysCC</span>.<span style="color:#a6e22e">Name</span>())
	<span style="color:#a6e22e">done</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">chaincodeStreamHandler</span>.<span style="color:#a6e22e">LaunchInProc</span>(<span style="color:#a6e22e">ccid</span>)

	<span style="color:#a6e22e">peerRcvCCSend</span> <span style="color:#f92672">:=</span> make(<span style="color:#66d9ef">chan</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">pb</span>.<span style="color:#a6e22e">ChaincodeMessage</span>)
	<span style="color:#a6e22e">ccRcvPeerSend</span> <span style="color:#f92672">:=</span> make(<span style="color:#66d9ef">chan</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">pb</span>.<span style="color:#a6e22e">ChaincodeMessage</span>)

    <span style="color:#75715e">// 并行传输数据
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">go</span> <span style="color:#66d9ef">func</span>() {
		<span style="color:#a6e22e">stream</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">newInProcStream</span>(<span style="color:#a6e22e">peerRcvCCSend</span>, <span style="color:#a6e22e">ccRcvPeerSend</span>)
		<span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">stream</span>.<span style="color:#a6e22e">CloseSend</span>()

		<span style="color:#a6e22e">sysccLogger</span>.<span style="color:#a6e22e">Debugf</span>(<span style="color:#e6db74">&#34;starting chaincode-support stream for  %s&#34;</span>, <span style="color:#a6e22e">ccid</span>)
		<span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">chaincodeStreamHandler</span>.<span style="color:#a6e22e">HandleChaincodeStream</span>(<span style="color:#a6e22e">stream</span>)
		<span style="color:#a6e22e">sysccLogger</span>.<span style="color:#a6e22e">Criticalf</span>(<span style="color:#e6db74">&#34;shim stream ended with err: %v&#34;</span>, <span style="color:#a6e22e">err</span>)
	}()

	<span style="color:#66d9ef">go</span> <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">sysCC</span> <span style="color:#a6e22e">SelfDescribingSysCC</span>) {
		<span style="color:#a6e22e">stream</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">newInProcStream</span>(<span style="color:#a6e22e">ccRcvPeerSend</span>, <span style="color:#a6e22e">peerRcvCCSend</span>)
		<span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">stream</span>.<span style="color:#a6e22e">CloseSend</span>()

		<span style="color:#a6e22e">sysccLogger</span>.<span style="color:#a6e22e">Debugf</span>(<span style="color:#e6db74">&#34;chaincode started for %s&#34;</span>, <span style="color:#a6e22e">ccid</span>)
		<span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">shim</span>.<span style="color:#a6e22e">StartInProc</span>(<span style="color:#a6e22e">ccid</span>, <span style="color:#a6e22e">stream</span>, <span style="color:#a6e22e">sysCC</span>.<span style="color:#a6e22e">Chaincode</span>())
		<span style="color:#a6e22e">sysccLogger</span>.<span style="color:#a6e22e">Criticalf</span>(<span style="color:#e6db74">&#34;system chaincode ended with err: %v&#34;</span>, <span style="color:#a6e22e">err</span>)
	}(<span style="color:#a6e22e">sysCC</span>)
	<span style="color:#f92672">&lt;-</span><span style="color:#a6e22e">done</span>
}
</code></pre></div><p>因此，在serve.go代码中，对lscc,qscc,cscc三个系统链码进行相应的初始创建，随后根据配置信息部署到peer节点中。</p>
<h2 id="查询系统链码-querier-system-chaincode-qscc">查询系统链码 (<em>Querier System Chaincode</em>, QSCC)</h2>
<h3 id="源代码">源代码</h3>
<blockquote>
<p>/core/scc/qscc/query.go</p>
</blockquote>
<p>在所有Peer节点上运行，提供账本查询接口，包括了区块查询、交易查询等。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">qscc</span>

<span style="color:#f92672">import</span> (
	<span style="color:#e6db74">&#34;fmt&#34;</span>                       <span style="color:#75715e">// 格式化IO
</span><span style="color:#75715e"></span>	<span style="color:#e6db74">&#34;strconv&#34;</span>                   <span style="color:#75715e">// 数据类型转换
</span><span style="color:#75715e"></span>
	<span style="color:#e6db74">&#34;github.com/hyperledger/fabric-chaincode-go/shim&#34;</span> <span style="color:#75715e">// shim包提供API访问链码chaincode的状态变量，chaincode用来和peer沟通的接口
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">pb</span> <span style="color:#e6db74">&#34;github.com/hyperledger/fabric-protos-go/peer&#34;</span> <span style="color:#75715e">// 调用.pb.go文件，由proto文件生成
</span><span style="color:#75715e"></span>	<span style="color:#e6db74">&#34;github.com/hyperledger/fabric/common/flogging&#34;</span>
	<span style="color:#e6db74">&#34;github.com/hyperledger/fabric/core/aclmgmt&#34;</span>
	<span style="color:#e6db74">&#34;github.com/hyperledger/fabric/core/ledger&#34;</span>
	<span style="color:#e6db74">&#34;github.com/hyperledger/fabric/protoutil&#34;</span>         <span style="color:#75715e">// Proto Buffer的通用方法
</span><span style="color:#75715e"></span>)

<span style="color:#75715e">// LedgerGetter gets the PeerLedger associated with a channel.
</span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">LedgerGetter</span> <span style="color:#66d9ef">interface</span> {
	<span style="color:#a6e22e">GetLedger</span>(<span style="color:#a6e22e">cid</span> <span style="color:#66d9ef">string</span>) <span style="color:#a6e22e">ledger</span>.<span style="color:#a6e22e">PeerLedger</span>
}

<span style="color:#75715e">// New returns an instance of QSCC.
</span><span style="color:#75715e">// Typically this is called once per peer.
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">New</span>(<span style="color:#a6e22e">aclProvider</span> <span style="color:#a6e22e">aclmgmt</span>.<span style="color:#a6e22e">ACLProvider</span>, <span style="color:#a6e22e">ledgers</span> <span style="color:#a6e22e">LedgerGetter</span>) <span style="color:#f92672">*</span><span style="color:#a6e22e">LedgerQuerier</span> {
	<span style="color:#66d9ef">return</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">LedgerQuerier</span>{
		<span style="color:#a6e22e">aclProvider</span>: <span style="color:#a6e22e">aclProvider</span>,
		<span style="color:#a6e22e">ledgers</span>:     <span style="color:#a6e22e">ledgers</span>,
	}
}

<span style="color:#75715e">// (e *LedgerQuerier) 表示这是LedgerQuerier结构体的方法
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">e</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">LedgerQuerier</span>) <span style="color:#a6e22e">Name</span>() <span style="color:#66d9ef">string</span>              { <span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#34;qscc&#34;</span> }
<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">e</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">LedgerQuerier</span>) <span style="color:#a6e22e">Chaincode</span>() <span style="color:#a6e22e">shim</span>.<span style="color:#a6e22e">Chaincode</span> { <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">e</span> }

<span style="color:#75715e">// LedgerQuerier implements the ledger query functions, including:
</span><span style="color:#75715e">// - GetChainInfo returns BlockchainInfo
</span><span style="color:#75715e">// - GetBlockByNumber returns a block
</span><span style="color:#75715e">// - GetBlockByHash returns a block
</span><span style="color:#75715e">// - GetTransactionByID returns a transaction
</span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">LedgerQuerier</span> <span style="color:#66d9ef">struct</span> {
	<span style="color:#a6e22e">aclProvider</span> <span style="color:#a6e22e">aclmgmt</span>.<span style="color:#a6e22e">ACLProvider</span>
	<span style="color:#a6e22e">ledgers</span>     <span style="color:#a6e22e">LedgerGetter</span>
}

<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">qscclogger</span> = <span style="color:#a6e22e">flogging</span>.<span style="color:#a6e22e">MustGetLogger</span>(<span style="color:#e6db74">&#34;qscc&#34;</span>)

<span style="color:#75715e">// 将函数名定义为字符串常量，用于invoke的第一个arg参数
</span><span style="color:#75715e"></span><span style="color:#66d9ef">const</span> (
	<span style="color:#a6e22e">GetChainInfo</span>       <span style="color:#66d9ef">string</span> = <span style="color:#e6db74">&#34;GetChainInfo&#34;</span>
	<span style="color:#a6e22e">GetBlockByNumber</span>   <span style="color:#66d9ef">string</span> = <span style="color:#e6db74">&#34;GetBlockByNumber&#34;</span>
	<span style="color:#a6e22e">GetBlockByHash</span>     <span style="color:#66d9ef">string</span> = <span style="color:#e6db74">&#34;GetBlockByHash&#34;</span>
	<span style="color:#a6e22e">GetTransactionByID</span> <span style="color:#66d9ef">string</span> = <span style="color:#e6db74">&#34;GetTransactionByID&#34;</span>
	<span style="color:#a6e22e">GetBlockByTxID</span>     <span style="color:#66d9ef">string</span> = <span style="color:#e6db74">&#34;GetBlockByTxID&#34;</span>
)

<span style="color:#75715e">// Init is called once per chain when the chain is created.
</span><span style="color:#75715e">// This allows the chaincode to initialize any variables on the ledger prior
</span><span style="color:#75715e">// to any transaction execution on the chain.
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">e</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">LedgerQuerier</span>) <span style="color:#a6e22e">Init</span>(<span style="color:#a6e22e">stub</span> <span style="color:#a6e22e">shim</span>.<span style="color:#a6e22e">ChaincodeStubInterface</span>) <span style="color:#a6e22e">pb</span>.<span style="color:#a6e22e">Response</span> {
	<span style="color:#a6e22e">qscclogger</span>.<span style="color:#a6e22e">Info</span>(<span style="color:#e6db74">&#34;Init QSCC&#34;</span>)

	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">shim</span>.<span style="color:#a6e22e">Success</span>(<span style="color:#66d9ef">nil</span>)
}


<span style="color:#75715e">// 调用Invoke时，args[0]为查询函数名，args[1]为chain id，在加到stub包之前为暂时的id
</span><span style="color:#75715e">// 每个函数都需要额外的参数，如下:
</span><span style="color:#75715e">// # GetChainInfo: 返回一个以字节为单位的BlockchainInfo对象
</span><span style="color:#75715e">// # GetBlockByNumber: 返回args[2]中所指定的块
</span><span style="color:#75715e">// # GetBlockByHash: 返回args[2]中的块哈希值所指定的块
</span><span style="color:#75715e">// # GetTransactionByID: 返回args[2]中的id所指定的交易事务
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">e</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">LedgerQuerier</span>) <span style="color:#a6e22e">Invoke</span>(<span style="color:#a6e22e">stub</span> <span style="color:#a6e22e">shim</span>.<span style="color:#a6e22e">ChaincodeStubInterface</span>) <span style="color:#a6e22e">pb</span>.<span style="color:#a6e22e">Response</span> { <span style="color:#75715e">// 通过args调用内部函数
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">args</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">stub</span>.<span style="color:#a6e22e">GetArgs</span>() <span style="color:#75715e">// stub是RPC中客户端与服务器端传输的消息包，将其解包并获取args
</span><span style="color:#75715e"></span>
    <span style="color:#75715e">// args数量小于2时，返回错误信息
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// 第一个args为调用的函数名，第二个args为chain ID
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">fname</span> <span style="color:#f92672">:=</span> string(<span style="color:#a6e22e">args</span>[<span style="color:#ae81ff">0</span>])
	<span style="color:#a6e22e">cid</span> <span style="color:#f92672">:=</span> string(<span style="color:#a6e22e">args</span>[<span style="color:#ae81ff">1</span>])

	<span style="color:#a6e22e">sp</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">stub</span>.<span style="color:#a6e22e">GetSignedProposal</span>() <span style="color:#75715e">// 获取签名交易提议的解码对象，类型为SignedProposal
</span><span style="color:#75715e"></span>	
	<span style="color:#a6e22e">name</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">protoutil</span>.<span style="color:#a6e22e">InvokedChaincodeName</span>(<span style="color:#a6e22e">sp</span>.<span style="color:#a6e22e">ProposalBytes</span>)

	<span style="color:#a6e22e">targetLedger</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">ledgers</span>.<span style="color:#a6e22e">GetLedger</span>(<span style="color:#a6e22e">cid</span>)
	
	<span style="color:#a6e22e">qscclogger</span>.<span style="color:#a6e22e">Debugf</span>(<span style="color:#e6db74">&#34;Invoke function: %s on chain: %s&#34;</span>, <span style="color:#a6e22e">fname</span>, <span style="color:#a6e22e">cid</span>)

	<span style="color:#75715e">// Handle ACL: （ACL：访问控制权限）
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">res</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">getACLResource</span>(<span style="color:#a6e22e">fname</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">aclProvider</span>.<span style="color:#a6e22e">CheckACL</span>(<span style="color:#a6e22e">res</span>, <span style="color:#a6e22e">cid</span>, <span style="color:#a6e22e">sp</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">shim</span>.<span style="color:#a6e22e">Error</span>(<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Sprintf</span>(<span style="color:#e6db74">&#34;access denied for [%s][%s]: [%s]&#34;</span>, <span style="color:#a6e22e">fname</span>, <span style="color:#a6e22e">cid</span>, <span style="color:#a6e22e">err</span>))
	}

    <span style="color:#75715e">// 调用相应的函数并传递参数
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">switch</span> <span style="color:#a6e22e">fname</span> {
	<span style="color:#66d9ef">case</span> <span style="color:#a6e22e">GetTransactionByID</span>:
		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">getTransactionByID</span>(<span style="color:#a6e22e">targetLedger</span>, <span style="color:#a6e22e">args</span>[<span style="color:#ae81ff">2</span>])
	<span style="color:#66d9ef">case</span> <span style="color:#a6e22e">GetBlockByNumber</span>:
		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">getBlockByNumber</span>(<span style="color:#a6e22e">targetLedger</span>, <span style="color:#a6e22e">args</span>[<span style="color:#ae81ff">2</span>])
	<span style="color:#66d9ef">case</span> <span style="color:#a6e22e">GetBlockByHash</span>:
		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">getBlockByHash</span>(<span style="color:#a6e22e">targetLedger</span>, <span style="color:#a6e22e">args</span>[<span style="color:#ae81ff">2</span>])
	<span style="color:#66d9ef">case</span> <span style="color:#a6e22e">GetChainInfo</span>:
		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">getChainInfo</span>(<span style="color:#a6e22e">targetLedger</span>)
	<span style="color:#66d9ef">case</span> <span style="color:#a6e22e">GetBlockByTxID</span>:
		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">getBlockByTxID</span>(<span style="color:#a6e22e">targetLedger</span>, <span style="color:#a6e22e">args</span>[<span style="color:#ae81ff">2</span>])
	}

	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">shim</span>.<span style="color:#a6e22e">Error</span>(<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Sprintf</span>(<span style="color:#e6db74">&#34;Requested function %s not found.&#34;</span>, <span style="color:#a6e22e">fname</span>))
}

<span style="color:#75715e">// 以下为五个private方法，只能通过invoke进行调用。
</span><span style="color:#75715e">// 五个方法在进行异常处理后，调用账本中对应的方法，并将成功或错误结果通过shim发送
</span><span style="color:#75715e">// - getTransactionByID: 返回对应id的交易内容
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">getTransactionByID</span>(<span style="color:#a6e22e">vledger</span> <span style="color:#a6e22e">ledger</span>.<span style="color:#a6e22e">PeerLedger</span>, <span style="color:#a6e22e">tid</span> []<span style="color:#66d9ef">byte</span>) <span style="color:#a6e22e">pb</span>.<span style="color:#a6e22e">Response</span> {
	<span style="color:#75715e">// 异常：交易为空
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">processedTran</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">vledger</span>.<span style="color:#a6e22e">GetTransactionByID</span>(string(<span style="color:#a6e22e">tid</span>)) <span style="color:#75715e">// 调用ledger.PeerLedger中的方法
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">bytes</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">protoutil</span>.<span style="color:#a6e22e">Marshal</span>(<span style="color:#a6e22e">processedTran</span>) <span style="color:#75715e">// 使用proto工具进行编排 my_TODO: read protoutil
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">shim</span>.<span style="color:#a6e22e">Success</span>(<span style="color:#a6e22e">bytes</span>)
}

<span style="color:#75715e">//以下四个方法的整体结果与第一个相似
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">getBlockByNumber</span>(<span style="color:#a6e22e">vledger</span> <span style="color:#a6e22e">ledger</span>.<span style="color:#a6e22e">PeerLedger</span>, <span style="color:#a6e22e">number</span> []<span style="color:#66d9ef">byte</span>) <span style="color:#a6e22e">pb</span>.<span style="color:#a6e22e">Response</span> {
	<span style="color:#a6e22e">bnum</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">strconv</span>.<span style="color:#a6e22e">ParseUint</span>(string(<span style="color:#a6e22e">number</span>), <span style="color:#ae81ff">10</span>, <span style="color:#ae81ff">64</span>) <span style="color:#75715e">// 转换成uint型
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">block</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">vledger</span>.<span style="color:#a6e22e">GetBlockByNumber</span>(<span style="color:#a6e22e">bnum</span>) <span style="color:#75715e">// 调用账本中的方法
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">bytes</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">protoutil</span>.<span style="color:#a6e22e">Marshal</span>(<span style="color:#a6e22e">block</span>) 
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">shim</span>.<span style="color:#a6e22e">Success</span>(<span style="color:#a6e22e">bytes</span>)
}

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">getBlockByHash</span>(<span style="color:#a6e22e">vledger</span> <span style="color:#a6e22e">ledger</span>.<span style="color:#a6e22e">PeerLedger</span>, <span style="color:#a6e22e">hash</span> []<span style="color:#66d9ef">byte</span>) <span style="color:#a6e22e">pb</span>.<span style="color:#a6e22e">Response</span> {
	<span style="color:#a6e22e">block</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">vledger</span>.<span style="color:#a6e22e">GetBlockByHash</span>(<span style="color:#a6e22e">hash</span>)
	<span style="color:#a6e22e">bytes</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">protoutil</span>.<span style="color:#a6e22e">Marshal</span>(<span style="color:#a6e22e">block</span>)
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">shim</span>.<span style="color:#a6e22e">Success</span>(<span style="color:#a6e22e">bytes</span>)
}

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">getChainInfo</span>(<span style="color:#a6e22e">vledger</span> <span style="color:#a6e22e">ledger</span>.<span style="color:#a6e22e">PeerLedger</span>) <span style="color:#a6e22e">pb</span>.<span style="color:#a6e22e">Response</span> {
	<span style="color:#a6e22e">binfo</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">vledger</span>.<span style="color:#a6e22e">GetBlockchainInfo</span>()
	<span style="color:#a6e22e">bytes</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">protoutil</span>.<span style="color:#a6e22e">Marshal</span>(<span style="color:#a6e22e">binfo</span>)
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">shim</span>.<span style="color:#a6e22e">Success</span>(<span style="color:#a6e22e">bytes</span>)
}

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">getBlockByTxID</span>(<span style="color:#a6e22e">vledger</span> <span style="color:#a6e22e">ledger</span>.<span style="color:#a6e22e">PeerLedger</span>, <span style="color:#a6e22e">rawTxID</span> []<span style="color:#66d9ef">byte</span>) <span style="color:#a6e22e">pb</span>.<span style="color:#a6e22e">Response</span> {
	<span style="color:#a6e22e">txID</span> <span style="color:#f92672">:=</span> string(<span style="color:#a6e22e">rawTxID</span>)
	<span style="color:#a6e22e">block</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">vledger</span>.<span style="color:#a6e22e">GetBlockByTxID</span>(<span style="color:#a6e22e">txID</span>)
	<span style="color:#a6e22e">bytes</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">protoutil</span>.<span style="color:#a6e22e">Marshal</span>(<span style="color:#a6e22e">block</span>)
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">shim</span>.<span style="color:#a6e22e">Success</span>(<span style="color:#a6e22e">bytes</span>)
}

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">getACLResource</span>(<span style="color:#a6e22e">fname</span> <span style="color:#66d9ef">string</span>) <span style="color:#66d9ef">string</span> {
	<span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#34;qscc/&#34;</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">fname</span>
}

</code></pre></div><h4 id="get方法">Get方法</h4>
<p>QSCC提供的方法都是get方法，用于从通道中获取各种数据。</p>
<h2 id="配置系统链码-configuration-system-chaincode-cscc">配置系统链码 (<em>Configuration System Chaincode</em>, CSCC)</h2>
<blockquote>
<p>/core/scc/cscc/configure.go</p>
</blockquote>
<p>CSCC管理peer节点上通道相关的信息并执行通道配置交易</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">PeerConfiger</span> <span style="color:#66d9ef">struct</span> {
	<span style="color:#a6e22e">policyChecker</span>          <span style="color:#a6e22e">policy</span>.<span style="color:#a6e22e">PolicyChecker</span>
	<span style="color:#a6e22e">configMgr</span>              <span style="color:#a6e22e">config</span>.<span style="color:#a6e22e">Manager</span>
	<span style="color:#a6e22e">aclProvider</span>            <span style="color:#a6e22e">aclmgmt</span>.<span style="color:#a6e22e">ACLProvider</span>
	<span style="color:#a6e22e">deployedCCInfoProvider</span> <span style="color:#a6e22e">ledger</span>.<span style="color:#a6e22e">DeployedChaincodeInfoProvider</span>
	<span style="color:#a6e22e">legacyLifecycle</span>        <span style="color:#a6e22e">plugindispatcher</span>.<span style="color:#a6e22e">LifecycleResources</span>
	<span style="color:#a6e22e">newLifecycle</span>           <span style="color:#a6e22e">plugindispatcher</span>.<span style="color:#a6e22e">CollectionAndLifecycleResources</span>
	<span style="color:#a6e22e">peer</span>                   <span style="color:#f92672">*</span><span style="color:#a6e22e">peer</span>.<span style="color:#a6e22e">Peer</span>
	<span style="color:#a6e22e">bccsp</span>                  <span style="color:#a6e22e">bccsp</span>.<span style="color:#a6e22e">BCCSP</span>
}
</code></pre></div><p>CSCC中提供了PeerConfiger类。这个类实现了peer节点配置信息的处理。对于所有的从排序服务中进来的配置交易，都会调用这个系统链码来处理交易。</p>
<p>CSCC提供了三种方法</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">const</span> (
	<span style="color:#a6e22e">JoinChain</span>      <span style="color:#66d9ef">string</span> = <span style="color:#e6db74">&#34;JoinChain&#34;</span>
	<span style="color:#a6e22e">GetConfigBlock</span> <span style="color:#66d9ef">string</span> = <span style="color:#e6db74">&#34;GetConfigBlock&#34;</span>
	<span style="color:#a6e22e">GetChannels</span>    <span style="color:#66d9ef">string</span> = <span style="color:#e6db74">&#34;GetChannels&#34;</span>
)
</code></pre></div><h3 id="joinchain方法">JoinChain方法</h3>
<p>JoinChain 方法用来使一个peer加入通道。它需要一个参数，即通道配置区块的序列化的protobuf byte。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go">		<span style="color:#a6e22e">block</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">protoutil</span>.<span style="color:#a6e22e">UnmarshalBlock</span>(<span style="color:#a6e22e">args</span>[<span style="color:#ae81ff">1</span>])
		<span style="color:#a6e22e">cid</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">protoutil</span>.<span style="color:#a6e22e">GetChainIDFromBlock</span>(<span style="color:#a6e22e">block</span>)
		<span style="color:#75715e">// 1. 检查配置块的格式和要求
</span><span style="color:#75715e"></span>		<span style="color:#75715e">// 2. 检查加入的政策
</span><span style="color:#75715e"></span>		<span style="color:#75715e">// 初始化txsFilter
</span><span style="color:#75715e"></span>		<span style="color:#a6e22e">txsFilter</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">util</span>.<span style="color:#a6e22e">TxValidationFlags</span>(<span style="color:#a6e22e">block</span>.<span style="color:#a6e22e">Metadata</span>.<span style="color:#a6e22e">Metadata</span>[<span style="color:#a6e22e">common</span>.<span style="color:#a6e22e">BlockMetadataIndex_TRANSACTIONS_FILTER</span>])
		<span style="color:#66d9ef">if</span> len(<span style="color:#a6e22e">txsFilter</span>) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> {
			<span style="color:#75715e">// add array of validation code hardcoded to valid
</span><span style="color:#75715e"></span>			<span style="color:#a6e22e">txsFilter</span> = <span style="color:#a6e22e">util</span>.<span style="color:#a6e22e">NewTxValidationFlagsSetValue</span>(len(<span style="color:#a6e22e">block</span>.<span style="color:#a6e22e">Data</span>.<span style="color:#a6e22e">Data</span>), <span style="color:#a6e22e">pb</span>.<span style="color:#a6e22e">TxValidationCode_VALID</span>)
			<span style="color:#a6e22e">block</span>.<span style="color:#a6e22e">Metadata</span>.<span style="color:#a6e22e">Metadata</span>[<span style="color:#a6e22e">common</span>.<span style="color:#a6e22e">BlockMetadataIndex_TRANSACTIONS_FILTER</span>] = <span style="color:#a6e22e">txsFilter</span>
		}

		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">joinChain</span>(<span style="color:#a6e22e">cid</span>, <span style="color:#a6e22e">block</span>, <span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">deployedCCInfoProvider</span>, <span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">legacyLifecycle</span>, <span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">newLifecycle</span>)

</code></pre></div><h3 id="getconfigblock方法">GetConfigBlock方法</h3>
<p>这个方法用于获取给定通道的当前的配置区块。需要一个参数：通道名字的bytes形式。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go">	<span style="color:#66d9ef">case</span> <span style="color:#a6e22e">GetConfigBlock</span>:
		<span style="color:#75715e">// 2. check policy
</span><span style="color:#75715e"></span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">aclProvider</span>.<span style="color:#a6e22e">CheckACL</span>(<span style="color:#a6e22e">resources</span>.<span style="color:#a6e22e">Cscc_GetConfigBlock</span>, string(<span style="color:#a6e22e">args</span>[<span style="color:#ae81ff">1</span>]), <span style="color:#a6e22e">sp</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
			<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">shim</span>.<span style="color:#a6e22e">Error</span>(<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Sprintf</span>(<span style="color:#e6db74">&#34;access denied for [%s][%s]: %s&#34;</span>, <span style="color:#a6e22e">fname</span>, <span style="color:#a6e22e">args</span>[<span style="color:#ae81ff">1</span>], <span style="color:#a6e22e">err</span>))
		}
		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">getConfigBlock</span>(<span style="color:#a6e22e">args</span>[<span style="color:#ae81ff">1</span>])
</code></pre></div><h3 id="getchannel方法">GetChannel方法</h3>
<p>这个方法用于获取peer节点目前所加入的通道。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go">	<span style="color:#66d9ef">case</span> <span style="color:#a6e22e">GetChannels</span>:
		<span style="color:#75715e">// 2. check get channels policy
</span><span style="color:#75715e"></span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">aclProvider</span>.<span style="color:#a6e22e">CheckACL</span>(<span style="color:#a6e22e">resources</span>.<span style="color:#a6e22e">Cscc_GetChannels</span>, <span style="color:#e6db74">&#34;&#34;</span>, <span style="color:#a6e22e">sp</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
			<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">shim</span>.<span style="color:#a6e22e">Error</span>(<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Sprintf</span>(<span style="color:#e6db74">&#34;access denied for [%s]: %s&#34;</span>, <span style="color:#a6e22e">fname</span>, <span style="color:#a6e22e">err</span>))
		}

		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">getChannels</span>()
</code></pre></div><h2 id="生命周期系统链码-life-cycle-system-chaincode-lscc">生命周期系统链码 (<em>Life Cycle System Chaincode</em>, LSCC)</h2>
<p>LSCC主要管理链码的生命周期，主要包括：</p>
<ul>
<li>在peer节点上安装链码</li>
<li>在通道上部署和升级链码</li>
<li>用户从运行中的链码获取信息</li>
</ul>
<h3 id="链码的生命周期">链码的生命周期</h3>
<h4 id="打包链码">打包链码</h4>
<p>在被安装到peer节点之前，链码需要被打包进一个<code>.tar.gz</code>文件，其中包含两个文件：&ldquo;metadata.json&quot;和另一个包含链码文件的文件&quot;code.tar.gz&rdquo;</p>
<p>&ldquo;metadata.json&quot;包含了指定链码语言、代码路径、以及包标签的JSON文件。</p>
<h4 id="安装链码">安装链码</h4>
<p>每个要执行和背书交易的peer节点上都需要安装链码包。安装完成后，peer节点会构造链码。一般建议每个组织下的所有peer使用相同的链码包。</p>
<h4 id="批准链码定义">批准链码定义</h4>
<p>通过 <strong>链码定义</strong> 来管理链码。当通道成员批准一个链码定义，这个批准便作为一个组织在接受链码参数方面的投票。这些同意的组织定义允许通道成员在链码可以在通道上使用之前达成一致意见（同意链码运行在此通道上）。</p>
<p>链码定义包含以下参数（需要在组织之间保持一致）：<strong>名称</strong>、<strong>版本</strong>、<strong>序列号</strong>、<strong>背书策略</strong>、<strong>私有数据集合配置</strong>、<strong>ECSS/VSCC插件</strong>、<strong>初始化</strong></p>
<h4 id="提交链码定义到通道">提交链码定义到通道</h4>
<p>足够多的成员同意一个链码定义后，某个组织能够提交定义到通道。提交交易首先发送给通道成员的peer节点，peer节点会查询链码定义的被同意状况，确认组织同意后为其背书，交易随后被提交到排序服务，排序服务会把链码定义提交给通道。</p>
<h3 id="源代码-1">源代码</h3>
<p>部署时的config</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#a6e22e">lsccInst</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">lscc</span>.<span style="color:#a6e22e">SCC</span>{
	<span style="color:#a6e22e">BuiltinSCCs</span>: <span style="color:#a6e22e">builtinSCCs</span>,
    <span style="color:#75715e">// type: FilesystemSupport
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// Support提供了一些静态函数的实现
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">Support</span>: <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">lscc</span>.<span style="color:#a6e22e">SupportImpl</span>{
		<span style="color:#a6e22e">GetMSPIDs</span>: <span style="color:#a6e22e">peerInstance</span>.<span style="color:#a6e22e">GetMSPIDs</span>,
	},
    <span style="color:#75715e">// type: sysccprovider.SystemChaincodeProvider
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// SCCProvider是用于访问系统其他部分的接口
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">SCCProvider</span>:        <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">lscc</span>.<span style="color:#a6e22e">PeerShim</span>{<span style="color:#a6e22e">Peer</span>: <span style="color:#a6e22e">peerInstance</span>},
    <span style="color:#75715e">// type: aclmgmt.ACLProvider
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// ACLProvider负责访问权限控制
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">ACLProvider</span>:        <span style="color:#a6e22e">aclProvider</span>, 
	<span style="color:#a6e22e">GetMSPIDs</span>:          <span style="color:#a6e22e">peerInstance</span>.<span style="color:#a6e22e">GetMSPIDs</span>,
    <span style="color:#75715e">// type: policy.PolicyChecker
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// PolicyChecker是用于执行访问控制的接口
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">PolicyChecker</span>:      <span style="color:#a6e22e">policyChecker</span>,
	<span style="color:#a6e22e">BCCSP</span>:              <span style="color:#a6e22e">factory</span>.<span style="color:#a6e22e">GetDefault</span>(),
	<span style="color:#a6e22e">BuildRegistry</span>:      <span style="color:#a6e22e">buildRegistry</span>,
	<span style="color:#a6e22e">ChaincodeBuilder</span>:   <span style="color:#a6e22e">containerRouter</span>,
	<span style="color:#a6e22e">EbMetadataProvider</span>: <span style="color:#a6e22e">ebMetadataProvider</span>,
}
</code></pre></div><blockquote>
<p>/core/scc/lscc/lscc.go</p>
</blockquote>
<p><code>Invoke</code>代码的形式与QSCC部分类似，都是使用switch语句选择所调用的方法（将函数名定义为常量）</p>
<p>由于代码过长，以下代码省略异常处理部分：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">lscc</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">SCC</span>) <span style="color:#a6e22e">Invoke</span>(<span style="color:#a6e22e">stub</span> <span style="color:#a6e22e">shim</span>.<span style="color:#a6e22e">ChaincodeStubInterface</span>) <span style="color:#a6e22e">pb</span>.<span style="color:#a6e22e">Response</span> {
	<span style="color:#a6e22e">args</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">stub</span>.<span style="color:#a6e22e">GetArgs</span>()

	<span style="color:#a6e22e">function</span> <span style="color:#f92672">:=</span> string(<span style="color:#a6e22e">args</span>[<span style="color:#ae81ff">0</span>]) <span style="color:#75715e">// 第一个参数是函数名
</span><span style="color:#75715e"></span>
	<span style="color:#66d9ef">switch</span> <span style="color:#a6e22e">function</span> {
	<span style="color:#66d9ef">case</span> <span style="color:#a6e22e">INSTALL</span>:
		<span style="color:#a6e22e">depSpec</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">args</span>[<span style="color:#ae81ff">1</span>]
		<span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">lscc</span>.<span style="color:#a6e22e">executeInstall</span>(<span style="color:#a6e22e">stub</span>, <span style="color:#a6e22e">depSpec</span>) <span style="color:#75715e">// 根据第二个参数 deployment spec 安装链码
</span><span style="color:#75715e"></span>		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">shim</span>.<span style="color:#a6e22e">Success</span>([]byte(<span style="color:#e6db74">&#34;OK&#34;</span>))
	<span style="color:#66d9ef">case</span> <span style="color:#a6e22e">DEPLOY</span>, <span style="color:#a6e22e">UPGRADE</span>:
		<span style="color:#75715e">// 至少有三个参数： 函数名，链码名和deployment spec
</span><span style="color:#75715e"></span>
		<span style="color:#a6e22e">channel</span> <span style="color:#f92672">:=</span> string(<span style="color:#a6e22e">args</span>[<span style="color:#ae81ff">1</span>])
        
		<span style="color:#a6e22e">ac</span>, <span style="color:#a6e22e">exists</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">lscc</span>.<span style="color:#a6e22e">SCCProvider</span>.<span style="color:#a6e22e">GetApplicationConfig</span>(<span style="color:#a6e22e">channel</span>) <span style="color:#75715e">// 通过第二个参数获取配置
</span><span style="color:#75715e"></span>
		<span style="color:#a6e22e">depSpec</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">args</span>[<span style="color:#ae81ff">2</span>]
		<span style="color:#a6e22e">cds</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">pb</span>.<span style="color:#a6e22e">ChaincodeDeploymentSpec</span>{}

		<span style="color:#75715e">// 可选参数：
</span><span style="color:#75715e"></span>		<span style="color:#75715e">// 第四个参数是 已编组的 SignaturePolicyEnvelope 代表了背书政策
</span><span style="color:#75715e"></span>		<span style="color:#75715e">// 第五个参数是 escc名
</span><span style="color:#75715e"></span>		<span style="color:#75715e">// 第六个参数是 vscc名
</span><span style="color:#75715e"></span>		<span style="color:#75715e">// 第七个参数是 一个已编组的 CollectionConfigPackage 类
</span><span style="color:#75715e"></span>		
		<span style="color:#75715e">// 第四个参数：
</span><span style="color:#75715e"></span>		<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">EP</span> []<span style="color:#66d9ef">byte</span>
		<span style="color:#66d9ef">if</span> len(<span style="color:#a6e22e">args</span>) &gt; <span style="color:#ae81ff">3</span> <span style="color:#f92672">&amp;&amp;</span> len(<span style="color:#a6e22e">args</span>[<span style="color:#ae81ff">3</span>]) &gt; <span style="color:#ae81ff">0</span> {
			<span style="color:#a6e22e">EP</span> = <span style="color:#a6e22e">args</span>[<span style="color:#ae81ff">3</span>] <span style="color:#75715e">// EP为一个背书政策
</span><span style="color:#75715e"></span>		} <span style="color:#66d9ef">else</span> {
			<span style="color:#a6e22e">mspIDs</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">lscc</span>.<span style="color:#a6e22e">GetMSPIDs</span>(<span style="color:#a6e22e">channel</span>)
			<span style="color:#a6e22e">p</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">policydsl</span>.<span style="color:#a6e22e">SignedByAnyMember</span>(<span style="color:#a6e22e">mspIDs</span>) <span style="color:#75715e">// 根据通道的mspID获取背书政策？
</span><span style="color:#75715e"></span>			<span style="color:#a6e22e">EP</span>, <span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">protoutil</span>.<span style="color:#a6e22e">Marshal</span>(<span style="color:#a6e22e">p</span>) <span style="color:#75715e">// 将结果进行编组
</span><span style="color:#75715e"></span>		}

        <span style="color:#75715e">// 第五个参数：
</span><span style="color:#75715e"></span>		<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">escc</span> []<span style="color:#66d9ef">byte</span>
		<span style="color:#66d9ef">if</span> len(<span style="color:#a6e22e">args</span>) &gt; <span style="color:#ae81ff">4</span> <span style="color:#f92672">&amp;&amp;</span> len(<span style="color:#a6e22e">args</span>[<span style="color:#ae81ff">4</span>]) &gt; <span style="color:#ae81ff">0</span> {
			<span style="color:#a6e22e">escc</span> = <span style="color:#a6e22e">args</span>[<span style="color:#ae81ff">4</span>]
		} <span style="color:#66d9ef">else</span> {
			<span style="color:#a6e22e">escc</span> = []byte(<span style="color:#e6db74">&#34;escc&#34;</span>) <span style="color:#75715e">// 默认为escc
</span><span style="color:#75715e"></span>		}

        <span style="color:#75715e">// 第六个参数：
</span><span style="color:#75715e"></span>		<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">vscc</span> []<span style="color:#66d9ef">byte</span>
		<span style="color:#66d9ef">if</span> len(<span style="color:#a6e22e">args</span>) &gt; <span style="color:#ae81ff">5</span> <span style="color:#f92672">&amp;&amp;</span> len(<span style="color:#a6e22e">args</span>[<span style="color:#ae81ff">5</span>]) &gt; <span style="color:#ae81ff">0</span> {
			<span style="color:#a6e22e">vscc</span> = <span style="color:#a6e22e">args</span>[<span style="color:#ae81ff">5</span>]
		} <span style="color:#66d9ef">else</span> {
			<span style="color:#a6e22e">vscc</span> = []byte(<span style="color:#e6db74">&#34;vscc&#34;</span>) <span style="color:#75715e">// 默认为vscc
</span><span style="color:#75715e"></span>		}

        <span style="color:#75715e">// 如果有第七个参数：
</span><span style="color:#75715e"></span>		<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">collectionsConfig</span> []<span style="color:#66d9ef">byte</span>
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">ac</span>.<span style="color:#a6e22e">Capabilities</span>().<span style="color:#a6e22e">PrivateChannelData</span>() <span style="color:#f92672">&amp;&amp;</span> len(<span style="color:#a6e22e">args</span>) &gt; <span style="color:#ae81ff">6</span> {
			<span style="color:#a6e22e">collectionsConfig</span> = <span style="color:#a6e22e">args</span>[<span style="color:#ae81ff">6</span>]
		}

        <span style="color:#75715e">// 将所有的参数传入executeDeployOrUpgrade方法中执行
</span><span style="color:#75715e"></span>		<span style="color:#a6e22e">cd</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">lscc</span>.<span style="color:#a6e22e">executeDeployOrUpgrade</span>(<span style="color:#a6e22e">stub</span>, <span style="color:#a6e22e">channel</span>, <span style="color:#a6e22e">cds</span>, <span style="color:#a6e22e">EP</span>, <span style="color:#a6e22e">escc</span>, <span style="color:#a6e22e">vscc</span>, <span style="color:#a6e22e">collectionsConfig</span>, <span style="color:#a6e22e">function</span>)
		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">shim</span>.<span style="color:#a6e22e">Success</span>(<span style="color:#a6e22e">cdbytes</span>)
	<span style="color:#66d9ef">case</span> <span style="color:#a6e22e">CCEXISTS</span>, <span style="color:#a6e22e">CHAINCODEEXISTS</span>, <span style="color:#a6e22e">GETDEPSPEC</span>, <span style="color:#a6e22e">GETDEPLOYMENTSPEC</span>, <span style="color:#a6e22e">GETCCDATA</span>, <span style="color:#a6e22e">GETCHAINCODEDATA</span>:
		<span style="color:#75715e">// 变量个数必须为3
</span><span style="color:#75715e"></span>		<span style="color:#a6e22e">channel</span> <span style="color:#f92672">:=</span> string(<span style="color:#a6e22e">args</span>[<span style="color:#ae81ff">1</span>])
		<span style="color:#a6e22e">ccname</span> <span style="color:#f92672">:=</span> string(<span style="color:#a6e22e">args</span>[<span style="color:#ae81ff">2</span>])
		
		<span style="color:#a6e22e">cdbytes</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">lscc</span>.<span style="color:#a6e22e">getCCInstance</span>(<span style="color:#a6e22e">stub</span>, <span style="color:#a6e22e">ccname</span>) <span style="color:#75715e">// 获取实例
</span><span style="color:#75715e"></span>
		<span style="color:#66d9ef">switch</span> <span style="color:#a6e22e">function</span> {
		<span style="color:#66d9ef">case</span> <span style="color:#a6e22e">CCEXISTS</span>, <span style="color:#a6e22e">CHAINCODEEXISTS</span>:
			<span style="color:#a6e22e">cd</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">lscc</span>.<span style="color:#a6e22e">getChaincodeData</span>(<span style="color:#a6e22e">ccname</span>, <span style="color:#a6e22e">cdbytes</span>) <span style="color:#75715e">// 获取链码数据
</span><span style="color:#75715e"></span>		<span style="color:#66d9ef">case</span> <span style="color:#a6e22e">GETCCDATA</span>, <span style="color:#a6e22e">GETCHAINCODEDATA</span>:
			<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">shim</span>.<span style="color:#a6e22e">Success</span>(<span style="color:#a6e22e">cdbytes</span>)
		<span style="color:#66d9ef">case</span> <span style="color:#a6e22e">GETDEPSPEC</span>, <span style="color:#a6e22e">GETDEPLOYMENTSPEC</span>:
			<span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">depspecbytes</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">lscc</span>.<span style="color:#a6e22e">getCCCode</span>(<span style="color:#a6e22e">ccname</span>, <span style="color:#a6e22e">cdbytes</span>)
			<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">shim</span>.<span style="color:#a6e22e">Success</span>(<span style="color:#a6e22e">depspecbytes</span>)
		<span style="color:#66d9ef">default</span>:
			panic(<span style="color:#e6db74">&#34;unreachable&#34;</span>)
		}
	<span style="color:#66d9ef">case</span> <span style="color:#a6e22e">GETCHAINCODES</span>, <span style="color:#a6e22e">GETCHAINCODESALIAS</span>:
		<span style="color:#75715e">// 变量个数必须为1
</span><span style="color:#75715e"></span>		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">lscc</span>.<span style="color:#a6e22e">getChaincodes</span>(<span style="color:#a6e22e">stub</span>) <span style="color:#75715e">// 调用对应方法
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">case</span> <span style="color:#a6e22e">GETINSTALLEDCHAINCODES</span>, <span style="color:#a6e22e">GETINSTALLEDCHAINCODESALIAS</span>:
		<span style="color:#75715e">// 变量个数必须为1
</span><span style="color:#75715e"></span>		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">lscc</span>.<span style="color:#a6e22e">getInstalledChaincodes</span>() <span style="color:#75715e">// 调用对应方法
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">case</span> <span style="color:#a6e22e">GETCOLLECTIONSCONFIG</span>, <span style="color:#a6e22e">GETCOLLECTIONSCONFIGALIAS</span>:
		<span style="color:#75715e">// 变量个数必须为2
</span><span style="color:#75715e"></span>		<span style="color:#a6e22e">chaincodeName</span> <span style="color:#f92672">:=</span> string(<span style="color:#a6e22e">args</span>[<span style="color:#ae81ff">1</span>])
		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">lscc</span>.<span style="color:#a6e22e">getChaincodeCollectionData</span>(<span style="color:#a6e22e">stub</span>, <span style="color:#a6e22e">chaincodeName</span>) <span style="color:#75715e">// 调用对应方法
</span><span style="color:#75715e"></span>	}

	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">shim</span>.<span style="color:#a6e22e">Error</span>(<span style="color:#a6e22e">InvalidFunctionErr</span>(<span style="color:#a6e22e">function</span>).<span style="color:#a6e22e">Error</span>())
}
</code></pre></div><h4 id="install方法">Install方法</h4>
<p>用于存储chaincode程序到peer的文件系统，需要一个参数，及chancode deployment spec的序列化protobuf bytes。</p>
<h4 id="deploy方法">Deploy方法</h4>
<p>用于在给定的通道上实例化合约，可以接受五个参数，前两个参数是必须的：通道名称与chaincode deployment spec。另外三个参数为：倍数策略、背书系统合约的名字和验证系统合约的名字。</p>
<h4 id="upgrade方法">Upgrade方法</h4>
<p>用于升级合约</p>
<h4 id="get方法-1">Get方法</h4>
<p>剩下的get方法都用于获取相应的合约数据</p>
<h2 id="背书系统链码-endorser-system-chaincode-escc">背书系统链码 (<em>Endorser System Chaincode</em>, ESCC)</h2>
<p>在背书节点上运行，对交易结束进行结构转换和签名背书。</p>
<blockquote>
<p>/core/endorser/endorser.go</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">endorser</span>

<span style="color:#f92672">import</span> (
	<span style="color:#e6db74">&#34;context&#34;</span>
	<span style="color:#e6db74">&#34;fmt&#34;</span>
	<span style="color:#e6db74">&#34;strconv&#34;</span>
	<span style="color:#e6db74">&#34;time&#34;</span>

	<span style="color:#e6db74">&#34;github.com/golang/protobuf/proto&#34;</span>
	<span style="color:#e6db74">&#34;github.com/hyperledger/fabric-chaincode-go/shim&#34;</span>
	<span style="color:#a6e22e">pb</span> <span style="color:#e6db74">&#34;github.com/hyperledger/fabric-protos-go/peer&#34;</span>
	<span style="color:#e6db74">&#34;github.com/hyperledger/fabric-protos-go/transientstore&#34;</span>
	<span style="color:#e6db74">&#34;github.com/hyperledger/fabric/common/flogging&#34;</span>
	<span style="color:#e6db74">&#34;github.com/hyperledger/fabric/common/util&#34;</span>
	<span style="color:#e6db74">&#34;github.com/hyperledger/fabric/core/chaincode/lifecycle&#34;</span>
	<span style="color:#e6db74">&#34;github.com/hyperledger/fabric/core/common/ccprovider&#34;</span>
	<span style="color:#e6db74">&#34;github.com/hyperledger/fabric/core/ledger&#34;</span>
	<span style="color:#e6db74">&#34;github.com/hyperledger/fabric/internal/pkg/identity&#34;</span>
	<span style="color:#e6db74">&#34;github.com/hyperledger/fabric/msp&#34;</span>
	<span style="color:#e6db74">&#34;github.com/hyperledger/fabric/protoutil&#34;</span>
	<span style="color:#e6db74">&#34;github.com/pkg/errors&#34;</span>
	<span style="color:#e6db74">&#34;go.uber.org/zap&#34;</span>
)

<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">endorserLogger</span> = <span style="color:#a6e22e">flogging</span>.<span style="color:#a6e22e">MustGetLogger</span>(<span style="color:#e6db74">&#34;endorser&#34;</span>)

<span style="color:#75715e">// The Jira issue that documents Endorser flow along with its relationship to
</span><span style="color:#75715e">// the lifecycle chaincode - https://jira.hyperledger.org/browse/FAB-181
</span><span style="color:#75715e"></span>
<span style="color:#75715e">//go:generate counterfeiter -o fake/prvt_data_distributor.go --fake-name PrivateDataDistributor . PrivateDataDistributor
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">type</span> <span style="color:#a6e22e">PrivateDataDistributor</span> <span style="color:#66d9ef">interface</span> {
	<span style="color:#a6e22e">DistributePrivateData</span>(<span style="color:#a6e22e">channel</span> <span style="color:#66d9ef">string</span>, <span style="color:#a6e22e">txID</span> <span style="color:#66d9ef">string</span>, <span style="color:#a6e22e">privateData</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">transientstore</span>.<span style="color:#a6e22e">TxPvtReadWriteSetWithConfigInfo</span>, <span style="color:#a6e22e">blkHt</span> <span style="color:#66d9ef">uint64</span>) <span style="color:#66d9ef">error</span>
}

<span style="color:#75715e">// Support contains functions that the endorser requires to execute its tasks
</span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Support</span> <span style="color:#66d9ef">interface</span> {
	<span style="color:#a6e22e">identity</span>.<span style="color:#a6e22e">SignerSerializer</span>
	<span style="color:#75715e">// GetTxSimulator returns the transaction simulator for the specified ledger
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// a client may obtain more than one such simulator; they are made unique
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// by way of the supplied txid
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">GetTxSimulator</span>(<span style="color:#a6e22e">ledgername</span> <span style="color:#66d9ef">string</span>, <span style="color:#a6e22e">txid</span> <span style="color:#66d9ef">string</span>) (<span style="color:#a6e22e">ledger</span>.<span style="color:#a6e22e">TxSimulator</span>, <span style="color:#66d9ef">error</span>)

	<span style="color:#75715e">// GetHistoryQueryExecutor gives handle to a history query executor for the
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// specified ledger
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">GetHistoryQueryExecutor</span>(<span style="color:#a6e22e">ledgername</span> <span style="color:#66d9ef">string</span>) (<span style="color:#a6e22e">ledger</span>.<span style="color:#a6e22e">HistoryQueryExecutor</span>, <span style="color:#66d9ef">error</span>)

	<span style="color:#75715e">// GetTransactionByID retrieves a transaction by id
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">GetTransactionByID</span>(<span style="color:#a6e22e">chid</span>, <span style="color:#a6e22e">txID</span> <span style="color:#66d9ef">string</span>) (<span style="color:#f92672">*</span><span style="color:#a6e22e">pb</span>.<span style="color:#a6e22e">ProcessedTransaction</span>, <span style="color:#66d9ef">error</span>)

	<span style="color:#75715e">// IsSysCC returns true if the name matches a system chaincode&#39;s
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// system chaincode names are system, chain wide
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">IsSysCC</span>(<span style="color:#a6e22e">name</span> <span style="color:#66d9ef">string</span>) <span style="color:#66d9ef">bool</span>

	<span style="color:#75715e">// Execute - execute proposal, return original response of chaincode
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">Execute</span>(<span style="color:#a6e22e">txParams</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">ccprovider</span>.<span style="color:#a6e22e">TransactionParams</span>, <span style="color:#a6e22e">name</span> <span style="color:#66d9ef">string</span>, <span style="color:#a6e22e">input</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">pb</span>.<span style="color:#a6e22e">ChaincodeInput</span>) (<span style="color:#f92672">*</span><span style="color:#a6e22e">pb</span>.<span style="color:#a6e22e">Response</span>, <span style="color:#f92672">*</span><span style="color:#a6e22e">pb</span>.<span style="color:#a6e22e">ChaincodeEvent</span>, <span style="color:#66d9ef">error</span>)

	<span style="color:#75715e">// ExecuteLegacyInit - executes a deployment proposal, return original response of chaincode
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">ExecuteLegacyInit</span>(<span style="color:#a6e22e">txParams</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">ccprovider</span>.<span style="color:#a6e22e">TransactionParams</span>, <span style="color:#a6e22e">name</span>, <span style="color:#a6e22e">version</span> <span style="color:#66d9ef">string</span>, <span style="color:#a6e22e">spec</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">pb</span>.<span style="color:#a6e22e">ChaincodeInput</span>) (<span style="color:#f92672">*</span><span style="color:#a6e22e">pb</span>.<span style="color:#a6e22e">Response</span>, <span style="color:#f92672">*</span><span style="color:#a6e22e">pb</span>.<span style="color:#a6e22e">ChaincodeEvent</span>, <span style="color:#66d9ef">error</span>)

	<span style="color:#75715e">// ChaincodeEndorsementInfo returns the information from lifecycle required to endorse the chaincode.
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">ChaincodeEndorsementInfo</span>(<span style="color:#a6e22e">channelID</span>, <span style="color:#a6e22e">chaincodeID</span> <span style="color:#66d9ef">string</span>, <span style="color:#a6e22e">txsim</span> <span style="color:#a6e22e">ledger</span>.<span style="color:#a6e22e">QueryExecutor</span>) (<span style="color:#f92672">*</span><span style="color:#a6e22e">lifecycle</span>.<span style="color:#a6e22e">ChaincodeEndorsementInfo</span>, <span style="color:#66d9ef">error</span>)

	<span style="color:#75715e">// CheckACL checks the ACL for the resource for the channel using the
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// SignedProposal from which an id can be extracted for testing against a policy
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">CheckACL</span>(<span style="color:#a6e22e">channelID</span> <span style="color:#66d9ef">string</span>, <span style="color:#a6e22e">signedProp</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">pb</span>.<span style="color:#a6e22e">SignedProposal</span>) <span style="color:#66d9ef">error</span>

	<span style="color:#75715e">// EndorseWithPlugin endorses the response with a plugin
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">EndorseWithPlugin</span>(<span style="color:#a6e22e">pluginName</span>, <span style="color:#a6e22e">channnelID</span> <span style="color:#66d9ef">string</span>, <span style="color:#a6e22e">prpBytes</span> []<span style="color:#66d9ef">byte</span>, <span style="color:#a6e22e">signedProposal</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">pb</span>.<span style="color:#a6e22e">SignedProposal</span>) (<span style="color:#f92672">*</span><span style="color:#a6e22e">pb</span>.<span style="color:#a6e22e">Endorsement</span>, []<span style="color:#66d9ef">byte</span>, <span style="color:#66d9ef">error</span>)

	<span style="color:#75715e">// GetLedgerHeight returns ledger height for given channelID
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">GetLedgerHeight</span>(<span style="color:#a6e22e">channelID</span> <span style="color:#66d9ef">string</span>) (<span style="color:#66d9ef">uint64</span>, <span style="color:#66d9ef">error</span>)

	<span style="color:#75715e">// GetDeployedCCInfoProvider returns ledger.DeployedChaincodeInfoProvider
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">GetDeployedCCInfoProvider</span>() <span style="color:#a6e22e">ledger</span>.<span style="color:#a6e22e">DeployedChaincodeInfoProvider</span>
}

<span style="color:#75715e">//go:generate counterfeiter -o fake/channel_fetcher.go --fake-name ChannelFetcher . ChannelFetcher
</span><span style="color:#75715e"></span>
<span style="color:#75715e">// ChannelFetcher fetches the channel context for a given channel ID.
</span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">ChannelFetcher</span> <span style="color:#66d9ef">interface</span> {
	<span style="color:#a6e22e">Channel</span>(<span style="color:#a6e22e">channelID</span> <span style="color:#66d9ef">string</span>) <span style="color:#f92672">*</span><span style="color:#a6e22e">Channel</span>
}

<span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Channel</span> <span style="color:#66d9ef">struct</span> {
	<span style="color:#a6e22e">IdentityDeserializer</span> <span style="color:#a6e22e">msp</span>.<span style="color:#a6e22e">IdentityDeserializer</span>
}

<span style="color:#75715e">// Endorser provides the Endorser service ProcessProposal
</span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Endorser</span> <span style="color:#66d9ef">struct</span> {
	<span style="color:#a6e22e">ChannelFetcher</span>         <span style="color:#a6e22e">ChannelFetcher</span>
	<span style="color:#a6e22e">LocalMSP</span>               <span style="color:#a6e22e">msp</span>.<span style="color:#a6e22e">IdentityDeserializer</span>
	<span style="color:#a6e22e">PrivateDataDistributor</span> <span style="color:#a6e22e">PrivateDataDistributor</span>
	<span style="color:#a6e22e">Support</span>                <span style="color:#a6e22e">Support</span>
	<span style="color:#a6e22e">PvtRWSetAssembler</span>      <span style="color:#a6e22e">PvtRWSetAssembler</span>
	<span style="color:#a6e22e">Metrics</span>                <span style="color:#f92672">*</span><span style="color:#a6e22e">Metrics</span>
}

<span style="color:#75715e">// call specified chaincode (system or user)
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">e</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Endorser</span>) <span style="color:#a6e22e">callChaincode</span>(<span style="color:#a6e22e">txParams</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">ccprovider</span>.<span style="color:#a6e22e">TransactionParams</span>, <span style="color:#a6e22e">input</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">pb</span>.<span style="color:#a6e22e">ChaincodeInput</span>, <span style="color:#a6e22e">chaincodeName</span> <span style="color:#66d9ef">string</span>) (<span style="color:#f92672">*</span><span style="color:#a6e22e">pb</span>.<span style="color:#a6e22e">Response</span>, <span style="color:#f92672">*</span><span style="color:#a6e22e">pb</span>.<span style="color:#a6e22e">ChaincodeEvent</span>, <span style="color:#66d9ef">error</span>) {
	<span style="color:#66d9ef">defer</span> <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">start</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Time</span>) {
		<span style="color:#a6e22e">logger</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">endorserLogger</span>.<span style="color:#a6e22e">WithOptions</span>(<span style="color:#a6e22e">zap</span>.<span style="color:#a6e22e">AddCallerSkip</span>(<span style="color:#ae81ff">1</span>))
		<span style="color:#a6e22e">logger</span> = <span style="color:#a6e22e">decorateLogger</span>(<span style="color:#a6e22e">logger</span>, <span style="color:#a6e22e">txParams</span>)
		<span style="color:#a6e22e">elapsedMillisec</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Since</span>(<span style="color:#a6e22e">start</span>).<span style="color:#a6e22e">Milliseconds</span>()
		<span style="color:#a6e22e">logger</span>.<span style="color:#a6e22e">Infof</span>(<span style="color:#e6db74">&#34;finished chaincode: %s duration: %dms&#34;</span>, <span style="color:#a6e22e">chaincodeName</span>, <span style="color:#a6e22e">elapsedMillisec</span>)
	}(<span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Now</span>())

	<span style="color:#a6e22e">meterLabels</span> <span style="color:#f92672">:=</span> []<span style="color:#66d9ef">string</span>{
		<span style="color:#e6db74">&#34;channel&#34;</span>, <span style="color:#a6e22e">txParams</span>.<span style="color:#a6e22e">ChannelID</span>,
		<span style="color:#e6db74">&#34;chaincode&#34;</span>, <span style="color:#a6e22e">chaincodeName</span>,
	}

	<span style="color:#a6e22e">res</span>, <span style="color:#a6e22e">ccevent</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">Support</span>.<span style="color:#a6e22e">Execute</span>(<span style="color:#a6e22e">txParams</span>, <span style="color:#a6e22e">chaincodeName</span>, <span style="color:#a6e22e">input</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">Metrics</span>.<span style="color:#a6e22e">SimulationFailure</span>.<span style="color:#a6e22e">With</span>(<span style="color:#a6e22e">meterLabels</span><span style="color:#f92672">...</span>).<span style="color:#a6e22e">Add</span>(<span style="color:#ae81ff">1</span>)
		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">err</span>
	}

	<span style="color:#75715e">// per doc anything &lt; 400 can be sent as TX.
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// fabric errors will always be &gt;= 400 (ie, unambiguous errors )
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// &#34;lscc&#34; will respond with status 200 or 500 (ie, unambiguous OK or ERROR)
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">res</span>.<span style="color:#a6e22e">Status</span> <span style="color:#f92672">&gt;=</span> <span style="color:#a6e22e">shim</span>.<span style="color:#a6e22e">ERRORTHRESHOLD</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">res</span>, <span style="color:#66d9ef">nil</span>, <span style="color:#66d9ef">nil</span>
	}

	<span style="color:#75715e">// Unless this is the weirdo LSCC case, just return
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">chaincodeName</span> <span style="color:#f92672">!=</span> <span style="color:#e6db74">&#34;lscc&#34;</span> <span style="color:#f92672">||</span> len(<span style="color:#a6e22e">input</span>.<span style="color:#a6e22e">Args</span>) &lt; <span style="color:#ae81ff">3</span> <span style="color:#f92672">||</span> (string(<span style="color:#a6e22e">input</span>.<span style="color:#a6e22e">Args</span>[<span style="color:#ae81ff">0</span>]) <span style="color:#f92672">!=</span> <span style="color:#e6db74">&#34;deploy&#34;</span> <span style="color:#f92672">&amp;&amp;</span> string(<span style="color:#a6e22e">input</span>.<span style="color:#a6e22e">Args</span>[<span style="color:#ae81ff">0</span>]) <span style="color:#f92672">!=</span> <span style="color:#e6db74">&#34;upgrade&#34;</span>) {
		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">res</span>, <span style="color:#a6e22e">ccevent</span>, <span style="color:#66d9ef">nil</span>
	}

	<span style="color:#75715e">// ----- BEGIN -  SECTION THAT MAY NEED TO BE DONE IN LSCC ------
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// if this a call to deploy a chaincode, We need a mechanism
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// to pass TxSimulator into LSCC. Till that is worked out this
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// special code does the actual deploy, upgrade here so as to collect
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// all state under one TxSimulator
</span><span style="color:#75715e"></span>	<span style="color:#75715e">//
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// NOTE that if there&#39;s an error all simulation, including the chaincode
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// table changes in lscc will be thrown away
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">cds</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">protoutil</span>.<span style="color:#a6e22e">UnmarshalChaincodeDeploymentSpec</span>(<span style="color:#a6e22e">input</span>.<span style="color:#a6e22e">Args</span>[<span style="color:#ae81ff">2</span>])
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">Metrics</span>.<span style="color:#a6e22e">SimulationFailure</span>.<span style="color:#a6e22e">With</span>(<span style="color:#a6e22e">meterLabels</span><span style="color:#f92672">...</span>).<span style="color:#a6e22e">Add</span>(<span style="color:#ae81ff">1</span>)
		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">err</span>
	}

	<span style="color:#75715e">// this should not be a system chaincode
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">Support</span>.<span style="color:#a6e22e">IsSysCC</span>(<span style="color:#a6e22e">cds</span>.<span style="color:#a6e22e">ChaincodeSpec</span>.<span style="color:#a6e22e">ChaincodeId</span>.<span style="color:#a6e22e">Name</span>) {
		<span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">Metrics</span>.<span style="color:#a6e22e">SimulationFailure</span>.<span style="color:#a6e22e">With</span>(<span style="color:#a6e22e">meterLabels</span><span style="color:#f92672">...</span>).<span style="color:#a6e22e">Add</span>(<span style="color:#ae81ff">1</span>)
		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">errors</span>.<span style="color:#a6e22e">Errorf</span>(<span style="color:#e6db74">&#34;attempting to deploy a system chaincode %s/%s&#34;</span>, <span style="color:#a6e22e">cds</span>.<span style="color:#a6e22e">ChaincodeSpec</span>.<span style="color:#a6e22e">ChaincodeId</span>.<span style="color:#a6e22e">Name</span>, <span style="color:#a6e22e">txParams</span>.<span style="color:#a6e22e">ChannelID</span>)
	}

	<span style="color:#66d9ef">if</span> len(<span style="color:#a6e22e">cds</span>.<span style="color:#a6e22e">CodePackage</span>) <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span> {
		<span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">Metrics</span>.<span style="color:#a6e22e">SimulationFailure</span>.<span style="color:#a6e22e">With</span>(<span style="color:#a6e22e">meterLabels</span><span style="color:#f92672">...</span>).<span style="color:#a6e22e">Add</span>(<span style="color:#ae81ff">1</span>)
		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">errors</span>.<span style="color:#a6e22e">Errorf</span>(<span style="color:#e6db74">&#34;lscc upgrade/deploy should not include a code packages&#34;</span>)
	}

	<span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">Support</span>.<span style="color:#a6e22e">ExecuteLegacyInit</span>(<span style="color:#a6e22e">txParams</span>, <span style="color:#a6e22e">cds</span>.<span style="color:#a6e22e">ChaincodeSpec</span>.<span style="color:#a6e22e">ChaincodeId</span>.<span style="color:#a6e22e">Name</span>, <span style="color:#a6e22e">cds</span>.<span style="color:#a6e22e">ChaincodeSpec</span>.<span style="color:#a6e22e">ChaincodeId</span>.<span style="color:#a6e22e">Version</span>, <span style="color:#a6e22e">cds</span>.<span style="color:#a6e22e">ChaincodeSpec</span>.<span style="color:#a6e22e">Input</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#75715e">// increment the failure to indicate instantion/upgrade failures
</span><span style="color:#75715e"></span>		<span style="color:#a6e22e">meterLabels</span> = []<span style="color:#66d9ef">string</span>{
			<span style="color:#e6db74">&#34;channel&#34;</span>, <span style="color:#a6e22e">txParams</span>.<span style="color:#a6e22e">ChannelID</span>,
			<span style="color:#e6db74">&#34;chaincode&#34;</span>, <span style="color:#a6e22e">cds</span>.<span style="color:#a6e22e">ChaincodeSpec</span>.<span style="color:#a6e22e">ChaincodeId</span>.<span style="color:#a6e22e">Name</span>,
		}
		<span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">Metrics</span>.<span style="color:#a6e22e">InitFailed</span>.<span style="color:#a6e22e">With</span>(<span style="color:#a6e22e">meterLabels</span><span style="color:#f92672">...</span>).<span style="color:#a6e22e">Add</span>(<span style="color:#ae81ff">1</span>)
		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">err</span>
	}

	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">res</span>, <span style="color:#a6e22e">ccevent</span>, <span style="color:#a6e22e">err</span>

}

<span style="color:#75715e">// SimulateProposal simulates the proposal by calling the chaincode
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">e</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Endorser</span>) <span style="color:#a6e22e">SimulateProposal</span>(<span style="color:#a6e22e">txParams</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">ccprovider</span>.<span style="color:#a6e22e">TransactionParams</span>, <span style="color:#a6e22e">chaincodeName</span> <span style="color:#66d9ef">string</span>, <span style="color:#a6e22e">chaincodeInput</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">pb</span>.<span style="color:#a6e22e">ChaincodeInput</span>) (<span style="color:#f92672">*</span><span style="color:#a6e22e">pb</span>.<span style="color:#a6e22e">Response</span>, []<span style="color:#66d9ef">byte</span>, <span style="color:#f92672">*</span><span style="color:#a6e22e">pb</span>.<span style="color:#a6e22e">ChaincodeEvent</span>, <span style="color:#66d9ef">error</span>) {
	<span style="color:#a6e22e">logger</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">decorateLogger</span>(<span style="color:#a6e22e">endorserLogger</span>, <span style="color:#a6e22e">txParams</span>)

	<span style="color:#a6e22e">meterLabels</span> <span style="color:#f92672">:=</span> []<span style="color:#66d9ef">string</span>{
		<span style="color:#e6db74">&#34;channel&#34;</span>, <span style="color:#a6e22e">txParams</span>.<span style="color:#a6e22e">ChannelID</span>,
		<span style="color:#e6db74">&#34;chaincode&#34;</span>, <span style="color:#a6e22e">chaincodeName</span>,
	}

	<span style="color:#75715e">// ---3. execute the proposal and get simulation results
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">res</span>, <span style="color:#a6e22e">ccevent</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">callChaincode</span>(<span style="color:#a6e22e">txParams</span>, <span style="color:#a6e22e">chaincodeInput</span>, <span style="color:#a6e22e">chaincodeName</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">logger</span>.<span style="color:#a6e22e">Errorf</span>(<span style="color:#e6db74">&#34;failed to invoke chaincode %s, error: %+v&#34;</span>, <span style="color:#a6e22e">chaincodeName</span>, <span style="color:#a6e22e">err</span>)
		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#66d9ef">nil</span>, <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">err</span>
	}

	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">txParams</span>.<span style="color:#a6e22e">TXSimulator</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">res</span>, <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">ccevent</span>, <span style="color:#66d9ef">nil</span>
	}

	<span style="color:#75715e">// Note, this is a little goofy, as if there is private data, Done() gets called
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// early, so this is invoked multiple times, but that is how the code worked before
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// this change, so, should be safe.  Long term, let&#39;s move the Done up to the create.
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">txParams</span>.<span style="color:#a6e22e">TXSimulator</span>.<span style="color:#a6e22e">Done</span>()

	<span style="color:#a6e22e">simResult</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">txParams</span>.<span style="color:#a6e22e">TXSimulator</span>.<span style="color:#a6e22e">GetTxSimulationResults</span>()
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">Metrics</span>.<span style="color:#a6e22e">SimulationFailure</span>.<span style="color:#a6e22e">With</span>(<span style="color:#a6e22e">meterLabels</span><span style="color:#f92672">...</span>).<span style="color:#a6e22e">Add</span>(<span style="color:#ae81ff">1</span>)
		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#66d9ef">nil</span>, <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">err</span>
	}

	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">simResult</span>.<span style="color:#a6e22e">PvtSimulationResults</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">chaincodeName</span> <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;lscc&#34;</span> {
			<span style="color:#75715e">// TODO: remove once we can store collection configuration outside of LSCC
</span><span style="color:#75715e"></span>			<span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">Metrics</span>.<span style="color:#a6e22e">SimulationFailure</span>.<span style="color:#a6e22e">With</span>(<span style="color:#a6e22e">meterLabels</span><span style="color:#f92672">...</span>).<span style="color:#a6e22e">Add</span>(<span style="color:#ae81ff">1</span>)
			<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#66d9ef">nil</span>, <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">errors</span>.<span style="color:#a6e22e">New</span>(<span style="color:#e6db74">&#34;Private data is forbidden to be used in instantiate&#34;</span>)
		}
		<span style="color:#a6e22e">pvtDataWithConfig</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">AssemblePvtRWSet</span>(<span style="color:#a6e22e">txParams</span>.<span style="color:#a6e22e">ChannelID</span>, <span style="color:#a6e22e">simResult</span>.<span style="color:#a6e22e">PvtSimulationResults</span>, <span style="color:#a6e22e">txParams</span>.<span style="color:#a6e22e">TXSimulator</span>, <span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">Support</span>.<span style="color:#a6e22e">GetDeployedCCInfoProvider</span>())
		<span style="color:#75715e">// To read collection config need to read collection updates before
</span><span style="color:#75715e"></span>		<span style="color:#75715e">// releasing the lock, hence txParams.TXSimulator.Done()  moved down here
</span><span style="color:#75715e"></span>		<span style="color:#a6e22e">txParams</span>.<span style="color:#a6e22e">TXSimulator</span>.<span style="color:#a6e22e">Done</span>()

		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
			<span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">Metrics</span>.<span style="color:#a6e22e">SimulationFailure</span>.<span style="color:#a6e22e">With</span>(<span style="color:#a6e22e">meterLabels</span><span style="color:#f92672">...</span>).<span style="color:#a6e22e">Add</span>(<span style="color:#ae81ff">1</span>)
			<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#66d9ef">nil</span>, <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">errors</span>.<span style="color:#a6e22e">WithMessage</span>(<span style="color:#a6e22e">err</span>, <span style="color:#e6db74">&#34;failed to obtain collections config&#34;</span>)
		}
		<span style="color:#a6e22e">endorsedAt</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">Support</span>.<span style="color:#a6e22e">GetLedgerHeight</span>(<span style="color:#a6e22e">txParams</span>.<span style="color:#a6e22e">ChannelID</span>)
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
			<span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">Metrics</span>.<span style="color:#a6e22e">SimulationFailure</span>.<span style="color:#a6e22e">With</span>(<span style="color:#a6e22e">meterLabels</span><span style="color:#f92672">...</span>).<span style="color:#a6e22e">Add</span>(<span style="color:#ae81ff">1</span>)
			<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#66d9ef">nil</span>, <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">errors</span>.<span style="color:#a6e22e">WithMessage</span>(<span style="color:#a6e22e">err</span>, <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Sprintf</span>(<span style="color:#e6db74">&#34;failed to obtain ledger height for channel &#39;%s&#39;&#34;</span>, <span style="color:#a6e22e">txParams</span>.<span style="color:#a6e22e">ChannelID</span>))
		}
		<span style="color:#75715e">// Add ledger height at which transaction was endorsed,
</span><span style="color:#75715e"></span>		<span style="color:#75715e">// `endorsedAt` is obtained from the block storage and at times this could be &#39;endorsement Height + 1&#39;.
</span><span style="color:#75715e"></span>		<span style="color:#75715e">// However, since we use this height only to select the configuration (3rd parameter in distributePrivateData) and
</span><span style="color:#75715e"></span>		<span style="color:#75715e">// manage transient store purge for orphaned private writesets (4th parameter in distributePrivateData), this works for now.
</span><span style="color:#75715e"></span>		<span style="color:#75715e">// Ideally, ledger should add support in the simulator as a first class function `GetHeight()`.
</span><span style="color:#75715e"></span>		<span style="color:#a6e22e">pvtDataWithConfig</span>.<span style="color:#a6e22e">EndorsedAt</span> = <span style="color:#a6e22e">endorsedAt</span>
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">PrivateDataDistributor</span>.<span style="color:#a6e22e">DistributePrivateData</span>(<span style="color:#a6e22e">txParams</span>.<span style="color:#a6e22e">ChannelID</span>, <span style="color:#a6e22e">txParams</span>.<span style="color:#a6e22e">TxID</span>, <span style="color:#a6e22e">pvtDataWithConfig</span>, <span style="color:#a6e22e">endorsedAt</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
			<span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">Metrics</span>.<span style="color:#a6e22e">SimulationFailure</span>.<span style="color:#a6e22e">With</span>(<span style="color:#a6e22e">meterLabels</span><span style="color:#f92672">...</span>).<span style="color:#a6e22e">Add</span>(<span style="color:#ae81ff">1</span>)
			<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#66d9ef">nil</span>, <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">err</span>
		}
	}

	<span style="color:#a6e22e">pubSimResBytes</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">simResult</span>.<span style="color:#a6e22e">GetPubSimulationBytes</span>()
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">Metrics</span>.<span style="color:#a6e22e">SimulationFailure</span>.<span style="color:#a6e22e">With</span>(<span style="color:#a6e22e">meterLabels</span><span style="color:#f92672">...</span>).<span style="color:#a6e22e">Add</span>(<span style="color:#ae81ff">1</span>)
		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#66d9ef">nil</span>, <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">err</span>
	}

	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">res</span>, <span style="color:#a6e22e">pubSimResBytes</span>, <span style="color:#a6e22e">ccevent</span>, <span style="color:#66d9ef">nil</span>
}

<span style="color:#75715e">// preProcess checks the tx proposal headers, uniqueness and ACL
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">e</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Endorser</span>) <span style="color:#a6e22e">preProcess</span>(<span style="color:#a6e22e">up</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">UnpackedProposal</span>, <span style="color:#a6e22e">channel</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Channel</span>) <span style="color:#66d9ef">error</span> {
	<span style="color:#75715e">// at first, we check whether the message is valid
</span><span style="color:#75715e"></span>
	<span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">up</span>.<span style="color:#a6e22e">Validate</span>(<span style="color:#a6e22e">channel</span>.<span style="color:#a6e22e">IdentityDeserializer</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">Metrics</span>.<span style="color:#a6e22e">ProposalValidationFailed</span>.<span style="color:#a6e22e">Add</span>(<span style="color:#ae81ff">1</span>)
		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">errors</span>.<span style="color:#a6e22e">WithMessage</span>(<span style="color:#a6e22e">err</span>, <span style="color:#e6db74">&#34;error validating proposal&#34;</span>)
	}

	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">up</span>.<span style="color:#a6e22e">ChannelHeader</span>.<span style="color:#a6e22e">ChannelId</span> <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;&#34;</span> {
		<span style="color:#75715e">// chainless proposals do not/cannot affect ledger and cannot be submitted as transactions
</span><span style="color:#75715e"></span>		<span style="color:#75715e">// ignore uniqueness checks; also, chainless proposals are not validated using the policies
</span><span style="color:#75715e"></span>		<span style="color:#75715e">// of the chain since by definition there is no chain; they are validated against the local
</span><span style="color:#75715e"></span>		<span style="color:#75715e">// MSP of the peer instead by the call to ValidateUnpackProposal above
</span><span style="color:#75715e"></span>		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>
	}

	<span style="color:#75715e">// labels that provide context for failure metrics
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">meterLabels</span> <span style="color:#f92672">:=</span> []<span style="color:#66d9ef">string</span>{
		<span style="color:#e6db74">&#34;channel&#34;</span>, <span style="color:#a6e22e">up</span>.<span style="color:#a6e22e">ChannelHeader</span>.<span style="color:#a6e22e">ChannelId</span>,
		<span style="color:#e6db74">&#34;chaincode&#34;</span>, <span style="color:#a6e22e">up</span>.<span style="color:#a6e22e">ChaincodeName</span>,
	}

	<span style="color:#75715e">// Here we handle uniqueness check and ACLs for proposals targeting a chain
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// Notice that ValidateProposalMessage has already verified that TxID is computed properly
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">Support</span>.<span style="color:#a6e22e">GetTransactionByID</span>(<span style="color:#a6e22e">up</span>.<span style="color:#a6e22e">ChannelHeader</span>.<span style="color:#a6e22e">ChannelId</span>, <span style="color:#a6e22e">up</span>.<span style="color:#a6e22e">ChannelHeader</span>.<span style="color:#a6e22e">TxId</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#75715e">// increment failure due to duplicate transactions. Useful for catching replay attacks in
</span><span style="color:#75715e"></span>		<span style="color:#75715e">// addition to benign retries
</span><span style="color:#75715e"></span>		<span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">Metrics</span>.<span style="color:#a6e22e">DuplicateTxsFailure</span>.<span style="color:#a6e22e">With</span>(<span style="color:#a6e22e">meterLabels</span><span style="color:#f92672">...</span>).<span style="color:#a6e22e">Add</span>(<span style="color:#ae81ff">1</span>)
		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">errors</span>.<span style="color:#a6e22e">Errorf</span>(<span style="color:#e6db74">&#34;duplicate transaction found [%s]. Creator [%x]&#34;</span>, <span style="color:#a6e22e">up</span>.<span style="color:#a6e22e">ChannelHeader</span>.<span style="color:#a6e22e">TxId</span>, <span style="color:#a6e22e">up</span>.<span style="color:#a6e22e">SignatureHeader</span>.<span style="color:#a6e22e">Creator</span>)
	}

	<span style="color:#75715e">// check ACL only for application chaincodes; ACLs
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// for system chaincodes are checked elsewhere
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span> !<span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">Support</span>.<span style="color:#a6e22e">IsSysCC</span>(<span style="color:#a6e22e">up</span>.<span style="color:#a6e22e">ChaincodeName</span>) {
		<span style="color:#75715e">// check that the proposal complies with the Channel&#39;s writers
</span><span style="color:#75715e"></span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">Support</span>.<span style="color:#a6e22e">CheckACL</span>(<span style="color:#a6e22e">up</span>.<span style="color:#a6e22e">ChannelHeader</span>.<span style="color:#a6e22e">ChannelId</span>, <span style="color:#a6e22e">up</span>.<span style="color:#a6e22e">SignedProposal</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
			<span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">Metrics</span>.<span style="color:#a6e22e">ProposalACLCheckFailed</span>.<span style="color:#a6e22e">With</span>(<span style="color:#a6e22e">meterLabels</span><span style="color:#f92672">...</span>).<span style="color:#a6e22e">Add</span>(<span style="color:#ae81ff">1</span>)
			<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>
		}
	}

	<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>
}

<span style="color:#75715e">// ProcessProposal process the Proposal
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">e</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Endorser</span>) <span style="color:#a6e22e">ProcessProposal</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>, <span style="color:#a6e22e">signedProp</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">pb</span>.<span style="color:#a6e22e">SignedProposal</span>) (<span style="color:#f92672">*</span><span style="color:#a6e22e">pb</span>.<span style="color:#a6e22e">ProposalResponse</span>, <span style="color:#66d9ef">error</span>) {
	<span style="color:#75715e">// start time for computing elapsed time metric for successfully endorsed proposals
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">startTime</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Now</span>()
	<span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">Metrics</span>.<span style="color:#a6e22e">ProposalsReceived</span>.<span style="color:#a6e22e">Add</span>(<span style="color:#ae81ff">1</span>)

	<span style="color:#a6e22e">addr</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">util</span>.<span style="color:#a6e22e">ExtractRemoteAddress</span>(<span style="color:#a6e22e">ctx</span>)
	<span style="color:#a6e22e">endorserLogger</span>.<span style="color:#a6e22e">Debug</span>(<span style="color:#e6db74">&#34;request from&#34;</span>, <span style="color:#a6e22e">addr</span>)

	<span style="color:#75715e">// variables to capture proposal duration metric
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">success</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">false</span>

	<span style="color:#a6e22e">up</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">UnpackProposal</span>(<span style="color:#a6e22e">signedProp</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">Metrics</span>.<span style="color:#a6e22e">ProposalValidationFailed</span>.<span style="color:#a6e22e">Add</span>(<span style="color:#ae81ff">1</span>)
		<span style="color:#66d9ef">return</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">pb</span>.<span style="color:#a6e22e">ProposalResponse</span>{<span style="color:#a6e22e">Response</span>: <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">pb</span>.<span style="color:#a6e22e">Response</span>{<span style="color:#a6e22e">Status</span>: <span style="color:#ae81ff">500</span>, <span style="color:#a6e22e">Message</span>: <span style="color:#a6e22e">err</span>.<span style="color:#a6e22e">Error</span>()}}, <span style="color:#a6e22e">err</span>
	}

	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">channel</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Channel</span>
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">up</span>.<span style="color:#a6e22e">ChannelID</span>() <span style="color:#f92672">!=</span> <span style="color:#e6db74">&#34;&#34;</span> {
		<span style="color:#a6e22e">channel</span> = <span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">ChannelFetcher</span>.<span style="color:#a6e22e">Channel</span>(<span style="color:#a6e22e">up</span>.<span style="color:#a6e22e">ChannelID</span>())
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">channel</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">nil</span> {
			<span style="color:#66d9ef">return</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">pb</span>.<span style="color:#a6e22e">ProposalResponse</span>{<span style="color:#a6e22e">Response</span>: <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">pb</span>.<span style="color:#a6e22e">Response</span>{<span style="color:#a6e22e">Status</span>: <span style="color:#ae81ff">500</span>, <span style="color:#a6e22e">Message</span>: <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Sprintf</span>(<span style="color:#e6db74">&#34;channel &#39;%s&#39; not found&#34;</span>, <span style="color:#a6e22e">up</span>.<span style="color:#a6e22e">ChannelHeader</span>.<span style="color:#a6e22e">ChannelId</span>)}}, <span style="color:#66d9ef">nil</span>
		}
	} <span style="color:#66d9ef">else</span> {
		<span style="color:#a6e22e">channel</span> = <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">Channel</span>{
			<span style="color:#a6e22e">IdentityDeserializer</span>: <span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">LocalMSP</span>,
		}
	}

	<span style="color:#75715e">// 0 -- check and validate
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">preProcess</span>(<span style="color:#a6e22e">up</span>, <span style="color:#a6e22e">channel</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">pb</span>.<span style="color:#a6e22e">ProposalResponse</span>{<span style="color:#a6e22e">Response</span>: <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">pb</span>.<span style="color:#a6e22e">Response</span>{<span style="color:#a6e22e">Status</span>: <span style="color:#ae81ff">500</span>, <span style="color:#a6e22e">Message</span>: <span style="color:#a6e22e">err</span>.<span style="color:#a6e22e">Error</span>()}}, <span style="color:#a6e22e">err</span>
	}

	<span style="color:#66d9ef">defer</span> <span style="color:#66d9ef">func</span>() {
		<span style="color:#a6e22e">meterLabels</span> <span style="color:#f92672">:=</span> []<span style="color:#66d9ef">string</span>{
			<span style="color:#e6db74">&#34;channel&#34;</span>, <span style="color:#a6e22e">up</span>.<span style="color:#a6e22e">ChannelHeader</span>.<span style="color:#a6e22e">ChannelId</span>,
			<span style="color:#e6db74">&#34;chaincode&#34;</span>, <span style="color:#a6e22e">up</span>.<span style="color:#a6e22e">ChaincodeName</span>,
			<span style="color:#e6db74">&#34;success&#34;</span>, <span style="color:#a6e22e">strconv</span>.<span style="color:#a6e22e">FormatBool</span>(<span style="color:#a6e22e">success</span>),
		}
		<span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">Metrics</span>.<span style="color:#a6e22e">ProposalDuration</span>.<span style="color:#a6e22e">With</span>(<span style="color:#a6e22e">meterLabels</span><span style="color:#f92672">...</span>).<span style="color:#a6e22e">Observe</span>(<span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Since</span>(<span style="color:#a6e22e">startTime</span>).<span style="color:#a6e22e">Seconds</span>())
	}()

	<span style="color:#a6e22e">pResp</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">ProcessProposalSuccessfullyOrError</span>(<span style="color:#a6e22e">up</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">pb</span>.<span style="color:#a6e22e">ProposalResponse</span>{<span style="color:#a6e22e">Response</span>: <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">pb</span>.<span style="color:#a6e22e">Response</span>{<span style="color:#a6e22e">Status</span>: <span style="color:#ae81ff">500</span>, <span style="color:#a6e22e">Message</span>: <span style="color:#a6e22e">err</span>.<span style="color:#a6e22e">Error</span>()}}, <span style="color:#66d9ef">nil</span>
	}

	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">pResp</span>.<span style="color:#a6e22e">Endorsement</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> <span style="color:#f92672">||</span> <span style="color:#a6e22e">up</span>.<span style="color:#a6e22e">ChannelHeader</span>.<span style="color:#a6e22e">ChannelId</span> <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;&#34;</span> {
		<span style="color:#75715e">// We mark the tx as successfull only if it was successfully endorsed, or
</span><span style="color:#75715e"></span>		<span style="color:#75715e">// if it was a system chaincode on a channel-less channel and therefore
</span><span style="color:#75715e"></span>		<span style="color:#75715e">// cannot be endorsed.
</span><span style="color:#75715e"></span>		<span style="color:#a6e22e">success</span> = <span style="color:#66d9ef">true</span>

		<span style="color:#75715e">// total failed proposals = ProposalsReceived-SuccessfulProposals
</span><span style="color:#75715e"></span>		<span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">Metrics</span>.<span style="color:#a6e22e">SuccessfulProposals</span>.<span style="color:#a6e22e">Add</span>(<span style="color:#ae81ff">1</span>)
	}
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">pResp</span>, <span style="color:#66d9ef">nil</span>
}

<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">e</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Endorser</span>) <span style="color:#a6e22e">ProcessProposalSuccessfullyOrError</span>(<span style="color:#a6e22e">up</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">UnpackedProposal</span>) (<span style="color:#f92672">*</span><span style="color:#a6e22e">pb</span>.<span style="color:#a6e22e">ProposalResponse</span>, <span style="color:#66d9ef">error</span>) {
	<span style="color:#a6e22e">txParams</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">ccprovider</span>.<span style="color:#a6e22e">TransactionParams</span>{
		<span style="color:#a6e22e">ChannelID</span>:  <span style="color:#a6e22e">up</span>.<span style="color:#a6e22e">ChannelHeader</span>.<span style="color:#a6e22e">ChannelId</span>,
		<span style="color:#a6e22e">TxID</span>:       <span style="color:#a6e22e">up</span>.<span style="color:#a6e22e">ChannelHeader</span>.<span style="color:#a6e22e">TxId</span>,
		<span style="color:#a6e22e">SignedProp</span>: <span style="color:#a6e22e">up</span>.<span style="color:#a6e22e">SignedProposal</span>,
		<span style="color:#a6e22e">Proposal</span>:   <span style="color:#a6e22e">up</span>.<span style="color:#a6e22e">Proposal</span>,
	}

	<span style="color:#a6e22e">logger</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">decorateLogger</span>(<span style="color:#a6e22e">endorserLogger</span>, <span style="color:#a6e22e">txParams</span>)

	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">acquireTxSimulator</span>(<span style="color:#a6e22e">up</span>.<span style="color:#a6e22e">ChannelHeader</span>.<span style="color:#a6e22e">ChannelId</span>, <span style="color:#a6e22e">up</span>.<span style="color:#a6e22e">ChaincodeName</span>) {
		<span style="color:#a6e22e">txSim</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">Support</span>.<span style="color:#a6e22e">GetTxSimulator</span>(<span style="color:#a6e22e">up</span>.<span style="color:#a6e22e">ChannelID</span>(), <span style="color:#a6e22e">up</span>.<span style="color:#a6e22e">TxID</span>())
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
			<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">err</span>
		}

		<span style="color:#75715e">// txsim acquires a shared lock on the stateDB. As this would impact the block commits (i.e., commit
</span><span style="color:#75715e"></span>		<span style="color:#75715e">// of valid write-sets to the stateDB), we must release the lock as early as possible.
</span><span style="color:#75715e"></span>		<span style="color:#75715e">// Hence, this txsim object is closed in simulateProposal() as soon as the tx is simulated and
</span><span style="color:#75715e"></span>		<span style="color:#75715e">// rwset is collected before gossip dissemination if required for privateData. For safety, we
</span><span style="color:#75715e"></span>		<span style="color:#75715e">// add the following defer statement and is useful when an error occur. Note that calling
</span><span style="color:#75715e"></span>		<span style="color:#75715e">// txsim.Done() more than once does not cause any issue. If the txsim is already
</span><span style="color:#75715e"></span>		<span style="color:#75715e">// released, the following txsim.Done() simply returns.
</span><span style="color:#75715e"></span>		<span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">txSim</span>.<span style="color:#a6e22e">Done</span>()

		<span style="color:#a6e22e">hqe</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">Support</span>.<span style="color:#a6e22e">GetHistoryQueryExecutor</span>(<span style="color:#a6e22e">up</span>.<span style="color:#a6e22e">ChannelID</span>())
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
			<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">err</span>
		}

		<span style="color:#a6e22e">txParams</span>.<span style="color:#a6e22e">TXSimulator</span> = <span style="color:#a6e22e">txSim</span>
		<span style="color:#a6e22e">txParams</span>.<span style="color:#a6e22e">HistoryQueryExecutor</span> = <span style="color:#a6e22e">hqe</span>
	}

	<span style="color:#a6e22e">cdLedger</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">Support</span>.<span style="color:#a6e22e">ChaincodeEndorsementInfo</span>(<span style="color:#a6e22e">up</span>.<span style="color:#a6e22e">ChannelID</span>(), <span style="color:#a6e22e">up</span>.<span style="color:#a6e22e">ChaincodeName</span>, <span style="color:#a6e22e">txParams</span>.<span style="color:#a6e22e">TXSimulator</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">errors</span>.<span style="color:#a6e22e">WithMessagef</span>(<span style="color:#a6e22e">err</span>, <span style="color:#e6db74">&#34;make sure the chaincode %s has been successfully defined on channel %s and try again&#34;</span>, <span style="color:#a6e22e">up</span>.<span style="color:#a6e22e">ChaincodeName</span>, <span style="color:#a6e22e">up</span>.<span style="color:#a6e22e">ChannelID</span>())
	}

	<span style="color:#75715e">// 1 -- simulate
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">res</span>, <span style="color:#a6e22e">simulationResult</span>, <span style="color:#a6e22e">ccevent</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">SimulateProposal</span>(<span style="color:#a6e22e">txParams</span>, <span style="color:#a6e22e">up</span>.<span style="color:#a6e22e">ChaincodeName</span>, <span style="color:#a6e22e">up</span>.<span style="color:#a6e22e">Input</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">errors</span>.<span style="color:#a6e22e">WithMessage</span>(<span style="color:#a6e22e">err</span>, <span style="color:#e6db74">&#34;error in simulation&#34;</span>)
	}

	<span style="color:#a6e22e">cceventBytes</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">CreateCCEventBytes</span>(<span style="color:#a6e22e">ccevent</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">errors</span>.<span style="color:#a6e22e">Wrap</span>(<span style="color:#a6e22e">err</span>, <span style="color:#e6db74">&#34;failed to marshal chaincode event&#34;</span>)
	}

	<span style="color:#a6e22e">prpBytes</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">protoutil</span>.<span style="color:#a6e22e">GetBytesProposalResponsePayload</span>(<span style="color:#a6e22e">up</span>.<span style="color:#a6e22e">ProposalHash</span>, <span style="color:#a6e22e">res</span>, <span style="color:#a6e22e">simulationResult</span>, <span style="color:#a6e22e">cceventBytes</span>, <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">pb</span>.<span style="color:#a6e22e">ChaincodeID</span>{
		<span style="color:#a6e22e">Name</span>:    <span style="color:#a6e22e">up</span>.<span style="color:#a6e22e">ChaincodeName</span>,
		<span style="color:#a6e22e">Version</span>: <span style="color:#a6e22e">cdLedger</span>.<span style="color:#a6e22e">Version</span>,
	})
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">logger</span>.<span style="color:#a6e22e">Warning</span>(<span style="color:#e6db74">&#34;Failed marshaling the proposal response payload to bytes&#34;</span>, <span style="color:#a6e22e">err</span>)
		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">errors</span>.<span style="color:#a6e22e">WithMessage</span>(<span style="color:#a6e22e">err</span>, <span style="color:#e6db74">&#34;failed to create the proposal response&#34;</span>)
	}

	<span style="color:#75715e">// if error, capture endorsement failure metric
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">meterLabels</span> <span style="color:#f92672">:=</span> []<span style="color:#66d9ef">string</span>{
		<span style="color:#e6db74">&#34;channel&#34;</span>, <span style="color:#a6e22e">up</span>.<span style="color:#a6e22e">ChannelID</span>(),
		<span style="color:#e6db74">&#34;chaincode&#34;</span>, <span style="color:#a6e22e">up</span>.<span style="color:#a6e22e">ChaincodeName</span>,
	}

	<span style="color:#66d9ef">switch</span> {
	<span style="color:#66d9ef">case</span> <span style="color:#a6e22e">res</span>.<span style="color:#a6e22e">Status</span> <span style="color:#f92672">&gt;=</span> <span style="color:#a6e22e">shim</span>.<span style="color:#a6e22e">ERROR</span>:
		<span style="color:#66d9ef">return</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">pb</span>.<span style="color:#a6e22e">ProposalResponse</span>{
			<span style="color:#a6e22e">Response</span>: <span style="color:#a6e22e">res</span>,
			<span style="color:#a6e22e">Payload</span>:  <span style="color:#a6e22e">prpBytes</span>,
		}, <span style="color:#66d9ef">nil</span>
	<span style="color:#66d9ef">case</span> <span style="color:#a6e22e">up</span>.<span style="color:#a6e22e">ChannelID</span>() <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;&#34;</span>:
		<span style="color:#75715e">// Chaincode invocations without a channel ID is a broken concept
</span><span style="color:#75715e"></span>		<span style="color:#75715e">// that should be removed in the future.  For now, return unendorsed
</span><span style="color:#75715e"></span>		<span style="color:#75715e">// success.
</span><span style="color:#75715e"></span>		<span style="color:#66d9ef">return</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">pb</span>.<span style="color:#a6e22e">ProposalResponse</span>{
			<span style="color:#a6e22e">Response</span>: <span style="color:#a6e22e">res</span>,
		}, <span style="color:#66d9ef">nil</span>
	<span style="color:#66d9ef">case</span> <span style="color:#a6e22e">res</span>.<span style="color:#a6e22e">Status</span> <span style="color:#f92672">&gt;=</span> <span style="color:#a6e22e">shim</span>.<span style="color:#a6e22e">ERRORTHRESHOLD</span>:
		<span style="color:#a6e22e">meterLabels</span> = append(<span style="color:#a6e22e">meterLabels</span>, <span style="color:#e6db74">&#34;chaincodeerror&#34;</span>, <span style="color:#a6e22e">strconv</span>.<span style="color:#a6e22e">FormatBool</span>(<span style="color:#66d9ef">true</span>))
		<span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">Metrics</span>.<span style="color:#a6e22e">EndorsementsFailed</span>.<span style="color:#a6e22e">With</span>(<span style="color:#a6e22e">meterLabels</span><span style="color:#f92672">...</span>).<span style="color:#a6e22e">Add</span>(<span style="color:#ae81ff">1</span>)
		<span style="color:#a6e22e">logger</span>.<span style="color:#a6e22e">Debugf</span>(<span style="color:#e6db74">&#34;chaincode error %d&#34;</span>, <span style="color:#a6e22e">res</span>.<span style="color:#a6e22e">Status</span>)
		<span style="color:#66d9ef">return</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">pb</span>.<span style="color:#a6e22e">ProposalResponse</span>{
			<span style="color:#a6e22e">Response</span>: <span style="color:#a6e22e">res</span>,
		}, <span style="color:#66d9ef">nil</span>
	}

	<span style="color:#a6e22e">escc</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">cdLedger</span>.<span style="color:#a6e22e">EndorsementPlugin</span>

	<span style="color:#a6e22e">logger</span>.<span style="color:#a6e22e">Debugf</span>(<span style="color:#e6db74">&#34;escc for chaincode %s is %s&#34;</span>, <span style="color:#a6e22e">up</span>.<span style="color:#a6e22e">ChaincodeName</span>, <span style="color:#a6e22e">escc</span>)

	<span style="color:#75715e">// Note, mPrpBytes is the same as prpBytes by default endorsement plugin, but others could change it.
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">endorsement</span>, <span style="color:#a6e22e">mPrpBytes</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">Support</span>.<span style="color:#a6e22e">EndorseWithPlugin</span>(<span style="color:#a6e22e">escc</span>, <span style="color:#a6e22e">up</span>.<span style="color:#a6e22e">ChannelID</span>(), <span style="color:#a6e22e">prpBytes</span>, <span style="color:#a6e22e">up</span>.<span style="color:#a6e22e">SignedProposal</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">meterLabels</span> = append(<span style="color:#a6e22e">meterLabels</span>, <span style="color:#e6db74">&#34;chaincodeerror&#34;</span>, <span style="color:#a6e22e">strconv</span>.<span style="color:#a6e22e">FormatBool</span>(<span style="color:#66d9ef">false</span>))
		<span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">Metrics</span>.<span style="color:#a6e22e">EndorsementsFailed</span>.<span style="color:#a6e22e">With</span>(<span style="color:#a6e22e">meterLabels</span><span style="color:#f92672">...</span>).<span style="color:#a6e22e">Add</span>(<span style="color:#ae81ff">1</span>)
		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">errors</span>.<span style="color:#a6e22e">WithMessage</span>(<span style="color:#a6e22e">err</span>, <span style="color:#e6db74">&#34;endorsing with plugin failed&#34;</span>)
	}

	<span style="color:#66d9ef">return</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">pb</span>.<span style="color:#a6e22e">ProposalResponse</span>{
		<span style="color:#a6e22e">Version</span>:     <span style="color:#ae81ff">1</span>,
		<span style="color:#a6e22e">Endorsement</span>: <span style="color:#a6e22e">endorsement</span>,
		<span style="color:#a6e22e">Payload</span>:     <span style="color:#a6e22e">mPrpBytes</span>,
		<span style="color:#a6e22e">Response</span>:    <span style="color:#a6e22e">res</span>,
	}, <span style="color:#66d9ef">nil</span>
}

<span style="color:#75715e">// determine whether or not a transaction simulator should be
</span><span style="color:#75715e">// obtained for a proposal.
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">acquireTxSimulator</span>(<span style="color:#a6e22e">chainID</span> <span style="color:#66d9ef">string</span>, <span style="color:#a6e22e">chaincodeName</span> <span style="color:#66d9ef">string</span>) <span style="color:#66d9ef">bool</span> {
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">chainID</span> <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;&#34;</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span>
	}

	<span style="color:#75715e">// ¯\_(ツ)_/¯ locking.
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// Don&#39;t get a simulator for the query and config system chaincode.
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// These don&#39;t need the simulator and its read lock results in deadlocks.
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">switch</span> <span style="color:#a6e22e">chaincodeName</span> {
	<span style="color:#66d9ef">case</span> <span style="color:#e6db74">&#34;qscc&#34;</span>, <span style="color:#e6db74">&#34;cscc&#34;</span>:
		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span>
	<span style="color:#66d9ef">default</span>:
		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">true</span>
	}
}

<span style="color:#75715e">// shorttxid replicates the chaincode package function to shorten txids.
</span><span style="color:#75715e">// ~~TODO utilize a common shorttxid utility across packages.~~
</span><span style="color:#75715e">// TODO use a formal type for transaction ID and make it a stringer
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">shorttxid</span>(<span style="color:#a6e22e">txid</span> <span style="color:#66d9ef">string</span>) <span style="color:#66d9ef">string</span> {
	<span style="color:#66d9ef">if</span> len(<span style="color:#a6e22e">txid</span>) &lt; <span style="color:#ae81ff">8</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">txid</span>
	}
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">txid</span>[<span style="color:#ae81ff">0</span>:<span style="color:#ae81ff">8</span>]
}

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">CreateCCEventBytes</span>(<span style="color:#a6e22e">ccevent</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">pb</span>.<span style="color:#a6e22e">ChaincodeEvent</span>) ([]<span style="color:#66d9ef">byte</span>, <span style="color:#66d9ef">error</span>) {
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">ccevent</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#66d9ef">nil</span>
	}

	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">proto</span>.<span style="color:#a6e22e">Marshal</span>(<span style="color:#a6e22e">ccevent</span>)
}

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">decorateLogger</span>(<span style="color:#a6e22e">logger</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">flogging</span>.<span style="color:#a6e22e">FabricLogger</span>, <span style="color:#a6e22e">txParams</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">ccprovider</span>.<span style="color:#a6e22e">TransactionParams</span>) <span style="color:#f92672">*</span><span style="color:#a6e22e">flogging</span>.<span style="color:#a6e22e">FabricLogger</span> {
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">logger</span>.<span style="color:#a6e22e">With</span>(<span style="color:#e6db74">&#34;channel&#34;</span>, <span style="color:#a6e22e">txParams</span>.<span style="color:#a6e22e">ChannelID</span>, <span style="color:#e6db74">&#34;txID&#34;</span>, <span style="color:#a6e22e">shorttxid</span>(<span style="color:#a6e22e">txParams</span>.<span style="color:#a6e22e">TxID</span>))
}
</code></pre></div><h2 id="验证系统链码-validator-system-chaincode-vscc">验证系统链码 (<em>Validator System Chaincode</em>, VSCC)</h2>
<blockquote>
<p>/core/committer/txvalidator/v14/vscc_validator.go</p>
</blockquote>
<p>被记账节点(validator)调用，根据合约的背书政策验证交易的有效性和背书的正确性。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">txvalidator</span>

<span style="color:#f92672">import</span> (
	<span style="color:#e6db74">&#34;fmt&#34;</span>

	<span style="color:#e6db74">&#34;github.com/golang/protobuf/proto&#34;</span>
	<span style="color:#e6db74">&#34;github.com/hyperledger/fabric-protos-go/common&#34;</span>
	<span style="color:#e6db74">&#34;github.com/hyperledger/fabric-protos-go/peer&#34;</span>
	<span style="color:#a6e22e">commonerrors</span> <span style="color:#e6db74">&#34;github.com/hyperledger/fabric/common/errors&#34;</span>
	<span style="color:#e6db74">&#34;github.com/hyperledger/fabric/common/policydsl&#34;</span>
	<span style="color:#e6db74">&#34;github.com/hyperledger/fabric/core/common/ccprovider&#34;</span>
	<span style="color:#e6db74">&#34;github.com/hyperledger/fabric/core/common/sysccprovider&#34;</span>
	<span style="color:#a6e22e">validation</span> <span style="color:#e6db74">&#34;github.com/hyperledger/fabric/core/handlers/validation/api&#34;</span>
	<span style="color:#e6db74">&#34;github.com/hyperledger/fabric/core/ledger/kvledger/txmgmt/rwsetutil&#34;</span>
	<span style="color:#e6db74">&#34;github.com/hyperledger/fabric/protoutil&#34;</span>
	<span style="color:#e6db74">&#34;github.com/pkg/errors&#34;</span>
)

<span style="color:#75715e">// VsccValidatorImpl is the implementation used to call
</span><span style="color:#75715e">// the vscc chaincode and validate block transactions
</span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">VsccValidatorImpl</span> <span style="color:#66d9ef">struct</span> {
	<span style="color:#a6e22e">channelID</span>       <span style="color:#66d9ef">string</span>
	<span style="color:#a6e22e">cr</span>              <span style="color:#a6e22e">ChannelResources</span>
	<span style="color:#a6e22e">pluginValidator</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">PluginValidator</span>
} <span style="color:#75715e">// 用于调用vscc链码并验证区块事务
</span><span style="color:#75715e"></span>
<span style="color:#75715e">// newVSCCValidator creates new vscc validator
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">newVSCCValidator</span>(<span style="color:#a6e22e">channelID</span> <span style="color:#66d9ef">string</span>, <span style="color:#a6e22e">cr</span> <span style="color:#a6e22e">ChannelResources</span>, <span style="color:#a6e22e">pluginValidator</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">PluginValidator</span>) <span style="color:#f92672">*</span><span style="color:#a6e22e">VsccValidatorImpl</span> {
	<span style="color:#66d9ef">return</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">VsccValidatorImpl</span>{
		<span style="color:#a6e22e">channelID</span>:       <span style="color:#a6e22e">channelID</span>,
		<span style="color:#a6e22e">cr</span>:              <span style="color:#a6e22e">cr</span>,
		<span style="color:#a6e22e">pluginValidator</span>: <span style="color:#a6e22e">pluginValidator</span>,
	}
}

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">getChaincodeHeaderExtension</span>(<span style="color:#a6e22e">hdr</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">common</span>.<span style="color:#a6e22e">Header</span>) (<span style="color:#f92672">*</span><span style="color:#a6e22e">peer</span>.<span style="color:#a6e22e">ChaincodeHeaderExtension</span>, <span style="color:#66d9ef">error</span>) {
	<span style="color:#a6e22e">chdr</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">protoutil</span>.<span style="color:#a6e22e">UnmarshalChannelHeader</span>(<span style="color:#a6e22e">hdr</span>.<span style="color:#a6e22e">ChannelHeader</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">err</span>
	}

	<span style="color:#a6e22e">chaincodeHdrExt</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">peer</span>.<span style="color:#a6e22e">ChaincodeHeaderExtension</span>{}
	<span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">proto</span>.<span style="color:#a6e22e">Unmarshal</span>(<span style="color:#a6e22e">chdr</span>.<span style="color:#a6e22e">Extension</span>, <span style="color:#a6e22e">chaincodeHdrExt</span>)
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">chaincodeHdrExt</span>, <span style="color:#a6e22e">errors</span>.<span style="color:#a6e22e">Wrap</span>(<span style="color:#a6e22e">err</span>, <span style="color:#e6db74">&#34;error unmarshaling ChaincodeHeaderExtension&#34;</span>)
}

<span style="color:#75715e">// VSCCValidateTx executes vscc validation for transaction
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">v</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">VsccValidatorImpl</span>) <span style="color:#a6e22e">VSCCValidateTx</span>(<span style="color:#a6e22e">seq</span> <span style="color:#66d9ef">int</span>, <span style="color:#a6e22e">payload</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">common</span>.<span style="color:#a6e22e">Payload</span>, <span style="color:#a6e22e">envBytes</span> []<span style="color:#66d9ef">byte</span>, <span style="color:#a6e22e">block</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">common</span>.<span style="color:#a6e22e">Block</span>) (<span style="color:#66d9ef">error</span>, <span style="color:#a6e22e">peer</span>.<span style="color:#a6e22e">TxValidationCode</span>) {
	<span style="color:#a6e22e">chainID</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">v</span>.<span style="color:#a6e22e">channelID</span>
	<span style="color:#a6e22e">logger</span>.<span style="color:#a6e22e">Debugf</span>(<span style="color:#e6db74">&#34;[%s] VSCCValidateTx starts for bytes %p&#34;</span>, <span style="color:#a6e22e">chainID</span>, <span style="color:#a6e22e">envBytes</span>)

	<span style="color:#75715e">// get header extensions so we have the chaincode ID
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">hdrExt</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">getChaincodeHeaderExtension</span>(<span style="color:#a6e22e">payload</span>.<span style="color:#a6e22e">Header</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>, <span style="color:#a6e22e">peer</span>.<span style="color:#a6e22e">TxValidationCode_BAD_HEADER_EXTENSION</span>
	}

	<span style="color:#75715e">// get channel header
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">chdr</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">protoutil</span>.<span style="color:#a6e22e">UnmarshalChannelHeader</span>(<span style="color:#a6e22e">payload</span>.<span style="color:#a6e22e">Header</span>.<span style="color:#a6e22e">ChannelHeader</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>, <span style="color:#a6e22e">peer</span>.<span style="color:#a6e22e">TxValidationCode_BAD_CHANNEL_HEADER</span>
	}

	<span style="color:#75715e">/* obtain the list of namespaces we&#39;re writing stuff to;
</span><span style="color:#75715e">	   at first, we establish a few facts about this invocation:
</span><span style="color:#75715e">	   1) which namespaces does it write to?
</span><span style="color:#75715e">	   2) does it write to LSCC&#39;s namespace?
</span><span style="color:#75715e">	   3) does it write to any cc that cannot be invoked? */</span>
	<span style="color:#a6e22e">writesToLSCC</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">false</span>
	<span style="color:#a6e22e">writesToNonInvokableSCC</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">false</span>
	<span style="color:#a6e22e">respPayload</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">protoutil</span>.<span style="color:#a6e22e">GetActionFromEnvelope</span>(<span style="color:#a6e22e">envBytes</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">errors</span>.<span style="color:#a6e22e">WithMessage</span>(<span style="color:#a6e22e">err</span>, <span style="color:#e6db74">&#34;GetActionFromEnvelope failed&#34;</span>), <span style="color:#a6e22e">peer</span>.<span style="color:#a6e22e">TxValidationCode_BAD_RESPONSE_PAYLOAD</span>
	}
	<span style="color:#a6e22e">txRWSet</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">rwsetutil</span>.<span style="color:#a6e22e">TxRwSet</span>{}
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">txRWSet</span>.<span style="color:#a6e22e">FromProtoBytes</span>(<span style="color:#a6e22e">respPayload</span>.<span style="color:#a6e22e">Results</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">errors</span>.<span style="color:#a6e22e">WithMessage</span>(<span style="color:#a6e22e">err</span>, <span style="color:#e6db74">&#34;txRWSet.FromProtoBytes failed&#34;</span>), <span style="color:#a6e22e">peer</span>.<span style="color:#a6e22e">TxValidationCode_BAD_RWSET</span>
	}

	<span style="color:#75715e">// Verify the header extension and response payload contain the ChaincodeId
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">hdrExt</span>.<span style="color:#a6e22e">ChaincodeId</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">errors</span>.<span style="color:#a6e22e">New</span>(<span style="color:#e6db74">&#34;nil ChaincodeId in header extension&#34;</span>), <span style="color:#a6e22e">peer</span>.<span style="color:#a6e22e">TxValidationCode_INVALID_OTHER_REASON</span>
	}

	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">respPayload</span>.<span style="color:#a6e22e">ChaincodeId</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">errors</span>.<span style="color:#a6e22e">New</span>(<span style="color:#e6db74">&#34;nil ChaincodeId in ChaincodeAction&#34;</span>), <span style="color:#a6e22e">peer</span>.<span style="color:#a6e22e">TxValidationCode_INVALID_OTHER_REASON</span>
	}

	<span style="color:#75715e">// get name and version of the cc we invoked
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">ccID</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">hdrExt</span>.<span style="color:#a6e22e">ChaincodeId</span>.<span style="color:#a6e22e">Name</span>
	<span style="color:#a6e22e">ccVer</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">respPayload</span>.<span style="color:#a6e22e">ChaincodeId</span>.<span style="color:#a6e22e">Version</span>

	<span style="color:#75715e">// sanity check on ccID
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">ccID</span> <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;&#34;</span> {
		<span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">errors</span>.<span style="color:#a6e22e">New</span>(<span style="color:#e6db74">&#34;invalid chaincode ID&#34;</span>)
		<span style="color:#a6e22e">logger</span>.<span style="color:#a6e22e">Errorf</span>(<span style="color:#e6db74">&#34;%+v&#34;</span>, <span style="color:#a6e22e">err</span>)
		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>, <span style="color:#a6e22e">peer</span>.<span style="color:#a6e22e">TxValidationCode_INVALID_OTHER_REASON</span>
	}
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">ccID</span> <span style="color:#f92672">!=</span> <span style="color:#a6e22e">respPayload</span>.<span style="color:#a6e22e">ChaincodeId</span>.<span style="color:#a6e22e">Name</span> {
		<span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">errors</span>.<span style="color:#a6e22e">Errorf</span>(<span style="color:#e6db74">&#34;inconsistent ccid info (%s/%s)&#34;</span>, <span style="color:#a6e22e">ccID</span>, <span style="color:#a6e22e">respPayload</span>.<span style="color:#a6e22e">ChaincodeId</span>.<span style="color:#a6e22e">Name</span>)
		<span style="color:#a6e22e">logger</span>.<span style="color:#a6e22e">Errorf</span>(<span style="color:#e6db74">&#34;%+v&#34;</span>, <span style="color:#a6e22e">err</span>)
		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>, <span style="color:#a6e22e">peer</span>.<span style="color:#a6e22e">TxValidationCode_INVALID_OTHER_REASON</span>
	}
	<span style="color:#75715e">// sanity check on ccver
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">ccVer</span> <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;&#34;</span> {
		<span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">errors</span>.<span style="color:#a6e22e">New</span>(<span style="color:#e6db74">&#34;invalid chaincode version&#34;</span>)
		<span style="color:#a6e22e">logger</span>.<span style="color:#a6e22e">Errorf</span>(<span style="color:#e6db74">&#34;%+v&#34;</span>, <span style="color:#a6e22e">err</span>)
		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>, <span style="color:#a6e22e">peer</span>.<span style="color:#a6e22e">TxValidationCode_INVALID_OTHER_REASON</span>
	}

	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">wrNamespace</span> []<span style="color:#66d9ef">string</span>
	<span style="color:#a6e22e">alwaysEnforceOriginalNamespace</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">v</span>.<span style="color:#a6e22e">cr</span>.<span style="color:#a6e22e">Capabilities</span>().<span style="color:#a6e22e">V1_2Validation</span>()
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">alwaysEnforceOriginalNamespace</span> {
		<span style="color:#a6e22e">wrNamespace</span> = append(<span style="color:#a6e22e">wrNamespace</span>, <span style="color:#a6e22e">ccID</span>)
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">respPayload</span>.<span style="color:#a6e22e">Events</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
			<span style="color:#a6e22e">ccEvent</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">peer</span>.<span style="color:#a6e22e">ChaincodeEvent</span>{}
			<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">proto</span>.<span style="color:#a6e22e">Unmarshal</span>(<span style="color:#a6e22e">respPayload</span>.<span style="color:#a6e22e">Events</span>, <span style="color:#a6e22e">ccEvent</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
				<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">errors</span>.<span style="color:#a6e22e">Wrapf</span>(<span style="color:#a6e22e">err</span>, <span style="color:#e6db74">&#34;invalid chaincode event&#34;</span>), <span style="color:#a6e22e">peer</span>.<span style="color:#a6e22e">TxValidationCode_INVALID_OTHER_REASON</span>
			}
			<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">ccEvent</span>.<span style="color:#a6e22e">ChaincodeId</span> <span style="color:#f92672">!=</span> <span style="color:#a6e22e">ccID</span> {
				<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">errors</span>.<span style="color:#a6e22e">Errorf</span>(<span style="color:#e6db74">&#34;chaincode event chaincode id does not match chaincode action chaincode id&#34;</span>), <span style="color:#a6e22e">peer</span>.<span style="color:#a6e22e">TxValidationCode_INVALID_OTHER_REASON</span>
			}
		}
	}

	<span style="color:#a6e22e">namespaces</span> <span style="color:#f92672">:=</span> make(<span style="color:#66d9ef">map</span>[<span style="color:#66d9ef">string</span>]<span style="color:#66d9ef">struct</span>{})
	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">ns</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">txRWSet</span>.<span style="color:#a6e22e">NsRwSets</span> {
		<span style="color:#75715e">// check to make sure there is no duplicate namespace in txRWSet
</span><span style="color:#75715e"></span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">ok</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">namespaces</span>[<span style="color:#a6e22e">ns</span>.<span style="color:#a6e22e">NameSpace</span>]; <span style="color:#a6e22e">ok</span> {
			<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">errors</span>.<span style="color:#a6e22e">Errorf</span>(<span style="color:#e6db74">&#34;duplicate namespace &#39;%s&#39; in txRWSet&#34;</span>, <span style="color:#a6e22e">ns</span>.<span style="color:#a6e22e">NameSpace</span>),
				<span style="color:#a6e22e">peer</span>.<span style="color:#a6e22e">TxValidationCode_ILLEGAL_WRITESET</span>
		}
		<span style="color:#a6e22e">namespaces</span>[<span style="color:#a6e22e">ns</span>.<span style="color:#a6e22e">NameSpace</span>] = <span style="color:#66d9ef">struct</span>{}{}

		<span style="color:#66d9ef">if</span> !<span style="color:#a6e22e">v</span>.<span style="color:#a6e22e">txWritesToNamespace</span>(<span style="color:#a6e22e">ns</span>) {
			<span style="color:#66d9ef">continue</span>
		}

		<span style="color:#75715e">// Check to make sure we did not already populate this chaincode
</span><span style="color:#75715e"></span>		<span style="color:#75715e">// name to avoid checking the same namespace twice
</span><span style="color:#75715e"></span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">ns</span>.<span style="color:#a6e22e">NameSpace</span> <span style="color:#f92672">!=</span> <span style="color:#a6e22e">ccID</span> <span style="color:#f92672">||</span> !<span style="color:#a6e22e">alwaysEnforceOriginalNamespace</span> {
			<span style="color:#a6e22e">wrNamespace</span> = append(<span style="color:#a6e22e">wrNamespace</span>, <span style="color:#a6e22e">ns</span>.<span style="color:#a6e22e">NameSpace</span>)
		}

		<span style="color:#66d9ef">if</span> !<span style="color:#a6e22e">writesToLSCC</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">ns</span>.<span style="color:#a6e22e">NameSpace</span> <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;lscc&#34;</span> {
			<span style="color:#a6e22e">writesToLSCC</span> = <span style="color:#66d9ef">true</span>
		}

		<span style="color:#66d9ef">if</span> !<span style="color:#a6e22e">writesToNonInvokableSCC</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">IsSysCCAndNotInvokableCC2CC</span>(<span style="color:#a6e22e">ns</span>.<span style="color:#a6e22e">NameSpace</span>) {
			<span style="color:#a6e22e">writesToNonInvokableSCC</span> = <span style="color:#66d9ef">true</span>
		}

		<span style="color:#66d9ef">if</span> !<span style="color:#a6e22e">writesToNonInvokableSCC</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">IsSysCCAndNotInvokableExternal</span>(<span style="color:#a6e22e">ns</span>.<span style="color:#a6e22e">NameSpace</span>) {
			<span style="color:#a6e22e">writesToNonInvokableSCC</span> = <span style="color:#66d9ef">true</span>
		}
	}

	<span style="color:#75715e">// we&#39;ve gathered all the info required to proceed to validation;
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// validation will behave differently depending on the type of
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// chaincode (system vs. application)
</span><span style="color:#75715e"></span>
	<span style="color:#66d9ef">if</span> !<span style="color:#a6e22e">IsSysCC</span>(<span style="color:#a6e22e">ccID</span>) {
		<span style="color:#75715e">// if we&#39;re here, we know this is an invocation of an application chaincode;
</span><span style="color:#75715e"></span>		<span style="color:#75715e">// first of all, we make sure that:
</span><span style="color:#75715e"></span>		<span style="color:#75715e">// 1) we don&#39;t write to LSCC - an application chaincode is free to invoke LSCC
</span><span style="color:#75715e"></span>		<span style="color:#75715e">//    for instance to get information about itself or another chaincode; however
</span><span style="color:#75715e"></span>		<span style="color:#75715e">//    these legitimate invocations only ready from LSCC&#39;s namespace; currently
</span><span style="color:#75715e"></span>		<span style="color:#75715e">//    only two functions of LSCC write to its namespace: deploy and upgrade and
</span><span style="color:#75715e"></span>		<span style="color:#75715e">//    neither should be used by an application chaincode
</span><span style="color:#75715e"></span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">writesToLSCC</span> {
			<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">errors</span>.<span style="color:#a6e22e">Errorf</span>(<span style="color:#e6db74">&#34;chaincode %s attempted to write to the namespace of LSCC&#34;</span>, <span style="color:#a6e22e">ccID</span>),
				<span style="color:#a6e22e">peer</span>.<span style="color:#a6e22e">TxValidationCode_ILLEGAL_WRITESET</span>
		}
		<span style="color:#75715e">// 2) we don&#39;t write to the namespace of a chaincode that we cannot invoke - if
</span><span style="color:#75715e"></span>		<span style="color:#75715e">//    the chaincode cannot be invoked in the first place, there&#39;s no legitimate
</span><span style="color:#75715e"></span>		<span style="color:#75715e">//    way in which a transaction has a write set that writes to it; additionally
</span><span style="color:#75715e"></span>		<span style="color:#75715e">//    we don&#39;t have any means of verifying whether the transaction had the rights
</span><span style="color:#75715e"></span>		<span style="color:#75715e">//    to perform that write operation because in v1, system chaincodes do not have
</span><span style="color:#75715e"></span>		<span style="color:#75715e">//    any endorsement policies to speak of. So if the chaincode can&#39;t be invoked
</span><span style="color:#75715e"></span>		<span style="color:#75715e">//    it can&#39;t be written to by an invocation of an application chaincode
</span><span style="color:#75715e"></span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">writesToNonInvokableSCC</span> {
			<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">errors</span>.<span style="color:#a6e22e">Errorf</span>(<span style="color:#e6db74">&#34;chaincode %s attempted to write to the namespace of a system chaincode that cannot be invoked&#34;</span>, <span style="color:#a6e22e">ccID</span>),
				<span style="color:#a6e22e">peer</span>.<span style="color:#a6e22e">TxValidationCode_ILLEGAL_WRITESET</span>
		}

		<span style="color:#75715e">// validate *EACH* read write set according to its chaincode&#39;s endorsement policy
</span><span style="color:#75715e"></span>		<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">ns</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">wrNamespace</span> {
			<span style="color:#75715e">// Get latest chaincode version, vscc and validate policy
</span><span style="color:#75715e"></span>			<span style="color:#a6e22e">txcc</span>, <span style="color:#a6e22e">vscc</span>, <span style="color:#a6e22e">policy</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">v</span>.<span style="color:#a6e22e">GetInfoForValidate</span>(<span style="color:#a6e22e">chdr</span>, <span style="color:#a6e22e">ns</span>)
			<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
				<span style="color:#a6e22e">logger</span>.<span style="color:#a6e22e">Errorf</span>(<span style="color:#e6db74">&#34;GetInfoForValidate for txId = %s returned error: %+v&#34;</span>, <span style="color:#a6e22e">chdr</span>.<span style="color:#a6e22e">TxId</span>, <span style="color:#a6e22e">err</span>)
				<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>, <span style="color:#a6e22e">peer</span>.<span style="color:#a6e22e">TxValidationCode_INVALID_OTHER_REASON</span>
			}

			<span style="color:#75715e">// if the namespace corresponds to the cc that was originally
</span><span style="color:#75715e"></span>			<span style="color:#75715e">// invoked, we check that the version of the cc that was
</span><span style="color:#75715e"></span>			<span style="color:#75715e">// invoked corresponds to the version that lscc has returned
</span><span style="color:#75715e"></span>			<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">ns</span> <span style="color:#f92672">==</span> <span style="color:#a6e22e">ccID</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">txcc</span>.<span style="color:#a6e22e">ChaincodeVersion</span> <span style="color:#f92672">!=</span> <span style="color:#a6e22e">ccVer</span> {
				<span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">errors</span>.<span style="color:#a6e22e">Errorf</span>(<span style="color:#e6db74">&#34;chaincode %s:%s/%s didn&#39;t match %s:%s/%s in lscc&#34;</span>, <span style="color:#a6e22e">ccID</span>, <span style="color:#a6e22e">ccVer</span>, <span style="color:#a6e22e">chdr</span>.<span style="color:#a6e22e">ChannelId</span>, <span style="color:#a6e22e">txcc</span>.<span style="color:#a6e22e">ChaincodeName</span>, <span style="color:#a6e22e">txcc</span>.<span style="color:#a6e22e">ChaincodeVersion</span>, <span style="color:#a6e22e">chdr</span>.<span style="color:#a6e22e">ChannelId</span>)
				<span style="color:#a6e22e">logger</span>.<span style="color:#a6e22e">Errorf</span>(<span style="color:#e6db74">&#34;%+v&#34;</span>, <span style="color:#a6e22e">err</span>)
				<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>, <span style="color:#a6e22e">peer</span>.<span style="color:#a6e22e">TxValidationCode_EXPIRED_CHAINCODE</span>
			}

			<span style="color:#75715e">// do VSCC validation
</span><span style="color:#75715e"></span>			<span style="color:#a6e22e">ctx</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">Context</span>{
				<span style="color:#a6e22e">Seq</span>:       <span style="color:#a6e22e">seq</span>,
				<span style="color:#a6e22e">Envelope</span>:  <span style="color:#a6e22e">envBytes</span>,
				<span style="color:#a6e22e">Block</span>:     <span style="color:#a6e22e">block</span>,
				<span style="color:#a6e22e">TxID</span>:      <span style="color:#a6e22e">chdr</span>.<span style="color:#a6e22e">TxId</span>,
				<span style="color:#a6e22e">Channel</span>:   <span style="color:#a6e22e">chdr</span>.<span style="color:#a6e22e">ChannelId</span>,
				<span style="color:#a6e22e">Namespace</span>: <span style="color:#a6e22e">ns</span>,
				<span style="color:#a6e22e">Policy</span>:    <span style="color:#a6e22e">policy</span>,
				<span style="color:#a6e22e">VSCCName</span>:  <span style="color:#a6e22e">vscc</span>.<span style="color:#a6e22e">ChaincodeName</span>,
			}
			<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">v</span>.<span style="color:#a6e22e">VSCCValidateTxForCC</span>(<span style="color:#a6e22e">ctx</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
				<span style="color:#66d9ef">switch</span> <span style="color:#a6e22e">err</span>.(<span style="color:#66d9ef">type</span>) {
				<span style="color:#66d9ef">case</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">commonerrors</span>.<span style="color:#a6e22e">VSCCEndorsementPolicyError</span>:
					<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>, <span style="color:#a6e22e">peer</span>.<span style="color:#a6e22e">TxValidationCode_ENDORSEMENT_POLICY_FAILURE</span>
				<span style="color:#66d9ef">default</span>:
					<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>, <span style="color:#a6e22e">peer</span>.<span style="color:#a6e22e">TxValidationCode_INVALID_OTHER_REASON</span>
				}
			}
		}
	} <span style="color:#66d9ef">else</span> {
		<span style="color:#75715e">// make sure that we can invoke this system chaincode - if the chaincode
</span><span style="color:#75715e"></span>		<span style="color:#75715e">// cannot be invoked through a proposal to this peer, we have to drop the
</span><span style="color:#75715e"></span>		<span style="color:#75715e">// transaction; if we didn&#39;t, we wouldn&#39;t know how to decide whether it&#39;s
</span><span style="color:#75715e"></span>		<span style="color:#75715e">// valid or not because in v1, system chaincodes have no endorsement policy
</span><span style="color:#75715e"></span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">IsSysCCAndNotInvokableExternal</span>(<span style="color:#a6e22e">ccID</span>) {
			<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">errors</span>.<span style="color:#a6e22e">Errorf</span>(<span style="color:#e6db74">&#34;committing an invocation of cc %s is illegal&#34;</span>, <span style="color:#a6e22e">ccID</span>),
				<span style="color:#a6e22e">peer</span>.<span style="color:#a6e22e">TxValidationCode_ILLEGAL_WRITESET</span>
		}

		<span style="color:#75715e">// Get latest chaincode version, vscc and validate policy
</span><span style="color:#75715e"></span>		<span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">vscc</span>, <span style="color:#a6e22e">policy</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">v</span>.<span style="color:#a6e22e">GetInfoForValidate</span>(<span style="color:#a6e22e">chdr</span>, <span style="color:#a6e22e">ccID</span>)
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
			<span style="color:#a6e22e">logger</span>.<span style="color:#a6e22e">Errorf</span>(<span style="color:#e6db74">&#34;GetInfoForValidate for txId = %s returned error: %+v&#34;</span>, <span style="color:#a6e22e">chdr</span>.<span style="color:#a6e22e">TxId</span>, <span style="color:#a6e22e">err</span>)
			<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>, <span style="color:#a6e22e">peer</span>.<span style="color:#a6e22e">TxValidationCode_INVALID_OTHER_REASON</span>
		}

		<span style="color:#75715e">// validate the transaction as an invocation of this system chaincode;
</span><span style="color:#75715e"></span>		<span style="color:#75715e">// vscc will have to do custom validation for this system chaincode
</span><span style="color:#75715e"></span>		<span style="color:#75715e">// currently, VSCC does custom validation for LSCC only; if an hlf
</span><span style="color:#75715e"></span>		<span style="color:#75715e">// user creates a new system chaincode which is invokable from the outside
</span><span style="color:#75715e"></span>		<span style="color:#75715e">// they have to modify VSCC to provide appropriate validation
</span><span style="color:#75715e"></span>		<span style="color:#a6e22e">ctx</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">Context</span>{
			<span style="color:#a6e22e">Seq</span>:       <span style="color:#a6e22e">seq</span>,
			<span style="color:#a6e22e">Envelope</span>:  <span style="color:#a6e22e">envBytes</span>,
			<span style="color:#a6e22e">Block</span>:     <span style="color:#a6e22e">block</span>,
			<span style="color:#a6e22e">TxID</span>:      <span style="color:#a6e22e">chdr</span>.<span style="color:#a6e22e">TxId</span>,
			<span style="color:#a6e22e">Channel</span>:   <span style="color:#a6e22e">chdr</span>.<span style="color:#a6e22e">ChannelId</span>,
			<span style="color:#a6e22e">Namespace</span>: <span style="color:#a6e22e">ccID</span>,
			<span style="color:#a6e22e">Policy</span>:    <span style="color:#a6e22e">policy</span>,
			<span style="color:#a6e22e">VSCCName</span>:  <span style="color:#a6e22e">vscc</span>.<span style="color:#a6e22e">ChaincodeName</span>,
		}
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">v</span>.<span style="color:#a6e22e">VSCCValidateTxForCC</span>(<span style="color:#a6e22e">ctx</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
			<span style="color:#66d9ef">switch</span> <span style="color:#a6e22e">err</span>.(<span style="color:#66d9ef">type</span>) {
			<span style="color:#66d9ef">case</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">commonerrors</span>.<span style="color:#a6e22e">VSCCEndorsementPolicyError</span>:
				<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>, <span style="color:#a6e22e">peer</span>.<span style="color:#a6e22e">TxValidationCode_ENDORSEMENT_POLICY_FAILURE</span>
			<span style="color:#66d9ef">default</span>:
				<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>, <span style="color:#a6e22e">peer</span>.<span style="color:#a6e22e">TxValidationCode_INVALID_OTHER_REASON</span>
			}
		}
	}
	<span style="color:#a6e22e">logger</span>.<span style="color:#a6e22e">Debugf</span>(<span style="color:#e6db74">&#34;[%s] VSCCValidateTx completes env bytes %p&#34;</span>, <span style="color:#a6e22e">chainID</span>, <span style="color:#a6e22e">envBytes</span>)
	<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">peer</span>.<span style="color:#a6e22e">TxValidationCode_VALID</span>
}

<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">v</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">VsccValidatorImpl</span>) <span style="color:#a6e22e">VSCCValidateTxForCC</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Context</span>) <span style="color:#66d9ef">error</span> {
	<span style="color:#a6e22e">logger</span>.<span style="color:#a6e22e">Debug</span>(<span style="color:#e6db74">&#34;Validating&#34;</span>, <span style="color:#a6e22e">ctx</span>, <span style="color:#e6db74">&#34;with plugin&#34;</span>)
	<span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">v</span>.<span style="color:#a6e22e">pluginValidator</span>.<span style="color:#a6e22e">ValidateWithPlugin</span>(<span style="color:#a6e22e">ctx</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>
	}
	<span style="color:#75715e">// If the error is a pluggable validation execution error, cast it to the common errors ExecutionFailureError.
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">e</span>, <span style="color:#a6e22e">isExecutionError</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">err</span>.(<span style="color:#f92672">*</span><span style="color:#a6e22e">validation</span>.<span style="color:#a6e22e">ExecutionFailureError</span>); <span style="color:#a6e22e">isExecutionError</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">commonerrors</span>.<span style="color:#a6e22e">VSCCExecutionFailureError</span>{<span style="color:#a6e22e">Err</span>: <span style="color:#a6e22e">e</span>}
	}
	<span style="color:#75715e">// Else, treat it as an endorsement error.
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">return</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">commonerrors</span>.<span style="color:#a6e22e">VSCCEndorsementPolicyError</span>{<span style="color:#a6e22e">Err</span>: <span style="color:#a6e22e">err</span>}
}

<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">v</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">VsccValidatorImpl</span>) <span style="color:#a6e22e">getCDataForCC</span>(<span style="color:#a6e22e">chid</span>, <span style="color:#a6e22e">ccid</span> <span style="color:#66d9ef">string</span>) (<span style="color:#f92672">*</span><span style="color:#a6e22e">ccprovider</span>.<span style="color:#a6e22e">ChaincodeData</span>, <span style="color:#66d9ef">error</span>) {
	<span style="color:#a6e22e">l</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">v</span>.<span style="color:#a6e22e">cr</span>.<span style="color:#a6e22e">Ledger</span>()
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">l</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">errors</span>.<span style="color:#a6e22e">New</span>(<span style="color:#e6db74">&#34;nil ledger instance&#34;</span>)
	}

	<span style="color:#a6e22e">qe</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">l</span>.<span style="color:#a6e22e">NewQueryExecutor</span>()
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">errors</span>.<span style="color:#a6e22e">WithMessage</span>(<span style="color:#a6e22e">err</span>, <span style="color:#e6db74">&#34;could not retrieve QueryExecutor&#34;</span>)
	}
	<span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">qe</span>.<span style="color:#a6e22e">Done</span>()

	<span style="color:#a6e22e">bytes</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">qe</span>.<span style="color:#a6e22e">GetState</span>(<span style="color:#e6db74">&#34;lscc&#34;</span>, <span style="color:#a6e22e">ccid</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">commonerrors</span>.<span style="color:#a6e22e">VSCCInfoLookupFailureError</span>{
			<span style="color:#a6e22e">Reason</span>: <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Sprintf</span>(<span style="color:#e6db74">&#34;Could not retrieve state for chaincode %s, error %s&#34;</span>, <span style="color:#a6e22e">ccid</span>, <span style="color:#a6e22e">err</span>),
		}
	}

	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">bytes</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">errors</span>.<span style="color:#a6e22e">Errorf</span>(<span style="color:#e6db74">&#34;lscc&#39;s state for [%s] not found.&#34;</span>, <span style="color:#a6e22e">ccid</span>)
	}

	<span style="color:#a6e22e">cd</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">ccprovider</span>.<span style="color:#a6e22e">ChaincodeData</span>{}
	<span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">proto</span>.<span style="color:#a6e22e">Unmarshal</span>(<span style="color:#a6e22e">bytes</span>, <span style="color:#a6e22e">cd</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">errors</span>.<span style="color:#a6e22e">Wrap</span>(<span style="color:#a6e22e">err</span>, <span style="color:#e6db74">&#34;unmarshalling ChaincodeQueryResponse failed&#34;</span>)
	}

	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">cd</span>.<span style="color:#a6e22e">Vscc</span> <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;&#34;</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">errors</span>.<span style="color:#a6e22e">Errorf</span>(<span style="color:#e6db74">&#34;lscc&#39;s state for [%s] is invalid, vscc field must be set&#34;</span>, <span style="color:#a6e22e">ccid</span>)
	}

	<span style="color:#66d9ef">if</span> len(<span style="color:#a6e22e">cd</span>.<span style="color:#a6e22e">Policy</span>) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">errors</span>.<span style="color:#a6e22e">Errorf</span>(<span style="color:#e6db74">&#34;lscc&#39;s state for [%s] is invalid, policy field must be set&#34;</span>, <span style="color:#a6e22e">ccid</span>)
	}

	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">cd</span>, <span style="color:#a6e22e">err</span>
}

<span style="color:#75715e">// GetInfoForValidate gets the ChaincodeInstance(with latest version) of tx, vscc and policy from lscc
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">v</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">VsccValidatorImpl</span>) <span style="color:#a6e22e">GetInfoForValidate</span>(<span style="color:#a6e22e">chdr</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">common</span>.<span style="color:#a6e22e">ChannelHeader</span>, <span style="color:#a6e22e">ccID</span> <span style="color:#66d9ef">string</span>) (<span style="color:#f92672">*</span><span style="color:#a6e22e">sysccprovider</span>.<span style="color:#a6e22e">ChaincodeInstance</span>, <span style="color:#f92672">*</span><span style="color:#a6e22e">sysccprovider</span>.<span style="color:#a6e22e">ChaincodeInstance</span>, []<span style="color:#66d9ef">byte</span>, <span style="color:#66d9ef">error</span>) {
	<span style="color:#a6e22e">cc</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">sysccprovider</span>.<span style="color:#a6e22e">ChaincodeInstance</span>{
		<span style="color:#a6e22e">ChannelID</span>:     <span style="color:#a6e22e">chdr</span>.<span style="color:#a6e22e">ChannelId</span>,
		<span style="color:#a6e22e">ChaincodeName</span>: <span style="color:#a6e22e">ccID</span>,
	}
	<span style="color:#a6e22e">vscc</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">sysccprovider</span>.<span style="color:#a6e22e">ChaincodeInstance</span>{
		<span style="color:#a6e22e">ChannelID</span>:     <span style="color:#a6e22e">chdr</span>.<span style="color:#a6e22e">ChannelId</span>,
		<span style="color:#a6e22e">ChaincodeName</span>: <span style="color:#e6db74">&#34;vscc&#34;</span>, <span style="color:#75715e">// default vscc for system chaincodes
</span><span style="color:#75715e"></span>	}
	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">policy</span> []<span style="color:#66d9ef">byte</span>
	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">err</span> <span style="color:#66d9ef">error</span>
	<span style="color:#66d9ef">if</span> !<span style="color:#a6e22e">IsSysCC</span>(<span style="color:#a6e22e">ccID</span>) {
		<span style="color:#75715e">// when we are validating a chaincode that is not a
</span><span style="color:#75715e"></span>		<span style="color:#75715e">// system CC, we need to ask the CC to give us the name
</span><span style="color:#75715e"></span>		<span style="color:#75715e">// of VSCC and of the policy that should be used
</span><span style="color:#75715e"></span>
		<span style="color:#75715e">// obtain name of the VSCC and the policy
</span><span style="color:#75715e"></span>		<span style="color:#a6e22e">cd</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">v</span>.<span style="color:#a6e22e">getCDataForCC</span>(<span style="color:#a6e22e">chdr</span>.<span style="color:#a6e22e">ChannelId</span>, <span style="color:#a6e22e">ccID</span>)
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
			<span style="color:#a6e22e">msg</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Sprintf</span>(<span style="color:#e6db74">&#34;Unable to get chaincode data from ledger for txid %s, due to %s&#34;</span>, <span style="color:#a6e22e">chdr</span>.<span style="color:#a6e22e">TxId</span>, <span style="color:#a6e22e">err</span>)
			<span style="color:#a6e22e">logger</span>.<span style="color:#a6e22e">Errorf</span>(<span style="color:#a6e22e">msg</span>)
			<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#66d9ef">nil</span>, <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">err</span>
		}
		<span style="color:#a6e22e">cc</span>.<span style="color:#a6e22e">ChaincodeName</span> = <span style="color:#a6e22e">cd</span>.<span style="color:#a6e22e">Name</span>
		<span style="color:#a6e22e">cc</span>.<span style="color:#a6e22e">ChaincodeVersion</span> = <span style="color:#a6e22e">cd</span>.<span style="color:#a6e22e">Version</span>
		<span style="color:#a6e22e">vscc</span>.<span style="color:#a6e22e">ChaincodeName</span>, <span style="color:#a6e22e">policy</span> = <span style="color:#a6e22e">cd</span>.<span style="color:#a6e22e">Vscc</span>, <span style="color:#a6e22e">cd</span>.<span style="color:#a6e22e">Policy</span>
	} <span style="color:#66d9ef">else</span> {
		<span style="color:#75715e">// when we are validating a system CC, we use the default
</span><span style="color:#75715e"></span>		<span style="color:#75715e">// VSCC and a default policy that requires one signature
</span><span style="color:#75715e"></span>		<span style="color:#75715e">// from any of the members of the channel
</span><span style="color:#75715e"></span>		<span style="color:#a6e22e">p</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">policydsl</span>.<span style="color:#a6e22e">SignedByAnyMember</span>(<span style="color:#a6e22e">v</span>.<span style="color:#a6e22e">cr</span>.<span style="color:#a6e22e">GetMSPIDs</span>())
		<span style="color:#a6e22e">policy</span>, <span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">protoutil</span>.<span style="color:#a6e22e">Marshal</span>(<span style="color:#a6e22e">p</span>)
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
			<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#66d9ef">nil</span>, <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">err</span>
		}
	}

	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">cc</span>, <span style="color:#a6e22e">vscc</span>, <span style="color:#a6e22e">policy</span>, <span style="color:#66d9ef">nil</span>
}

<span style="color:#75715e">// txWritesToNamespace returns true if the supplied NsRwSet
</span><span style="color:#75715e">// performs a ledger write
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">v</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">VsccValidatorImpl</span>) <span style="color:#a6e22e">txWritesToNamespace</span>(<span style="color:#a6e22e">ns</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">rwsetutil</span>.<span style="color:#a6e22e">NsRwSet</span>) <span style="color:#66d9ef">bool</span> {
	<span style="color:#75715e">// check for public writes first
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">ns</span>.<span style="color:#a6e22e">KvRwSet</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> <span style="color:#f92672">&amp;&amp;</span> len(<span style="color:#a6e22e">ns</span>.<span style="color:#a6e22e">KvRwSet</span>.<span style="color:#a6e22e">Writes</span>) &gt; <span style="color:#ae81ff">0</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">true</span>
	}

	<span style="color:#75715e">// only look at collection data if we support that capability
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">v</span>.<span style="color:#a6e22e">cr</span>.<span style="color:#a6e22e">Capabilities</span>().<span style="color:#a6e22e">PrivateChannelData</span>() {
		<span style="color:#75715e">// check for private writes for all collections
</span><span style="color:#75715e"></span>		<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">c</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">ns</span>.<span style="color:#a6e22e">CollHashedRwSets</span> {
			<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">HashedRwSet</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> <span style="color:#f92672">&amp;&amp;</span> len(<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">HashedRwSet</span>.<span style="color:#a6e22e">HashedWrites</span>) &gt; <span style="color:#ae81ff">0</span> {
				<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">true</span>
			}

			<span style="color:#75715e">// only look at private metadata writes if we support that capability
</span><span style="color:#75715e"></span>			<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">v</span>.<span style="color:#a6e22e">cr</span>.<span style="color:#a6e22e">Capabilities</span>().<span style="color:#a6e22e">KeyLevelEndorsement</span>() {
				<span style="color:#75715e">// private metadata updates
</span><span style="color:#75715e"></span>				<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">HashedRwSet</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> <span style="color:#f92672">&amp;&amp;</span> len(<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">HashedRwSet</span>.<span style="color:#a6e22e">MetadataWrites</span>) &gt; <span style="color:#ae81ff">0</span> {
					<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">true</span>
				}
			}
		}
	}

	<span style="color:#75715e">// only look at metadata writes if we support that capability
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">v</span>.<span style="color:#a6e22e">cr</span>.<span style="color:#a6e22e">Capabilities</span>().<span style="color:#a6e22e">KeyLevelEndorsement</span>() {
		<span style="color:#75715e">// public metadata updates
</span><span style="color:#75715e"></span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">ns</span>.<span style="color:#a6e22e">KvRwSet</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> <span style="color:#f92672">&amp;&amp;</span> len(<span style="color:#a6e22e">ns</span>.<span style="color:#a6e22e">KvRwSet</span>.<span style="color:#a6e22e">MetadataWrites</span>) &gt; <span style="color:#ae81ff">0</span> {
			<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">true</span>
		}
	}

	<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span>
}

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">IsSysCCAndNotInvokableExternal</span>(<span style="color:#a6e22e">name</span> <span style="color:#66d9ef">string</span>) <span style="color:#66d9ef">bool</span> {
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">name</span> <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;vscc&#34;</span> <span style="color:#f92672">||</span> <span style="color:#a6e22e">name</span> <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;escc&#34;</span>
}

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">IsSysCC</span>(<span style="color:#a6e22e">name</span> <span style="color:#66d9ef">string</span>) <span style="color:#66d9ef">bool</span> {
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">name</span> <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;vscc&#34;</span> <span style="color:#f92672">||</span> <span style="color:#a6e22e">name</span> <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;escc&#34;</span> <span style="color:#f92672">||</span> <span style="color:#a6e22e">name</span> <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;lscc&#34;</span> <span style="color:#f92672">||</span> <span style="color:#a6e22e">name</span> <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;qscc&#34;</span> <span style="color:#f92672">||</span> <span style="color:#a6e22e">name</span> <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;cscc&#34;</span>
}

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">IsSysCCAndNotInvokableCC2CC</span>(<span style="color:#a6e22e">name</span> <span style="color:#66d9ef">string</span>) <span style="color:#66d9ef">bool</span> {
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">name</span> <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;vscc&#34;</span> <span style="color:#f92672">||</span> <span style="color:#a6e22e">name</span> <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;escc&#34;</span> <span style="color:#f92672">||</span> <span style="color:#a6e22e">name</span> <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;cscc&#34;</span>
}

</code></pre></div>
</section>


    <footer class="article-footer">
    
    <section class="article-tags">
        
            <a href="/tags/fabric/">fabric</a>
        
            <a href="/tags/go/">go</a>
        
    </section>


    </footer>


    
        <link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/katex@0.13.13/dist/katex.min.css"integrity="sha384-RZU/ijkSsFbcmivfdRBQDtwuwVqK7GMOw6IMvKyeWL2K5UAlyp6WonmB8m7Jd0Hn"crossorigin="anonymous"
            ><script 
                src="https://cdn.jsdelivr.net/npm/katex@0.13.13/dist/katex.min.js"integrity="sha384-pK1WpvzWVBQiP0/GjnvRxV4mOb0oxFuyRxJlk6vVw146n3egcN5C925NCP7a7BY8"crossorigin="anonymous"
                defer="true"
                >
            </script><script 
                src="https://cdn.jsdelivr.net/npm/katex@0.13.13/dist/contrib/auto-render.min.js"integrity="sha384-vZTG03m&#43;2yp6N6BNi5iM4rW4oIwk5DfcNdFfxkk9ZWpDriOkXX8voJBFrAO7MpVl"crossorigin="anonymous"
                defer="true"
                >
            </script><script>
    window.addEventListener("DOMContentLoaded", () => {
        renderMathInElement(document.querySelector(`.article-content`), {
            delimiters: [
                { left: "$$", right: "$$", display: true },
                { left: "$", right: "$", display: false },
                { left: "\\(", right: "\\)", display: false },
                { left: "\\[", right: "\\]", display: true }
            ]
        });})
</script>
    
</article>

    <aside class="related-contents--wrapper">
    
    
        <h2 class="section-title">Related contents</h2>
        <div class="related-contents">
            <div class="flex article-list--tile">
                
                    
<article class="">
    <a href="/post/grpc-basic/">
        
        

        <div class="article-details">
            <h2 class="article-title">gRPC basic</h2>
        </div>
    </a>
</article>
                
                    
<article class="">
    <a href="/post/fabric-architecture/">
        
        

        <div class="article-details">
            <h2 class="article-title">Fabric-Architecture</h2>
        </div>
    </a>
</article>
                
            </div>
        </div>
    
</aside>

     
    
        
    

    <footer class="site-footer">
    <section class="copyright">
        &copy; 
        
        2022 s0uthwood&#39;s Blog
    </section>
    
    <section class="powerby">
        Built with <a href="https://gohugo.io/" target="_blank" rel="noopener">Hugo</a> <br />
        Theme <b><a href="https://github.com/CaiJimmy/hugo-theme-stack" target="_blank" rel="noopener" data-version="3.5.0">Stack</a></b> designed by <a href="https://jimmycai.com" target="_blank" rel="noopener">Jimmy</a>
    </section>
</footer>


    
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    
    <div class="pswp__bg"></div>

    
    <div class="pswp__scroll-wrap">

        
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                
                
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js"integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo="crossorigin="anonymous"
                defer="true"
                >
            </script><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js"integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU="crossorigin="anonymous"
                defer="true"
                >
            </script><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.css"integrity="sha256-c0uckgykQ9v5k&#43;IqViZOZKc47Jn7KQil4/MP3ySA3F8="crossorigin="anonymous"
            ><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.css"integrity="sha256-SBLU4vv6CA6lHsZ1XyTdhyjJxCjPif/TRkjnsyGAGnE="crossorigin="anonymous"
            >

            </main>
    
        <aside class="sidebar right-sidebar sticky">
            <section class="widget archives">
                <div class="widget-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <line x1="5" y1="9" x2="19" y2="9" />
  <line x1="5" y1="15" x2="19" y2="15" />
  <line x1="11" y1="4" x2="7" y2="20" />
  <line x1="17" y1="4" x2="13" y2="20" />
</svg>



                </div>
                <h2 class="widget-title section-title">Table of contents</h2>
                
                <div class="widget--toc">
                    <nav id="TableOfContents">
  <ul>
    <li><a href="#系统链码">系统链码</a>
      <ul>
        <li><a href="#与普通链码对比">与普通链码对比</a></li>
      </ul>
    </li>
    <li><a href="#系统链码在peer节点上的注册与部署">系统链码在Peer节点上的注册与部署</a></li>
    <li><a href="#查询系统链码-querier-system-chaincode-qscc">查询系统链码 (<em>Querier System Chaincode</em>, QSCC)</a>
      <ul>
        <li><a href="#源代码">源代码</a></li>
      </ul>
    </li>
    <li><a href="#配置系统链码-configuration-system-chaincode-cscc">配置系统链码 (<em>Configuration System Chaincode</em>, CSCC)</a>
      <ul>
        <li><a href="#joinchain方法">JoinChain方法</a></li>
        <li><a href="#getconfigblock方法">GetConfigBlock方法</a></li>
        <li><a href="#getchannel方法">GetChannel方法</a></li>
      </ul>
    </li>
    <li><a href="#生命周期系统链码-life-cycle-system-chaincode-lscc">生命周期系统链码 (<em>Life Cycle System Chaincode</em>, LSCC)</a>
      <ul>
        <li><a href="#链码的生命周期">链码的生命周期</a></li>
        <li><a href="#源代码-1">源代码</a></li>
      </ul>
    </li>
    <li><a href="#背书系统链码-endorser-system-chaincode-escc">背书系统链码 (<em>Endorser System Chaincode</em>, ESCC)</a></li>
    <li><a href="#验证系统链码-validator-system-chaincode-vscc">验证系统链码 (<em>Validator System Chaincode</em>, VSCC)</a></li>
  </ul>
</nav>
                </div>
            </section>
        </aside>
    

        </div>
        <script 
                src="https://cdn.jsdelivr.net/npm/node-vibrant@3.1.5/dist/vibrant.min.js"integrity="sha256-5NovOZc4iwiAWTYIFiIM7DxKUXKWvpVEuMEPLzcm5/g="crossorigin="anonymous"
                defer="false"
                >
            </script><script type="text/javascript" src="/ts/main.js" defer></script>
<script>
    (function () {
        const customFont = document.createElement('link');
        customFont.href = "https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap";

        customFont.type = "text/css";
        customFont.rel = "stylesheet";

        document.head.appendChild(customFont);
    }());
</script>

    </body>
</html>
